<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê´€ë¦¬ì ëª¨ë“œ (ì ‘ì†ì œí•œ í•´ì œ)</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-search-input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px; width: 120px; outline: none; color: #333; }
        .admin-select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; color: #333; background: white; cursor: pointer; }
        .search-box-wrapper { gap: 5px; flex-wrap: wrap; }
        .bulk-textarea { width: 100%; height: 200px; font-size: 12px; font-family: monospace; padding: 10px; border: 1px solid #ccc; background: #f4f4f4; margin-bottom: 10px; }
        .bulk-status { font-size: 12px; color: #e74c3c; margin-top: 5px; font-weight: bold; max-height: 100px; overflow-y: auto; }
        .shop-select-item { display: flex; justify-content: space-between; align-items: center; }
        .shop-select-info { flex: 1; cursor: pointer; }
        .dup-msg { font-size: 12px; margin-left: 10px; font-weight: bold; }
        .check-item { display: inline-flex; align-items: center; margin-right: 10px; margin-bottom: 5px; cursor: pointer; font-size: 13px; }
        .check-item input { margin-right: 5px; cursor: pointer; }
        .hot-check-wrapper { background: #ffe3e3; border: 2px solid #ff6b6b; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .hot-check-label { font-weight: bold; color: #c0392b; font-size: 14px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .hot-check-input { width: 20px; height: 20px; cursor: pointer; accent-color: #e74c3c; }
        .admin-theme-panel { position: relative; width: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); padding: 10px; margin-top: 10px; display: flex; flex-direction: column; gap: 8px; border: 2px solid #2c3e50; z-index: 100; }
        .theme-control-row { display: flex; gap: 5px; align-items: center; }
        .theme-mode-badge { background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; animation: blink 2s infinite; display: none; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast-msg.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="search-container">
        <div class="search-box-wrapper" style="background:#c0392b; color:white; flex-direction:row; align-items:center; padding: 10px;">
            <div style="display:flex; align-items:center; gap:5px; flex-wrap:wrap; flex:1;">
                <strong style="white-space:nowrap;">ğŸ”’ ê´€ë¦¬</strong>
                <select id="adminRegion" class="admin-select" onchange="applyAdminFilters()"><option value="">ğŸ“ ì§€ì—­ ì „ì²´</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option></select>
                <select id="adminCategory" class="admin-select" onchange="applyAdminFilters()"><option value="">ğŸœ ì—…ì¢… ì „ì²´</option><option value="í•œì‹">í•œì‹</option><option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ë¶„ì‹">ë¶„ì‹</option><option value="ê³ ê¸°/êµ¬ì´">ê³ ê¸°/êµ¬ì´</option><option value="íšŒ/í•´ì‚°ë¬¼">íšŒ/í•´ì‚°ë¬¼</option><option value="ì•„ì‹œì•ˆ">ì•„ì‹œì•ˆ</option><option value="ìˆ ì§‘">ìˆ ì§‘</option><option value="ì¹´í˜/ë””ì €íŠ¸">ì¹´í˜/ë””ì €íŠ¸</option><option value="ë¹µì§‘">ë¹µì§‘</option><option value="íŒ¨ìŠ¤íŠ¸í‘¸ë“œ">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option><option value="í¬ì¥/ë°°ë‹¬">í¬ì¥/ë°°ë‹¬</option><option value="ì£¼ì°¨ì¥">ğŸš— ì£¼ì°¨ì¥</option></select>
                <input type="text" id="adminSearch" class="admin-search-input" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰" onkeyup="applyAdminFilters()">
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="openBulkModal()" style="background:#f1c40f; color:#333; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px; white-space:nowrap;">âš¡ ì¼ê´„</button>
                <button onclick="openAddModal()" style="background:#2c3e50; color:white; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px; white-space:nowrap;">â• ì¶”ê°€</button>
                <button onclick="location.href='index.html'" style="background:white; color:#c0392b; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px; white-space:nowrap;">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
        <div class="admin-theme-panel">
            <div class="theme-control-row">
                <span style="font-weight:bold; font-size:13px; color:#333;">ğŸ¨ í…Œë§ˆ:</span>
                <select id="adminThemeSelect" class="form-select" style="flex:1;" onchange="toggleThemeMode()"><option value="">(ê¸°ë³¸) ì—…ì²´ ì •ë³´ ìˆ˜ì • ëª¨ë“œ</option></select>
                <button onclick="addNewTheme()" style="background:#2ecc71; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">+ì¶”ê°€</button>
                <button onclick="deleteTheme()" style="background:#e74c3c; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">-ì‚­ì œ</button>
                <button onclick="renameTheme()" style="background:#3498db; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-left:5px;">âœï¸ì´ë¦„ ë³€ê²½</button>
            </div>
            <div id="themeModeStatus" class="theme-mode-badge">âš¡ <b>í…Œë§ˆ íƒœê¹… ëª¨ë“œ ON</b><br>ì§€ë„ì˜ í•€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í…Œë§ˆì— ì¦‰ì‹œ ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤.</div>
        </div>
    </div>
    
    <div id="toast" class="toast-msg">ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>
    <div class="admin-notice" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(192, 57, 43, 0.9); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; z-index: 200; pointer-events: none; text-align: center; width: 80%;">ì§€ë„ í´ë¦­ ë˜ëŠ” ìƒë‹¨ ë²„íŠ¼ ì‚¬ìš©</div>
    <div id="map"></div>

    <div id="selectModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeSelectModal()">Ã—</button>
            <h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ìˆ˜ì •í•  ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="selectList" class="shop-select-list"></div>
        </div>
    </div>

    <div id="shopModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeModal()">Ã—</button>
            <h3 class="modal-title">ì—…ì²´ ì •ë³´ ê´€ë¦¬</h3>
            <input type="hidden" id="shopId"><input type="hidden" id="shopLat"><input type="hidden" id="shopLng">
            <div class="form-group"><label class="form-label">ì—…ì²´ëª… <span id="dupMsg" class="dup-msg"></span></label><input type="text" id="shopName" class="form-input" placeholder="ìƒí˜¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off"></div>
            <div class="form-group" style="background:#f8f9fa; padding:10px; border:1px solid #ddd; border-radius:5px;">
                <label class="form-label">ğŸ‘‘ ì‚¬ì¥ë‹˜ UID ì—°ê²° (ì„ íƒ)</label>
                <input type="text" id="shopOwnerId" class="form-input" placeholder="ìœ ì €ì—ê²Œ ë°›ì€ UID ë¶™ì—¬ë„£ê¸°" style="font-family:monospace; font-size:12px;">
            </div>
            <div class="hot-check-wrapper"><label class="hot-check-label"><input type="checkbox" id="shopIsHot" class="hot-check-input"> ğŸ”¥ ì§€ë„ì—ì„œ ê°•ì¡°í•˜ê¸° (í…Œë‘ë¦¬ + ë¶ˆê½ƒ)</label></div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">ğŸ“ ì§€ì—­ (í•„ìˆ˜)</label><select id="shopRegion" class="form-input"><option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option></select></div>
                <div class="form-group"><label class="form-label">ìƒê¶Œ</label><input type="text" id="shopArea" class="form-input" autocomplete="off"></div>
            </div>
            <div class="form-group"><label class="form-label">ëŒ€í‘œë©”ë‰´</label><input type="text" id="shopMenu" class="form-input" autocomplete="off"></div>
            <div class="form-group"><label class="form-label">ğŸš— ì£¼ì°¨ ì •ë³´</label><select id="shopParking" class="form-input"><option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="âŒ ì£¼ì°¨ ë¶ˆê°€">âŒ ì£¼ì°¨ ë¶ˆê°€</option><option value="âš ï¸ ì£¼ì°¨ í˜‘ì†Œ">âš ï¸ ì£¼ì°¨ í˜‘ì†Œ (1~2ëŒ€)</option><option value="ğŸ…¿ï¸ ì£¼ì°¨ì¥ ì™„ë¹„">ğŸ…¿ï¸ ì£¼ì°¨ì¥ ì™„ë¹„</option><option value="ğŸ…¿ï¸ ë¬´ë£Œ ê°œë°©">ğŸ…¿ï¸ ë¬´ë£Œ ê°œë°©</option></select></div>
            <div class="form-group"><label class="form-label">â­ ë³„ì </label><input type="number" id="shopTotalScore" class="form-input" step="0.25" max="5.0"></div>
            <div class="form-group"><label class="form-label">ğŸ—¨ï¸ í•œì¤„í‰</label><textarea id="shopDesc" class="form-textarea" rows="2"></textarea></div>
            <div class="form-group"><label class="form-label">ì£¼ì†Œ</label><input type="text" id="shopAddress" class="form-input"></div>
            <div class="form-group"><label class="form-label">ì´ë¯¸ì§€ URL</label><input type="text" id="shopImage" class="form-input"></div>
            <div class="form-group"><label class="form-label">ë„¤ì´ë²„ ë§í¬</label><input type="text" id="shopLink" class="form-input"></div>
            <div class="form-group"><label class="form-label">ì—…ì¢…</label><div class="multi-select-container" id="categoryContainer"></div></div>
            <div class="form-group"><label class="form-label">ëª©ì </label><div class="multi-select-container" id="purposeContainer"></div></div>
            <div class="modal-btns"><button class="btn-delete" id="btnDelete" onclick="deleteCurrentShop()">ì‚­ì œ</button><button class="btn-save" onclick="saveShop()">ì €ì¥</button></div>
        </div>
    </div>

    <div id="bulkModal" class="modal-overlay">
        <div class="modal-box" style="max-width:600px;">
            <button class="modal-close-x" onclick="closeBulkModal()">Ã—</button>
            <h3 class="modal-title">âš¡ ë§ŒëŠ¥ ì´ë²¤íŠ¸ ì¼ê´„ ë“±ë¡</h3>
            
            <div style="background:#ffe3e3; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ff6b6b;">
                <p style="font-size:12px; color:#c0392b; font-weight:bold; margin:0 0 5px 0;">ğŸš¨ ë°ì´í„° ì´ˆê¸°í™” (ì˜ëª» ë“±ë¡í–ˆì„ ë•Œë§Œ!)</p>
                <button onclick="deleteAllEventData()" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ—‘ï¸ ì´ ì¹´í…Œê³ ë¦¬ ë°ì´í„° ëª¨ë‘ ì‚­ì œ</button>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
                <div style="margin-bottom:10px;">
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">ğŸ·ï¸ í…Œë§ˆ ì´ë¦„ (ì§€ë„ ë©”ë‰´ì— ëœ° ì´ë¦„)</label>
                    <input type="text" id="bulkThemeName" class="form-input" value="01. ğŸš— 2026 ì„¤ ë¬´ë£Œì£¼ì°¨ì¥" style="font-weight:bold; color:#e74c3c;">
                </div>
                <div class="form-grid">
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">ğŸ“‚ ì¹´í…Œê³ ë¦¬ (ë¶„ë¥˜)</label>
                        <input type="text" id="bulkCategory" class="form-input" value="ì£¼ì°¨ì¥" placeholder="ì˜ˆ: ì¶•ì œ, íŒì—…ìŠ¤í† ì–´">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:4px;">âœ¨ ëª©ì /íƒœê·¸</label>
                        <input type="text" id="bulkPurpose" class="form-input" value="ì„¤ë‚ ë¬´ë£Œ" placeholder="ì˜ˆ: ë°ì´íŠ¸, í¬í† ì¡´">
                    </div>
                </div>
            </div>

            <textarea id="bulkDataInput" class="bulk-textarea" placeholder='[JSON ë°ì´í„° ë¶™ì—¬ë„£ê¸°]'></textarea>
            <div id="bulkStatus" class="bulk-status"></div>
            <div class="modal-btns">
                <button class="btn-save" style="background:#2c3e50; color:white;" onclick="processBulkData()">ğŸš€ ë“±ë¡ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, initMap, createMarker, auth, onAuthStateChanged } from "./common.js";
        import { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, getDocs, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ [ë³€ê²½ì ] ë‹¨ìˆœ ë¹„ë°€ë²ˆí˜¸ë§Œ í†µê³¼í•˜ë©´ ì ‘ì† í—ˆìš© (ë°ì´í„° ì½ê¸° ê°€ëŠ¥)
        var password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
        if (password !== "2364") { document.body.innerHTML = "â›” ì ‘ê·¼ ê±°ë¶€"; throw new Error("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); }

        // ğŸ”¥ [ì•Œë¦¼] ë¡œê·¸ì¸ ìƒíƒœë§Œ ì¡°ìš©íˆ ì²´í¬ (ì«“ì•„ë‚´ì§€ ì•ŠìŒ)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                showToast(`âœ… ${user.displayName}ë‹˜ ë¡œê·¸ì¸ë¨ (ìˆ˜ì • ê°€ëŠ¥)`);
            } else {
                showToast("âš ï¸ ë¡œê·¸ì¸ ì•ˆ ë¨ (ì¡°íšŒë§Œ ê°€ëŠ¥, ìˆ˜ì • ë¶ˆê°€)");
            }
        });

        var map = initMap();
        let markerList = [];
        let allShopsData = [];
        let currentThemeMode = ""; 
        let themeList = []; 
        const CAT_LIST = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ê³ ê¸°/êµ¬ì´', 'íšŒ/í•´ì‚°ë¬¼', 'ì•„ì‹œì•ˆ', 'ìˆ ì§‘', 'ì¹´í˜/ë””ì €íŠ¸', 'ë¹µì§‘', 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', 'í¬ì¥/ë°°ë‹¬', 'ì£¼ì°¨ì¥'];
        const PUR_LIST = ['ë…¸í¬', 'ë°ì´íŠ¸', 'ë‹¨ì²´íšŒì‹', 'í˜¼ë°¥/í˜¼ìˆ ', 'ë¬´í•œë¦¬í•„', 'ì´ìƒ‰ë§›ì§‘', 'ë·°ë§›ì§‘', 'ìƒê²¬ë¡€', 'ì•¼ê°„ì˜ì—…', 'ì„¤ë‚ ë¬´ë£Œ'];

        window.openBulkModal = function() { $('#bulkDataInput').val(''); $('#bulkStatus').html(''); $('#bulkModal').addClass('show'); }
        window.closeModal = function() { $('#shopModal').removeClass('show'); }
        window.closeBulkModal = function() { $('#bulkModal').removeClass('show'); }
        window.closeSelectModal = function() { $('#selectModal').removeClass('show'); }

        function renderCheckboxes(containerId, name, items, selected = []) { const container = document.getElementById(containerId); container.innerHTML = ''; const selectedList = Array.isArray(selected) ? selected : (selected ? [selected] : []); items.forEach(item => { const isChecked = selectedList.includes(item); const label = document.createElement('label'); label.className = 'check-item'; label.innerHTML = `<input type="checkbox" name="${name}" value="${item}" ${isChecked ? 'checked' : ''}> ${item}`; container.appendChild(label); }); }
        async function loadThemes() { const docRef = doc(db, "meta", "themes"); const docSnap = await getDoc(docRef); const select = document.getElementById('adminThemeSelect'); select.innerHTML = '<option value="">(ê¸°ë³¸) ì—…ì²´ ì •ë³´ ìˆ˜ì • ëª¨ë“œ</option>'; if (docSnap.exists()) { themeList = docSnap.data().list || []; themeList.sort(); themeList.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.innerText = `ğŸ“‚ ${t}`; select.appendChild(opt); }); } }
        loadThemes();
        window.toggleThemeMode = function() { const val = document.getElementById('adminThemeSelect').value; currentThemeMode = val; const badge = document.getElementById('themeModeStatus'); if (val) { badge.style.display = 'block'; badge.innerHTML = `âš¡ <b>[${val}]</b> íƒœê¹… ëª¨ë“œ ON<br>í•€ì„ í´ë¦­í•˜ë©´ ì¦‰ì‹œ ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤.`; } else { badge.style.display = 'none'; } }
        window.addNewTheme = async function() { const name = prompt("ìƒˆë¡œìš´ í…Œë§ˆ ì´ë¦„:"); if(!name) return; if(themeList.includes(name)) return alert("ì¤‘ë³µ"); themeList.push(name); themeList.sort(); await setDoc(doc(db, "meta", "themes"), { list: themeList }, { merge: true }); alert("ì¶”ê°€ë¨"); loadThemes(); }
        window.renameTheme = async function() { const oldName = $('#adminThemeSelect').val(); if(!oldName) return alert("ì„ íƒí•„ìš”"); const newName = prompt("ìƒˆ ì´ë¦„:", oldName); if(!newName || newName===oldName) return; themeList = themeList.map(t => t === oldName ? newName : t); themeList.sort(); await setDoc(doc(db, "meta", "themes"), { list: themeList }); alert("ë³€ê²½ë¨"); loadThemes(); }
        window.deleteTheme = async function() { const target = $('#adminThemeSelect').val(); if(!target) return alert("ì„ íƒí•„ìš”"); if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return; await updateDoc(doc(db, "meta", "themes"), { list: arrayRemove(target) }); alert("ì‚­ì œë¨"); loadThemes(); $('#adminThemeSelect').val(""); toggleThemeMode(); }
        function handleMarkerClick(clickedList) { if (currentThemeMode) { if(clickedList.length > 1) showSelectModal(clickedList, true); else toggleShopTheme(clickedList[0]); } else { if (clickedList.length === 1) openEditModal(clickedList[0]); else showSelectModal(clickedList, false); } }
        window.showSelectModal = function(list, isThemeMode) { const container = document.getElementById('selectList'); container.innerHTML = ''; list.forEach(shop => { const div = document.createElement('div'); div.className = 'shop-select-item'; div.innerHTML = `<div class="shop-select-info"><span class="shop-select-name">${shop.name}</span></div>`; div.onclick = () => { closeSelectModal(); if(isThemeMode) toggleShopTheme(shop); else openEditModal(shop); }; container.appendChild(div); }); $('#selectModal').addClass('show'); }
        async function toggleShopTheme(shop) { const shopRef = doc(db, "shops", shop.id); const isAdded = shop.themes && shop.themes.includes(currentThemeMode); try { if(isAdded) { await updateDoc(shopRef, { themes: arrayRemove(currentThemeMode) }); showToast(`â– ì œê±°ë¨`); } else { await updateDoc(shopRef, { themes: arrayUnion(currentThemeMode) }); showToast(`â• ì¶”ê°€ë¨`); } } catch(e){alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!\n" + e.message);} }
        
        function showToast(msg) { 
            const el = document.getElementById('toast'); 
            if (!el) return; 
            el.innerText = msg; 
            el.classList.add('show'); 
            setTimeout(() => el.classList.remove('show'), 2000); 
        }
        
        onSnapshot(collection(db, "shops"), (snapshot) => { 
            allShopsData = []; 
            snapshot.forEach(doc => allShopsData.push({ id: doc.id, ...doc.data() })); 
            
            if(allShopsData.length === 0) {
                showToast("âš ï¸ ë°ì´í„° 0ê±´ (ë¶ˆëŸ¬ì˜¬ ë‚´ìš© ì—†ìŒ)");
            } else {
                showToast(`ğŸ“‚ ì´ ${allShopsData.length}ê°œ ë¡œë“œ ì™„ë£Œ!`);
            }
            applyAdminFilters(); 
        });

        window.applyAdminFilters = function() { 
            var region = $('#adminRegion').val(); 
            var category = $('#adminCategory').val(); 
            var purpose = $('#adminPurpose').val(); 
            var keyword = $('#adminSearch').val().toLowerCase().replace(/\s+/g, ''); 
            
            var filtered = allShopsData.filter(shop => { 
                var matchRegion = (region === "") || (shop.region === region); 
                var shopCats = Array.isArray(shop.category) ? shop.category : [shop.category]; 
                var matchCategory = (category === "") || shopCats.includes(category); 
                var shopPurps = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose]; 
                var matchPurpose = (purpose === "") || shopPurps.includes(purpose); 
                var catString = shopCats.join(" ") || "";
                var searchableText = (shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + catString).toLowerCase().replace(/\s+/g, ''); 
                var matchKeyword = (keyword === "") || searchableText.includes(keyword); 
                return matchRegion && matchCategory && matchPurpose && matchKeyword; 
            }); 
            renderMarkers(filtered); 
        }
        function renderMarkers(shops) { markerList.forEach(m => m.setMap(null)); markerList = []; const groups = {}; shops.forEach(s => { if(!s.lat)return; const k=s.lat.toFixed(5)+","+s.lng.toFixed(5); if(!groups[k])groups[k]=[]; groups[k].push(s); }); for(const k in groups) { var marker = createMarker(map, groups[k], handleMarkerClick); if (marker) markerList.push(marker); } }
        window.openEditModal = function(d) { $('#shopId').val(d.id); $('#shopName').val(d.name); $('#shopOwnerId').val(d.ownerId || ""); $('#shopRegion').val(d.region || ""); $('#shopArea').val(d.area); $('#shopMenu').val(d.menu); $('#shopIsHot').prop('checked', d.isHot === true); $('#shopParking').val(d.parking || ""); $('#shopTotalScore').val(d.totalScore); $('#shopDesc').val(d.desc); $('#shopAddress').val(d.address); $('#shopImage').val(d.imageUrl); $('#shopLink').val(d.link); $('#shopLat').val(d.lat); $('#shopLng').val(d.lng); $('#dupMsg').text(''); renderCheckboxes('categoryContainer', 'category', CAT_LIST, d.category); renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, d.purpose); $('#btnDelete').show(); $('.modal-title').text('ğŸ“ ì •ë³´ ìˆ˜ì •'); $('#shopModal').addClass('show'); }
        window.openAddModal = function() { $('#shopId').val(''); $('input, textarea, select').val(''); $('#shopIsHot').prop('checked', false); renderCheckboxes('categoryContainer', 'category', CAT_LIST, []); renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, []); $('#btnDelete').hide(); $('.modal-title').text('âœ¨ ìƒˆ ì—…ì²´ ì¶”ê°€'); $('#shopModal').addClass('show'); }
        async function geocodeAddress(addr) { return new Promise(r=>{ naver.maps.Service.geocode({query:addr}, (s,res)=>{ if(s===naver.maps.Service.Status.OK && res.v2.addresses.length>0) r({lat:parseFloat(res.v2.addresses[0].y), lng:parseFloat(res.v2.addresses[0].x)}); else r(null); }); }); }
        window.saveShop = async function() { var id = $('#shopId').val(); var name = $('#shopName').val().trim(); if (!name) { alert("â›” ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); $('#shopName').focus(); return; } var region = $('#shopRegion').val(); if (!region) { alert("â›” ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); $('#shopRegion').focus(); return; } var lat = parseFloat($('#shopLat').val()); var lng = parseFloat($('#shopLng').val()); var address = $('#shopAddress').val().trim(); if (isNaN(lat) || isNaN(lng) || lat===0) { if (!address) { alert("ì£¼ì†Œ í•„ìˆ˜"); return; } const res = await geocodeAddress(address); if(res) { lat=res.lat; lng=res.lng; $('#shopLat').val(lat); $('#shopLng').val(lng); } else { alert("ì£¼ì†Œ ì°¾ê¸° ì‹¤íŒ¨"); return; } } let rawScore = parseFloat($('#shopTotalScore').val()) || 0; if (rawScore > 5) { alert("ìµœëŒ€ 5ì ì…ë‹ˆë‹¤."); return; } var data = { name: name, category: [], purpose: [], region: region, area: $('#shopArea').val(), menu: $('#shopMenu').val(), isHot: $('#shopIsHot').is(':checked'), parking: $('#shopParking').val(), totalScore: rawScore, desc: $('#shopDesc').val(), address: address, imageUrl: $('#shopImage').val(), link: $('#shopLink').val(), ownerId: $('#shopOwnerId').val().trim(), lat: lat, lng: lng, updatedAt: new Date(), themes: allShopsData.find(s => s.id === id)?.themes || [] }; document.querySelectorAll('input[name="category"]').forEach(node => { if(node.checked) data.category.push(node.value); }); document.querySelectorAll('input[name="purpose"]').forEach(node => { if(node.checked) data.purpose.push(node.value); }); try { if (id) { await updateDoc(doc(db, "shops", id), data); alert("âœ… ìˆ˜ì • ì™„ë£Œ!"); } else { data.createdAt = new Date(); await addDoc(collection(db, "shops"), data); alert("âœ… ë“±ë¡ ì™„ë£Œ!"); } closeModal(); } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨ (ë¡œê·¸ì¸ í•„ìš”): " + e.message); } }
        window.deleteCurrentShop = async function() { var id = $('#shopId').val(); if(!id) return; if(confirm("ì‚­ì œ?")) { try{ await deleteDoc(doc(db,"shops",id)); alert("ì‚­ì œë¨"); closeModal(); }catch(e){alert("ì‹¤íŒ¨ (ë¡œê·¸ì¸ í•„ìš”): " + e.message);} } }
        naver.maps.Event.addListener(map, 'click', function(e) { if(currentThemeMode) return; $('#shopId').val(''); $('input, textarea, select').val(''); $('#shopIsHot').prop('checked', false); renderCheckboxes('categoryContainer', 'category', CAT_LIST, []); renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, []); $('#shopLat').val(e.coord.lat()); $('#shopLng').val(e.coord.lng()); $('#dupMsg').text(''); $('#btnDelete').hide(); $('.modal-title').text('âœ¨ ìƒˆ ì—…ì²´ ë“±ë¡'); $('#shopModal').addClass('show'); });

        window.processBulkData = async function() {
            const rawInput = $('#bulkDataInput').val();
            if (!rawInput) return alert("ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const targetTheme = $('#bulkThemeName').val().trim();
            const targetCat = $('#bulkCategory').val().trim(); 
            const targetPurpose = $('#bulkPurpose').val().trim();

            if(!targetTheme || !targetCat) return alert("í…Œë§ˆ ì´ë¦„ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            let dataList;
            try { dataList = JSON.parse(rawInput); } catch (e) { return alert("JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë”°ì˜´í‘œë‚˜ ì‰¼í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”."); }

            const statusDiv = document.getElementById('bulkStatus');
            statusDiv.innerHTML = "ğŸš€ ë“±ë¡ ì‹œì‘...";
            
            const themeRef = doc(db, "meta", "themes");
            try { await updateDoc(themeRef, { list: arrayUnion(targetTheme) }); } catch(e) {}

            let successCount = 0;
            for (let i = 0; i < dataList.length; i++) {
                const item = dataList[i];
                statusDiv.innerHTML += `<br>â³ [${i+1}/${dataList.length}] ${item.name}`;
                statusDiv.scrollTop = statusDiv.scrollHeight;

                try {
                    let lat = 0, lng = 0;
                    if (item.address) { const coords = await geocodeAddress(item.address); if (coords) { lat = coords.lat; lng = coords.lng; } }

                    await addDoc(collection(db, "shops"), {
                        name: item.name, 
                        address: item.address, 
                        desc: item.desc || item.name, 
                        category: [targetCat], 
                        purpose: [targetPurpose],
                        region: item.region || "ëŒ€êµ¬", 
                        menu: item.menu || "ì´ë²¤íŠ¸ ì¥ì†Œ", 
                        parking: "ì •ë³´ ì—†ìŒ",
                        isHot: false, totalScore: 5.0, 
                        themes: [targetTheme], ownerId: "",
                        lat: lat, lng: lng, 
                        createdAt: new Date(), updatedAt: new Date()
                    });
                    successCount++;
                } catch (e) { console.error(e); }
                await new Promise(r => setTimeout(r, 100)); 
            }
            alert(`âœ¨ ${targetTheme} ë“±ë¡ ì™„ë£Œ!`);
            location.reload();
        }

        window.deleteAllEventData = async function() {
            const targetCat = $('#bulkCategory').val().trim();
            if(!targetCat) return alert("ì‚­ì œí•  ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            if(!confirm(`ì •ë§ ì¹´í…Œê³ ë¦¬ê°€ '${targetCat}'ì¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)`)) return;
            
            const q = query(collection(db, "shops"), where("category", "array-contains", targetCat));
            const snapshot = await getDocs(q);
            if(snapshot.empty) return alert("ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const batch = writeBatch(db);
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert(`ğŸ§¹ '${targetCat}' ë°ì´í„° ì‚­ì œ ì™„ë£Œ!`);
            location.reload();
        }
    </script>
</body>
</html>