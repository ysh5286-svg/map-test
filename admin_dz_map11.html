<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê´€ë¦¬ì ëª¨ë“œ (Final V2.1)</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .bulk-textarea { width: 100%; height: 200px; font-size: 12px; font-family: monospace; padding: 10px; border: 1px solid #ccc; background: #f4f4f4; margin-bottom: 10px; }
        .bulk-status { font-size: 12px; color: #e74c3c; margin-top: 5px; font-weight: bold; max-height: 100px; overflow-y: auto; }
        .shop-select-item { display: flex; justify-content: space-between; align-items: center; }
        .shop-select-info { flex: 1; cursor: pointer; }
        .btn-promote { background: #fff; border: 1px solid #f1c40f; color: #f39c12; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 8px; white-space: nowrap; }
        .btn-promote:hover { background: #f1c40f; color: white; }
        .admin-search-input { padding: 6px 10px; border: 1px solid #c0392b; border-radius: 5px; font-size: 13px; width: 150px; outline: none; color: #333; }
        .dup-msg { font-size: 12px; margin-left: 10px; font-weight: bold; }
        .dup-error { color: #e74c3c; }
        .dup-ok { color: #2ecc71; }
        .check-item { display: inline-flex; align-items: center; margin-right: 10px; margin-bottom: 5px; cursor: pointer; font-size: 13px; }
        .check-item input { margin-right: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="search-container">
        <div class="search-box-wrapper" style="background:#c0392b; color:white; flex-direction:row; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px;">
                <strong>ğŸ”’ ê´€ë¦¬ì</strong>
                <input type="text" id="adminSearch" class="admin-search-input" placeholder="ğŸ” ì—…ì²´ëª… ê²€ìƒ‰">
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="openBulkModal()" style="background:#f1c40f; color:#333; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px;">âš¡ ì¼ê´„</button>
                <button onclick="openAddModal()" style="background:#2c3e50; color:white; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px;">â• ê°œë³„</button>
                <button onclick="location.href='index.html'" style="background:white; color:#c0392b; border:none; padding:6px 10px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:12px;">ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <div class="admin-theme-panel">
            <div class="theme-control-row">
                <span style="font-weight:bold; font-size:13px; color:#333;">ğŸ¨ í…Œë§ˆ:</span>
                <select id="adminThemeSelect" class="form-select" style="flex:1;" onchange="toggleThemeMode()">
                    <option value="">(ê¸°ë³¸) ì—…ì²´ ì •ë³´ ìˆ˜ì • ëª¨ë“œ</option>
                </select>
                <button onclick="addNewTheme()" style="background:#2ecc71; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">+ì¶”ê°€</button>
                <button onclick="deleteTheme()" style="background:#e74c3c; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">-ì‚­ì œ</button>

                <button onclick="renameTheme()" style="background:#3498db; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-left:5px;">âœï¸ì´ë¦„/ìˆœì„œ ë³€ê²½</button>
            </div>
            
            <div id="themeModeStatus" class="theme-mode-badge">
                âš¡ <b>í…Œë§ˆ íƒœê¹… ëª¨ë“œ ON</b><br>ì§€ë„ì˜ í•€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í…Œë§ˆì— ì¦‰ì‹œ ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast-msg">ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>
    
    <div class="admin-notice" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(192, 57, 43, 0.9); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; z-index: 200; pointer-events: none; text-align: center; width: 80%;">
        ì§€ë„ í´ë¦­ ë˜ëŠ” ìƒë‹¨ ë²„íŠ¼ ì‚¬ìš©
    </div>
    <div id="map"></div>

    <div id="selectModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeSelectModal()">Ã—</button>
            <h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ìˆ˜ì •í•  ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</h3>
            <div id="selectList" class="shop-select-list"></div>
        </div>
    </div>

    <div id="shopModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeModal()">Ã—</button>
            <h3 class="modal-title">ì—…ì²´ ì •ë³´ ê´€ë¦¬</h3>
            <input type="hidden" id="shopId"><input type="hidden" id="shopLat"><input type="hidden" id="shopLng">
            
            <div class="form-group">
                <label class="form-label">ì—…ì²´ëª… <span id="dupMsg" class="dup-msg"></span></label>
                <input type="text" id="shopName" class="form-input" placeholder="ìƒí˜¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">ì—…ì¢…</label>
                    <div class="multi-select-container" id="categoryContainer"></div>
                </div>
                <div class="form-group"><label class="form-label">ì§€ì—­</label><select id="shopRegion" class="form-select"><option value="">ì„ íƒ</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="ì²­ë„">ì²­ë„</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option></select></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ëª©ì </label>
                <div class="multi-select-container" id="purposeContainer"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-group"><label class="form-label">ìƒê¶Œ</label><input type="text" id="shopArea" class="form-input" autocomplete="off"></div>
                <div class="form-group"><label class="form-label">ëŒ€í‘œë©”ë‰´</label><input type="text" id="shopMenu" class="form-input" autocomplete="off"></div>
            </div>
            
            <div style="background:#f8f9fa; padding:10px; margin-bottom:10px;">
                <label class="form-label">â­ í‰ì  (0.25ë‹¨ìœ„)</label>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" style="color:#c0392b;">ì´ì  (ìë™/ìˆ˜ë™)</label>
                        <input type="number" id="shopTotalScore" class="form-input" step="0.1" style="font-weight:bold;" placeholder="ìë™ê³„ì‚°" autocomplete="off">
                    </div>
                    <div class="form-group"><label class="form-label">ë§›</label><input type="number" id="scoreTaste" class="form-input calc-score" step="0.25" autocomplete="off"></div>
                    <div class="form-group"><label class="form-label">ê°€ì„±ë¹„</label><input type="number" id="scoreValue" class="form-input calc-score" step="0.25" autocomplete="off"></div>
                    <div class="form-group"><label class="form-label">ë¶„ìœ„ê¸°</label><input type="number" id="scoreMood" class="form-input calc-score" step="0.25" autocomplete="off"></div>
                    <div class="form-group"><label class="form-label">ì¹œì ˆë„</label><input type="number" id="scoreKind" class="form-input calc-score" step="0.25" autocomplete="off"></div>
                </div>
            </div>
            
            <div class="form-group"><label class="form-label">ì„¤ëª…</label><textarea id="shopDesc" class="form-textarea" autocomplete="off"></textarea></div>
            <div class="form-group"><label class="form-label">ì£¼ì†Œ</label><input type="text" id="shopAddress" class="form-input" autocomplete="off"></div>
            <div class="form-group"><label class="form-label">ì´ë¯¸ì§€ URL</label><input type="text" id="shopImage" class="form-input" autocomplete="off"></div>
            <div class="form-group"><label class="form-label">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§í¬</label><input type="text" id="shopLink" class="form-input" autocomplete="off"></div>
            <div class="modal-btns">
                <button class="btn-delete" id="btnDelete" onclick="deleteCurrentShop()">ì‚­ì œ</button>
                <button class="btn-save" onclick="saveShop()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="bulkModal" class="modal-overlay">
        <div class="modal-box" style="max-width:600px;">
            <button class="modal-close-x" onclick="closeBulkModal()">Ã—</button>
            <h3 class="modal-title">âš¡ ë°ì´í„° ì¼ê´„ ë“±ë¡</h3>
            <textarea id="bulkDataInput" class="bulk-textarea" placeholder='[JSON ë°ì´í„°]'></textarea>
            <div id="bulkStatus" class="bulk-status"></div>
            <div class="modal-btns"><button class="btn-save" style="background:#f1c40f; color:#333;" onclick="processBulkData()">ğŸš€ ì‹¤í–‰í•˜ê¸°</button></div>
        </div>
    </div>

    <script type="module">
        import { db, initMap, createMarker } from "./common.js";
        // ğŸ”¥ writeBatch ì¶”ê°€ë¨ (ì¼ê´„ ì‚­ì œ ì²˜ë¦¬ë¥¼ ìœ„í•´)
        import { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, getDocs, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        var password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
        if (password !== "2364") { document.body.innerHTML = "â›” ì ‘ê·¼ ê±°ë¶€"; throw new Error("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); }

        var map = initMap();
        let markerList = [];
        let allShopsData = [];
        
        let currentThemeMode = ""; 
        let themeList = []; 

        const CAT_LIST = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ê³ ê¸°/êµ¬ì´', 'íšŒ/í•´ì‚°ë¬¼', 'ì•„ì‹œì•ˆ', 'ìˆ ì§‘', 'ì¹´í˜/ë””ì €íŠ¸', 'ë¹µì§‘', 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', 'í¬ì¥/ë°°ë‹¬'];
        const PUR_LIST = ['ë…¸í¬', 'ë°ì´íŠ¸', 'ë‹¨ì²´íšŒì‹', 'í˜¼ë°¥/í˜¼ìˆ ', 'ë¬´í•œë¦¬í•„', 'ì´ìƒ‰ë§›ì§‘', 'ë·°ë§›ì§‘', 'ìƒê²¬ë¡€', 'ì•¼ê°„ì˜ì—…'];

        window.closeModal = function() { $('#shopModal').removeClass('show'); }
        window.closeBulkModal = function() { $('#bulkModal').removeClass('show'); }
        window.closeSelectModal = function() { $('#selectModal').removeClass('show'); }

        function renderCheckboxes(containerId, name, items, selected = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const selectedList = Array.isArray(selected) ? selected : (selected ? [selected] : []);
            items.forEach(item => {
                const isChecked = selectedList.includes(item);
                const label = document.createElement('label');
                label.className = 'check-item';
                label.innerHTML = `<input type="checkbox" name="${name}" value="${item}" ${isChecked ? 'checked' : ''}> ${item}`;
                container.appendChild(label);
            });
        }

        // ==========================================
        // ğŸ”¥ í…Œë§ˆ ê´€ë¦¬ ë¡œì§ (ì •ë ¬ ë° ì—°ë™ ì‚­ì œ ì¶”ê°€ë¨)
        // ==========================================
        
        // 1. í…Œë§ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ ì •ë ¬ ì¶”ê°€)
        async function loadThemes() {
            const docRef = doc(db, "meta", "themes");
            const docSnap = await getDoc(docRef);
            const select = document.getElementById('adminThemeSelect');
            
            select.innerHTML = '<option value="">(ê¸°ë³¸) ì—…ì²´ ì •ë³´ ìˆ˜ì • ëª¨ë“œ</option>';

            if (docSnap.exists()) {
                themeList = docSnap.data().list || [];
                
                // ğŸ”¥ ì´ë¦„ìˆœ ì •ë ¬ (1_..., 2_... ìˆœì„œëŒ€ë¡œ)
                themeList.sort(); 

                themeList.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.innerText = `ğŸ“‚ ${t}`;
                    select.appendChild(opt);
                });
            }
        }
        loadThemes();

        window.toggleThemeMode = function() {
            const val = document.getElementById('adminThemeSelect').value;
            currentThemeMode = val;
            const badge = document.getElementById('themeModeStatus');
            
            if (val) {
                badge.style.display = 'block';
                badge.innerHTML = `âš¡ <b>[${val}]</b> íƒœê¹… ëª¨ë“œ ON<br>í•€ì„ í´ë¦­í•˜ë©´ ì¦‰ì‹œ ì¶”ê°€/ì œê±°ë©ë‹ˆë‹¤.`;
            } else {
                badge.style.display = 'none';
            }
        }

        window.addNewTheme = async function() {
            const name = prompt("ìƒˆë¡œìš´ í…Œë§ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.\n(ì˜ˆ: '1_1í˜¸ì„ ë§›ì§‘', '2_ë°ì´íŠ¸' ì²˜ëŸ¼ ìˆ«ìë¥¼ ë¶™ì´ë©´ ìˆœì„œê°€ ì •í•´ì§‘ë‹ˆë‹¤)");
            if(!name) return;
            if(themeList.includes(name)) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í…Œë§ˆì…ë‹ˆë‹¤.");

            themeList.push(name);
            themeList.sort(); // ì¶”ê°€í•˜ìë§ˆì ì •ë ¬
            
            await setDoc(doc(db, "meta", "themes"), { list: themeList }, { merge: true });
            alert("í…Œë§ˆê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadThemes();
        }

        // ğŸ”¥ [NEW] í…Œë§ˆ ì´ë¦„ ë³€ê²½ & ìˆœì„œ ë³€ê²½ í•¨ìˆ˜
        window.renameTheme = async function() {
            const oldName = document.getElementById('adminThemeSelect').value;
            if (!oldName) return alert("ìˆ˜ì •í•  í…Œë§ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            // í˜„ì¬ ì´ë¦„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë„ì›Œì¤Œ
            const newName = prompt(
                `'${oldName}'ì˜ ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.\n\n(ğŸ’¡ íŒ: '1_ë§›ì§‘' ì²˜ëŸ¼ ì•ì˜ ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë©´ ìˆœì„œê°€ ë³€ê²½ë©ë‹ˆë‹¤)`, 
                oldName
            );

            // ì·¨ì†Œí–ˆê±°ë‚˜ ì´ë¦„ì´ ê°™ìœ¼ë©´ ì¤‘ë‹¨
            if (!newName || newName === oldName) return;
            if (themeList.includes(newName)) return alert("â›” ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í…Œë§ˆ ì´ë¦„ì…ë‹ˆë‹¤.");

            if (!confirm(`âš ï¸ ì •ë§ '${oldName}' â†’ '${newName}' ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ í…Œë§ˆê°€ ì ìš©ëœ ëª¨ë“  ë§›ì§‘ì˜ íƒœê·¸ë„ ìë™ìœ¼ë¡œ ìˆ˜ì •ë©ë‹ˆë‹¤.\n(ë°ì´í„°ê°€ ë§ìœ¼ë©´ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;

            try {
                showToast("â™»ï¸ í…Œë§ˆ ì´ë¦„ êµì²´ ì‘ì—… ì¤‘...");

                // 1. ë©”íƒ€ ë°ì´í„°(ëª©ë¡) ì—…ë°ì´íŠ¸
                // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì´ë¦„ë§Œ ì™ ë°”ê¿”ì¹˜ê¸° í•˜ê³  ì •ë ¬
                themeList = themeList.map(t => t === oldName ? newName : t);
                themeList.sort(); // ê°€ë‚˜ë‹¤(ìˆ«ì)ìˆœ ì¬ì •ë ¬
                
                await setDoc(doc(db, "meta", "themes"), { list: themeList });

                // 2. í•´ë‹¹ í…Œë§ˆë¥¼ ê°€ì§€ê³  ìˆëŠ” ëª¨ë“  ë§›ì§‘ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸ (Batch ì²˜ë¦¬)
                // (ì˜›ë‚  ì´ë¦„ ì§€ìš°ê³  -> ìƒˆ ì´ë¦„ ë„£ê¸°)
                const q = query(collection(db, "shops"), where("themes", "array-contains", oldName));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const promises = querySnapshot.docs.map(async (docSnapshot) => {
                        const shopRef = doc(db, "shops", docSnapshot.id);
                        // ì•ˆì „í•˜ê²Œ ìˆœì°¨ ì²˜ë¦¬: ì‚­ì œ í›„ ì¶”ê°€
                        await updateDoc(shopRef, { themes: arrayRemove(oldName) });
                        await updateDoc(shopRef, { themes: arrayUnion(newName) });
                    });
                    
                    await Promise.all(promises);
                }

                alert(`âœ… ë³€ê²½ ì™„ë£Œ!\nì´ ${querySnapshot.size}ê°œì˜ ë§›ì§‘ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // UI ìƒˆë¡œê³ ì¹¨ ë° ì„ íƒê°’ ìœ ì§€
                await loadThemes();
                document.getElementById('adminThemeSelect').value = newName;
                toggleThemeMode(); // ë°”ë€ ì´ë¦„ìœ¼ë¡œ íƒœê¹… ëª¨ë“œ ìœ ì§€

            } catch (e) {
                console.error(e);
                alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        window.deleteTheme = async function() {
            const select = document.getElementById('adminThemeSelect');
            const targetTheme = select.value;

            // 1. ì„ íƒëœ í…Œë§ˆê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!targetTheme) return alert("âŒ ì‚­ì œí•  í…Œë§ˆë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");

            // 2. ì‚­ì œ í™•ì¸ (ì‹¤ìˆ˜ ë°©ì§€)
            if (!confirm(`âš ï¸ ì •ë§ '${targetTheme}' í…Œë§ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°,\ní•´ë‹¹ í…Œë§ˆê°€ ì ìš©ëœ ëª¨ë“  ë§›ì§‘ì—ì„œ íƒœê·¸ê°€ ì œê±°ë©ë‹ˆë‹¤.`)) return;

            try {
                showToast("ğŸ—‘ï¸ í…Œë§ˆ ì‚­ì œ ë° ì²­ì†Œ ì¤‘...");

                // 3. ë©”íƒ€ ë°ì´í„°(ëª©ë¡)ì—ì„œ ì‚­ì œ
                const themeRef = doc(db, "meta", "themes");
                await updateDoc(themeRef, {
                    list: arrayRemove(targetTheme)
                });

                // 4. í•´ë‹¹ í…Œë§ˆë¥¼ ë‹¬ê³  ìˆëŠ” ë§›ì§‘ë“¤ì—ì„œ íƒœê·¸ ì œê±° (ë°ì´í„° ì²­ì†Œ)
                const q = query(collection(db, "shops"), where("themes", "array-contains", targetTheme));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const promises = querySnapshot.docs.map(docSnapshot => {
                        const shopRef = doc(db, "shops", docSnapshot.id);
                        return updateDoc(shopRef, { 
                            themes: arrayRemove(targetTheme) 
                        });
                    });
                    await Promise.all(promises);
                }

                alert(`âœ… ì‚­ì œ ì™„ë£Œ!\nì´ ${querySnapshot.size}ê°œì˜ ë§›ì§‘ì—ì„œ '${targetTheme}' íƒœê·¸ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // 5. í™”ë©´ ì¦‰ì‹œ ë°˜ì˜ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
                themeList = themeList.filter(t => t !== targetTheme); // ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
                select.remove(select.selectedIndex); // ë“œë¡­ë‹¤ìš´ì—ì„œ ì œê±°
                
                // ì„ íƒ ì´ˆê¸°í™” ë° ëª¨ë“œ ë„ê¸°
                select.value = "";
                toggleThemeMode();

            } catch (e) {
                console.error(e);
                alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        function handleMarkerClick(clickedList) {
            if (currentThemeMode) {
                if(clickedList.length > 1) {
                    showSelectModal(clickedList, true); 
                } else {
                    toggleShopTheme(clickedList[0]);
                }
            } else {
                if (clickedList.length === 1) openEditModal(clickedList[0]);
                else showSelectModal(clickedList, false);
            }
        }

        async function toggleShopTheme(shop) {
            const shopRef = doc(db, "shops", shop.id);
            const currentThemes = shop.themes || [];
            const isAdded = currentThemes.includes(currentThemeMode);

            try {
                if (isAdded) {
                    await updateDoc(shopRef, { themes: arrayRemove(currentThemeMode) });
                    showToast(`â– '${shop.name}'ì—ì„œ [${currentThemeMode}] ì œê±°ë¨`);
                    shop.themes = currentThemes.filter(t => t !== currentThemeMode); 
                } else {
                    await updateDoc(shopRef, { themes: arrayUnion(currentThemeMode) });
                    showToast(`â• '${shop.name}'ì— [${currentThemeMode}] ì¶”ê°€ë¨`);
                    if(!shop.themes) shop.themes = [];
                    shop.themes.push(currentThemeMode);
                }
            } catch(e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1500);
        }

        // ... (ì´í•˜ ê¸°ì¡´ ë¡œì§ ë™ì¼) ...
        window.openAddModal = function() {
            $('#shopId').val(''); 
            $('input[type="text"], input[type="number"], textarea').val(''); 
            $('select').val(''); 
            renderCheckboxes('categoryContainer', 'category', CAT_LIST, []);
            renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, []);
            $('#shopLat').val(''); $('#shopLng').val(''); 
            $('#shopTotalScore').val(''); $('.calc-score').val(0);
            $('#dupMsg').text('');
            $('#btnDelete').hide(); 
            $('.modal-title').text('âœ¨ ê°œë³„ ì—…ì²´ ì¶”ê°€'); 
            $('#shopModal').addClass('show');
        }
        
        window.openBulkModal = function() { $('#bulkDataInput').val(''); $('#bulkStatus').text(''); $('#bulkModal').addClass('show'); }

        $('#shopName').on('input', function() {
            const name = $(this).val().trim();
            const msg = $('#dupMsg');
            const currentId = $('#shopId').val();
            if (!name) { msg.text(''); return; }
            const exists = allShopsData.some(shop => shop.name === name && shop.id !== currentId);
            if (exists) msg.text('â›” ì´ë¯¸ ë“±ë¡ëœ ì—…ì²´ì…ë‹ˆë‹¤!').removeClass('dup-ok').addClass('dup-error');
            else msg.text('âœ… ë“±ë¡ ê°€ëŠ¥í•œ ì—…ì²´ì…ë‹ˆë‹¤.').removeClass('dup-error').addClass('dup-ok');
        });

        onSnapshot(collection(db, "shops"), (snapshot) => {
            allShopsData = [];
            snapshot.forEach(doc => allShopsData.push({ id: doc.id, ...doc.data() }));
            allShopsData.sort((a, b) => {
                const dateA = a.updatedAt ? (a.updatedAt.seconds || 0) : 0;
                const dateB = b.updatedAt ? (b.updatedAt.seconds || 0) : 0;
                return dateB - dateA;
            });
            renderMarkers(allShopsData);
        });

        function renderMarkers(shops) {
            markerList.forEach(m => m.setMap(null));
            markerList = [];
            const groups = {};
            shops.forEach(s => {
                if(!s.lat) return;
                const key = s.lat.toFixed(5) + "," + s.lng.toFixed(5);
                if(!groups[key]) groups[key] = [];
                groups[key].push(s);
            });
            for(const key in groups) {
                groups[key].sort((a, b) => {
                    const dateA = a.updatedAt ? (a.updatedAt.seconds || 0) : 0;
                    const dateB = b.updatedAt ? (b.updatedAt.seconds || 0) : 0;
                    return dateB - dateA;
                });
                const marker = createMarker(map, groups[key], handleMarkerClick);
                if(marker) markerList.push(marker);
            }
        }

        // ê¸°ì¡´ì˜ $('#adminSearch').on('input'...) ë¶€ë¶„ì„ ì°¾ì•„ì„œ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”.

$('#adminSearch').on('keydown', function(e) {
    // ì—”í„°í‚¤(Enter)ë¥¼ ëˆŒë €ì„ ë•Œë§Œ ì‹¤í–‰
    if (e.key === 'Enter') {
        const keyword = $(this).val().toLowerCase().replace(/\s+/g, '');
        
        // 1. ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
        if (!keyword) {
            renderMarkers(allShopsData);
            return;
        }

        // 2. í•„í„°ë§ (ì´ë¦„ ê³µë°± ì œê±° í›„ ë¹„êµ)
        const filteredShops = allShopsData.filter(shop => {
            if (!shop.name) return false;
            const shopName = shop.name.toLowerCase().replace(/\s+/g, '');
            return shopName.includes(keyword);
        });

        // 3. ë§ˆì»¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        renderMarkers(filteredShops);

        // 4. ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ê°€ê²Œë¡œ ì§€ë„ ë¶€ë“œëŸ½ê²Œ ì´ë™
        if (filteredShops.length > 0) {
            const target = filteredShops[0];
            if (target.lat && target.lng) {
                const moveLatLng = new naver.maps.LatLng(target.lat, target.lng);
                
                // map.panToë³´ë‹¤ ë¶€ë“œëŸ¬ìš´ morph ì‚¬ìš© (ì¤Œ ë ˆë²¨ 17ë¡œ í™•ëŒ€)
                map.morph(moveLatLng, 17); 
            }
        } else {
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ (ì„ íƒì‚¬í•­: ì•Œë¦¼ ë“±)
            // alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."); 
        }

        // 5. ëª¨ë°”ì¼ í‚¤ë³´ë“œ ë‹«ê¸°
        $(this).blur();
    }
});

        function openEditModal(d) {
            $('#shopId').val(d.id); $('#shopName').val(d.name); $('#shopRegion').val(d.region); 
            $('#shopArea').val(d.area); $('#shopMenu').val(d.menu);
            $('#shopTotalScore').val(d.totalScore); $('#scoreTaste').val(d.scoreTaste);
            $('#scoreValue').val(d.scoreValue); $('#scoreMood').val(d.scoreMood); $('#scoreKind').val(d.scoreKind);
            $('#shopDesc').val(d.desc); $('#shopAddress').val(d.address);
            $('#shopImage').val(d.imageUrl); $('#shopLink').val(d.link);
            $('#shopLat').val(d.lat); $('#shopLng').val(d.lng);
            $('#dupMsg').text('');
            renderCheckboxes('categoryContainer', 'category', CAT_LIST, d.category);
            renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, d.purpose);
            $('#btnDelete').show(); $('.modal-title').text('ğŸ“ ì •ë³´ ìˆ˜ì •'); $('#shopModal').addClass('show');
        }

        async function geocodeAddress(address) {
            return new Promise((resolve) => {
                if (!address) return resolve(null);
                naver.maps.Service.geocode({ query: address }, function(status, response) {
                    if (status === naver.maps.Service.Status.OK) {
                        if (response.v2 && response.v2.addresses.length > 0) resolve({ lat: parseFloat(response.v2.addresses[0].y), lng: parseFloat(response.v2.addresses[0].x) });
                        else if (response.result && response.result.items.length > 0) resolve({ lat: parseFloat(response.result.items[0].point.y), lng: parseFloat(response.result.items[0].point.x) });
                        else resolve(null);
                    } else resolve(null);
                });
            });
        }

        window.saveShop = async function() {
            var id = $('#shopId').val();
            
            // 1. ì—…ì²´ëª… ì²´í¬
            var name = $('#shopName').val().trim();
            if (!name) { alert("â›” ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); $('#shopName').focus(); return; }

            // 2. ì¢Œí‘œ ë° ì£¼ì†Œ ì²´í¬ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
            var lat = parseFloat($('#shopLat').val());
            var lng = parseFloat($('#shopLng').val());
            var address = $('#shopAddress').val().trim();

            // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì£¼ì†Œë¡œ ì°¾ê¸° ì‹œë„
            if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                if (!address) {
                    alert("â›” ì§€ë„ì— ìœ„ì¹˜ë¥¼ ì°ê±°ë‚˜, ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }

                // ğŸ”¥ [ë³€ê²½] ì—¬ê¸°ì„œ ì‚¬ìš©ìì—ê²Œ ë‹¤ì‹œ ëˆ„ë¥´ë¼ê³  í•˜ì§€ ì•Šê³ , í”„ë¡œê·¸ë¨ì´ ê¸°ë‹¤ë¦½ë‹ˆë‹¤ (await)
                try {
                    const result = await geocodeAddress(address); // ì£¼ì†Œë¡œ ì¢Œí‘œ ì°¾ì„ ë•Œê¹Œì§€ ëŒ€ê¸°
                    if (result) {
                        lat = result.lat;
                        lng = result.lng;
                        // ì°¾ì€ ì¢Œí‘œë¥¼ hidden í•„ë“œì— ì±„ì›Œë„£ê¸° (ë‹¤ìŒ ìˆ˜ì •ì„ ìœ„í•´)
                        $('#shopLat').val(lat);
                        $('#shopLng').val(lng);
                        console.log("ğŸ“ ì¢Œí‘œ ìë™ ë³€í™˜ ì„±ê³µ:", lat, lng);
                    } else {
                        alert("â›” ì…ë ¥í•œ ì£¼ì†Œë¥¼ ì§€ë„ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì˜¤íƒ€ê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜ ì§€ë„ë¥¼ ì§ì ‘ í´ë¦­í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                } catch (err) {
                    alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    return;
                }
            }

            // 3. ì ìˆ˜ ê³„ì‚°
            const taste = parseFloat($('#scoreTaste').val()) || 0;
            const value = parseFloat($('#scoreValue').val()) || 0;
            const mood = parseFloat($('#scoreMood').val()) || 0;
            const kind = parseFloat($('#scoreKind').val()) || 0;
            
            let finalTotal = parseFloat($('#shopTotalScore').val());
            if (!finalTotal || finalTotal === 0) finalTotal = ((taste + value + mood + kind) / 4).toFixed(1);

            // 4. ë°ì´í„° ì €ì¥ ê°ì²´ ìƒì„±
            var data = {
                name: name, 
                category: [], 
                purpose: [],
                region: $('#shopRegion').val(), 
                area: $('#shopArea').val(), 
                menu: $('#shopMenu').val(),
                totalScore: Number(finalTotal),
                scoreTaste: taste, scoreValue: value, scoreMood: mood, scoreKind: kind,
                desc: $('#shopDesc').val(), 
                address: address, 
                imageUrl: $('#shopImage').val(), 
                link: $('#shopLink').val(),
                lat: lat, // ì°¾ì•„ë‚¸ ì¢Œí‘œ ì‚¬ìš©
                lng: lng, // ì°¾ì•„ë‚¸ ì¢Œí‘œ ì‚¬ìš©
                updatedAt: new Date(),
                themes: allShopsData.find(s => s.id === id)?.themes || [] 
            };

            // ì²´í¬ë°•ìŠ¤ ê°’ ìˆ˜ì§‘
            document.querySelectorAll('input[name="category"]').forEach(node => { if(node.checked) data.category.push(node.value); });
            document.querySelectorAll('input[name="purpose"]').forEach(node => { if(node.checked) data.purpose.push(node.value); });

            // 5. íŒŒì´ì–´ë² ì´ìŠ¤ ì „ì†¡
            try {
                if (id) {
                    await updateDoc(doc(db, "shops", id), data);
                    alert("âœ… ìˆ˜ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else { 
                    data.createdAt = new Date(); 
                    await addDoc(collection(db, "shops"), data); 
                    alert("âœ… ìƒˆ ì—…ì²´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                }
                closeModal(); // ëª¨ë‹¬ ë‹«ê¸°
            } catch (e) { 
                console.error(e);
                alert("ğŸ”¥ ì €ì¥ ì‹¤íŒ¨: " + e.message); 
            }
        }

        window.processBulkData = async function() {
            // ... (ê¸°ì¡´ ë¡œì§ ë™ì¼) ...
            const raw = $('#bulkDataInput').val();
            if(!raw) return alert("ë°ì´í„° ì—†ìŒ");
            try {
                const list = JSON.parse(raw);
                if(!confirm(list.length + "ê°œ ì²˜ë¦¬ ì‹œì‘?")) return;
                const status = $('#bulkStatus');
                for(let i=0; i<list.length; i++) {
                    const item = list[i];
                    status.text(`${i+1}/${list.length} : ${item.name}`);
                    const q = query(collection(db, "shops"), where("name", "==", item.name));
                    const snap = await getDocs(q);
                    if(item.address && (!item.lat || !item.lng)) {
                        const res = await geocodeAddress(item.address);
                        if(res) { item.lat = res.lat; item.lng = res.lng; }
                    }
                    item.updatedAt = new Date();
                    if(!snap.empty) await updateDoc(doc(db, "shops", snap.docs[0].id), item);
                    else { item.createdAt = new Date(); await addDoc(collection(db, "shops"), item); }
                    await new Promise(r=>setTimeout(r, 100));
                }
                alert("ì™„ë£Œ"); closeBulkModal();
            } catch(e) { alert("JSON ì—ëŸ¬: " + e.message); }
        }

        window.deleteCurrentShop = async function() {
            var id = $('#shopId').val();
            if (!id) return;
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try { await deleteDoc(doc(db, "shops", id)); alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); closeModal(); } 
                catch (err) { alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message); }
            }
        }

        naver.maps.Event.addListener(map, 'click', function(e) {
            if(currentThemeMode) return; 
            $('#shopId').val(''); $('input, textarea').val(''); $('select').val(''); 
            renderCheckboxes('categoryContainer', 'category', CAT_LIST, []);
            renderCheckboxes('purposeContainer', 'purpose', PUR_LIST, []);
            $('#shopLat').val(e.coord.lat()); $('#shopLng').val(e.coord.lng()); 
            $('#shopTotalScore').val(''); $('.calc-score').val(0);
            $('#dupMsg').text('');
            $('#btnDelete').hide(); $('.modal-title').text('âœ¨ ìœ„ì¹˜ ì„ íƒë¨'); $('#shopModal').addClass('show');
        });
    </script>
</body>
</html>