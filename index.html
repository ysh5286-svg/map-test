<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c0392b">
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
    @media (max-width: 768px) {
        #userStatusCard { top: 240px !important; left: 50% !important; transform: translateX(-50%) !important; width: 90% !important; justify-content: center !important; }
    }
    </style>
</head>
<body>
    <div id="loadingOverlay"><div class="spinner"></div><p>ğŸ’ ë³´ë¬¼ì§€ë„ë¥¼ í¼ì¹˜ëŠ” ì¤‘...</p></div>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="theme-select-wrapper">
                <select id="mainThemeSelect" class="theme-select" onchange="applyAllFilters()">
                    </select>
            </div>
            <div class="search-filters">
                <select id="filterRegion" class="search-select" onchange="applyAllFilters()"><option value="">ğŸ“ ì§€ì—­ ì „ì²´</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="ì²­ë„">ì²­ë„</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option></select>
                <select id="filterCategory" class="search-select" onchange="applyAllFilters()"><option value="">ğŸœ ì—…ì¢… ì „ì²´</option><option value="í•œì‹">í•œì‹</option><option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ë¶„ì‹">ë¶„ì‹</option><option value="ê³ ê¸°/êµ¬ì´">ê³ ê¸°/êµ¬ì´</option><option value="íšŒ/í•´ì‚°ë¬¼">íšŒ/í•´ì‚°ë¬¼</option><option value="ì•„ì‹œì•ˆ">ì•„ì‹œì•ˆ</option><option value="ìˆ ì§‘">ìˆ ì§‘</option><option value="ì¹´í˜/ë””ì €íŠ¸">ì¹´í˜/ë””ì €íŠ¸</option><option value="ë¹µì§‘">ë¹µì§‘</option><option value="íŒ¨ìŠ¤íŠ¸í‘¸ë“œ">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option><option value="í¬ì¥/ë°°ë‹¬">í¬ì¥/ë°°ë‹¬</option></select>
                <select id="filterPurpose" class="search-select" onchange="applyAllFilters()"><option value="">âœ¨ ë¶„ìœ„ê¸° ì „ì²´</option><option value="ë…¸í¬">ë…¸í¬</option><option value="ë°ì´íŠ¸">ë°ì´íŠ¸</option><option value="ë‹¨ì²´íšŒì‹">ë‹¨ì²´íšŒì‹</option><option value="í˜¼ë°¥/í˜¼ìˆ ">í˜¼ë°¥/í˜¼ìˆ </option><option value="ë¬´í•œë¦¬í•„">ë¬´í•œë¦¬í•„</option><option value="ì´ìƒ‰ë§›ì§‘">ì´ìƒ‰ë§›ì§‘</option><option value="ë·°ë§›ì§‘">ë·°ë§›ì§‘</option><option value="ìƒê²¬ë¡€">ìƒê²¬ë¡€</option><option value="ì•¼ê°„ì˜ì—…">ì•¼ê°„ì˜ì—…</option></select>
            </div>
            <div class="search-input-row" style="display:flex; align-items:center;">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="keyword" class="search-input" placeholder="ì˜ˆ: ë™ì„±ë¡œ ë‘ë°”ì´" onchange="applyAllFilters()" style="flex:1;">
                <button id="btnShowLikes" onclick="toggleLikeFilter()" style="background:white; border:1px solid #e74c3c; color:#e74c3c; border-radius:20px; padding:6px 12px; font-size:12px; font-weight:bold; cursor:pointer; margin-left:8px; white-space:nowrap; flex-shrink:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);">ğŸ¤ ì°œë§Œ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div id="userStatusCard" style="position: absolute; top: 150px; right: 10px; z-index: 90; display:flex; justify-content: flex-end; width: auto;">
        <button id="btnLogin" onclick="googleLogin()" style="background:white; border:1px solid #ddd; padding:8px 12px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; display:flex; align-items:center; gap:5px; color:#444;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> êµ¬ê¸€ ë¡œê·¸ì¸
        </button>
        <div id="myProfile" style="display:none; background:white; border:1px solid #3498db; padding:6px 12px; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); align-items:center; gap:8px;">
            <span id="userLevelBadge" style="background:#3498db; color:white; font-size:11px; padding:2px 6px; border-radius:10px; font-weight:bold;">LV.1</span>
            <span id="userName" style="font-size:13px; font-weight:bold; color:#333;">í™ê¸¸ë™</span>
        </div>
    </div>

    <div id="faqPanel" class="faq-panel">
        <div class="faq-header"><h3>ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3><button class="faq-close" onclick="toggleFaq()">âœ•</button></div>
        <div class="faq-body">
            <div class="faq-item"><div class="faq-q">Q. 'ëŒ€êµ¬ë³´ë¬¼ì§€ë„'ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</div><div class="faq-a">ëŒ€êµ¬ ì°ë§›ì§‘ ì •ë³´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div></div>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="padding: 0 20px 10px 20px;">
                <button id="installBtn" class="panel-btn" style="display:none; background:#3498db; color:white; font-size:15px; box-shadow:0 4px 6px rgba(52, 152, 219, 0.3);">â¬‡ï¸ ì•± ì„¤ì¹˜í•˜ê¸°</button>
            </div>
        </div>
        <div class="faq-footer"><div class="company-box"><strong>ë‹¤ì¦í”¼í”Œ (ëŒ€í‘œ: ìœ¤ì„±í˜¸)</strong><br>ì‚¬ì—…ìë²ˆí˜¸: 535-25-01793</div></div>
    </div>

    <div id="infoPanel" class="info-panel"><div class="panel-header" id="panelHeader"><button class="panel-close" onclick="closePanel()">âœ•</button></div><div class="panel-body"><div><h2 class="panel-title" id="panelTitle"></h2><div class="panel-meta" id="panelMeta"></div></div><div class="rating-box"><div class="rating-top"><span class="total-star">â­</span><div class="total-score" id="panelTotal">0.0</div></div><div class="review-text" id="panelReview"></div></div><div class="info-row"><span class="info-label">ë©”ë‰´</span> <span class="info-text" id="panelMenu"></span></div><div class="info-row"><span class="info-label">ì£¼ì†Œ</span> <span class="info-text" id="panelAddr"></span></div><a href="#" id="panelLink" target="_blank" class="panel-btn">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°</a></div></div>
    <div id="selectModal" class="modal-overlay"><div class="modal-box"><button class="modal-close-x" onclick="closeSelectModal()">Ã—</button><h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3><div id="selectList" class="shop-select-list"></div></div></div>
    
    <div class="bottom-bar">
        <div class="bottom-left"><button class="bar-btn btn-usage" onclick="toggleFaq()">ğŸ“– ì‚¬ìš©ë²•</button><a href="https://www.dazzlepeople.com" target="_blank" class="footer-copyright" style="margin-left:10px;">Â© Dazzle People</a></div>
        <div class="bottom-center"><button class="btn-location-mode" onclick="moveToCurrentLocation()"><div class="loc-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span class="loc-text">ë‚´ ì£¼ë³€</span></button></div>
        <div class="bottom-right"></div>
    </div>

    <div id="map"></div>

    <script>
        function toggleFaq() { document.getElementById('faqPanel').classList.toggle('show'); }
        function closePanel() { document.getElementById('infoPanel').classList.remove('show'); }
        function closeSelectModal() { document.getElementById('selectModal').classList.remove('show'); }
    </script>

    <script type="module">
        import { db, initMap, createMarker, auth, googleProvider, signInWithPopup, signOut, onAuthStateChanged } from "./common.js";
        import { collection, getDocs, doc, getDoc, setDoc, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        var map = initMap();
        let allShops = [];
        let markerList = [];
        const CACHE_KEY = "dazzle_shops_data_v7_complete"; 

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js?v=3.0').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) { window.location.reload(); }
                    };
                };
            }).catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ì‹¤íŒ¨', err));
        }

        let deferredPrompt; 
        const installBtn = document.getElementById('installBtn'); 
        const ua = navigator.userAgent.toLowerCase(); 
        const isIos = /iphone|ipad|ipod/.test(ua); 
        const isInApp = ua.includes('kakao') || ua.includes('instagram') || ua.includes('naver');
        if (isIos) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸ“² ì•„ì´í° ì„¤ì¹˜ ë°©ë²•\n\n1. ì‚¬íŒŒë¦¬ í•˜ë‹¨ 'ê³µìœ ' í´ë¦­\n2. 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ")); } 
        else if (isInApp) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸš« 'ë”ë³´ê¸°' -> 'ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°'ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.")); } 
        else { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; }); installBtn.addEventListener('click', (e) => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((r) => { if (r.outcome === 'accepted') installBtn.style.display = 'none'; deferredPrompt = null; }); } }); }

        // ìˆœì„œ ê³ ì • ë¡œì§
        async function initApp() {
            await initTheme();
            await loadShopsData();
        }

        async function initTheme() {
            const select = document.getElementById('mainThemeSelect');
            select.innerHTML = ''; 
            let firstTheme = null;
            try {
                const docRef = doc(db, "meta", "themes");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    let list = docSnap.data().list || [];
                    list.sort(); 
                    list.forEach((t, index) => {
                        const opt = document.createElement('option'); opt.value = t; opt.innerText = `ğŸš© ${t}`; select.appendChild(opt);
                        if (index === 0) firstTheme = t;
                    });
                }
                const allOpt = document.createElement('option'); allOpt.value = "ALL"; allOpt.innerText = "ğŸ’ ì „ì²´ ë§›ì§‘ ë³´ê¸°"; select.appendChild(allOpt); 
                
                // ğŸ”¥ ì²« ë²ˆì§¸ í…Œë§ˆê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì„ íƒ (ê¸°ë³¸ê°’)
                if (firstTheme) select.value = firstTheme;
                else select.value = "ALL";

            } catch(e) { console.error("í…Œë§ˆ ë¡œë”© ì‹¤íŒ¨", e); }
        }

        async function loadShopsData() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_KEY + "_time");
            const now = new Date().getTime();
            let isCacheUsed = false;

            if (cachedData && cachedTime && (now - cachedTime < 30 * 60 * 1000)) {
                try {
                    const parsed = JSON.parse(cachedData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        allShops = parsed;
                        // ğŸ”¥ ë°ì´í„° ë¡œë”© ì¦‰ì‹œ ë Œë”ë§ ì‹œë„!
                        checkAndRender();
                        document.getElementById('loadingOverlay').classList.add('fade-out');
                        isCacheUsed = true;
                    }
                } catch (err) { }
            }

            if (!isCacheUsed && db) {
                try {
                    const snapshot = await getDocs(collection(db, "shops"));
                    allShops = [];
                    snapshot.forEach((doc) => allShops.push({ id: doc.id, ...doc.data() }));
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allShops));
                    localStorage.setItem(CACHE_KEY + "_time", now);
                    document.getElementById('loadingOverlay').classList.add('fade-out');
                    checkAndRender();
                } catch (e) { console.error(e); }
            }
        }

        // ğŸ”¥ [ì™„ë²½í•´ê²°] ì§€ë„ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì°ëŠ” ë¡œì§ (ê¸°ì¡´ ì½”ë“œì˜ ì¥ì  ë³µêµ¬)
        function checkAndRender() { 
            if (!map) return; 
            
            // ğŸ”¥ ë„¤ì´ë²„ ì§€ë„ì˜ 'bounds'ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì´ê²Œ F5 ë¬¸ì œ í•´ê²°ì˜ ì—´ì‡ !)
            const bounds = map.getBounds();
            if (!bounds || !(bounds instanceof naver.maps.LatLngBounds)) {
                // ì•„ì§ ì¤€ë¹„ ì•ˆ ëìœ¼ë©´ 0.1ì´ˆ ë’¤ì— ë‹¤ì‹œ ì‹œë„ (ì¬ê·€ í˜¸ì¶œ)
                setTimeout(checkAndRender, 100);
                return;
            }

            // ì¤€ë¹„ ì™„ë£Œë˜ë©´ ë Œë”ë§ ì‹œì‘
            updateVisibleMarkers(); 
        }

        function filterShops(shops) {
            var theme = $('#mainThemeSelect').val();
            // ì•ˆì „ì¥ì¹˜: í…Œë§ˆê°€ ì•„ì§ ì„¸íŒ… ì•ˆ ëìœ¼ë©´ ì ì‹œ ëŒ€ê¸°
            if (!theme) return []; 

            var region = $('#filterRegion').val();
            var category = $('#filterCategory').val();
            var purpose = $('#filterPurpose').val();
            var keywordInput = $('#keyword').val() || "";
            var keywords = keywordInput.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            const user = auth.currentUser;

            return shops.filter(shop => {
                if (isLikeFilterOn) { if (!user || !shop.likedBy || !shop.likedBy.includes(user.uid)) return false; }

                if (theme === 'ALL') {
                    let fullInfo = "";
                    if (shop.category) fullInfo += (Array.isArray(shop.category) ? shop.category.join(" ") : shop.category);
                    if (shop.purpose) fullInfo += (Array.isArray(shop.purpose) ? shop.purpose.join(" ") : shop.purpose);
                    if (shop.name) fullInfo += shop.name;
                    if (fullInfo.includes("ì£¼ì°¨ì¥")) return false;
                } else {
                    if (!shop.themes || !Array.isArray(shop.themes) || !shop.themes.includes(theme)) return false;
                }

                var matchRegion = (region === "") || (shop.region === region);
                var shopCategories = Array.isArray(shop.category) ? shop.category : [shop.category];
                var matchCategory = (category === "") || shopCategories.includes(category);
                var shopPurposes = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose];
                var matchPurpose = (purpose === "") || shopPurposes.includes(purpose);
                
                var catString = shopCategories.join(" ") || "";
                var searchableText = (shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + catString).toLowerCase();
                var matchKeyword = true;
                if (keywords.length > 0) { matchKeyword = keywords.every(term => searchableText.includes(term)); }
                
                return matchRegion && matchCategory && matchPurpose && matchKeyword;
            });
        }

        function updateVisibleMarkers() {
            if (!map) return;
            const bounds = map.getBounds();
            // ğŸ”¥ ì—¬ê¸°ë„ ì•ˆì „ì¥ì¹˜ ì¶”ê°€
            if (!bounds) { setTimeout(updateVisibleMarkers, 100); return; }

            const filtered = filterShops(allShops);
            // ğŸ”¥ ì§€ë„ í™”ë©´ ì•ˆì— ìˆëŠ” ê²ƒë§Œ í•„í„°ë§ (ê¸°ì¡´ ë¡œì§ ë³µêµ¬ -> í•€ì´ ìì—°ìŠ¤ëŸ½ê²Œ ëœ¨ê²Œ í•¨)
            const visibleShops = filtered.filter(shop => {
                if(!shop.lat || !shop.lng) return false;
                const pos = new naver.maps.LatLng(shop.lat, shop.lng);
                return bounds.hasLatLng(pos);
            });
            renderMarkers(visibleShops);
        }

        function renderMarkers(shops) {
            markerList.forEach(m => m.setMap(null)); markerList = [];
            const groups = {};
            shops.forEach(shop => {
                const key = parseFloat(shop.lat).toFixed(5) + "," + parseFloat(shop.lng).toFixed(5);
                if(!groups[key]) groups[key] = [];
                groups[key].push(shop);
            });
            for(const key in groups) {
                const marker = createMarker(map, groups[key], function(clickedList) {
                    if (clickedList.length === 1) showPanel(clickedList[0]);
                    else showSelectModal(clickedList);
                });
                if(marker) markerList.push(marker);
            }
        }

        window.showPanel = function(shop) {
            document.getElementById('panelTitle').innerText = shop.name;
            document.getElementById('panelTotal').innerText = shop.totalScore || "0.0";
            document.getElementById('panelMenu').innerText = shop.menu || "-";
            document.getElementById('panelAddr').innerText = shop.address || "-";
            document.getElementById('panelReview').innerText = shop.desc || "ë‚´ìš© ì—†ìŒ";
            const header = document.getElementById('panelHeader');
            if (shop.imageUrl) header.style.backgroundImage = `url('${shop.imageUrl}')`;
            else header.style.backgroundColor = '#ddd';
            document.getElementById('infoPanel').classList.add('show');
        }
        window.closePanel = function() { document.getElementById('infoPanel').classList.remove('show'); }
        window.closeSelectModal = function() { document.getElementById('selectModal').classList.remove('show'); }
        window.showSelectModal = function(list) {
            const container = document.getElementById('selectList'); container.innerHTML = '';
            list.forEach(shop => {
                const div = document.createElement('div'); div.className = 'shop-select-item';
                div.innerText = shop.name;
                div.onclick = () => { closeSelectModal(); showPanel(shop); };
                container.appendChild(div);
            });
            document.getElementById('selectModal').classList.add('show');
        }
        window.moveToCurrentLocation = function() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            const btnText = document.querySelector('.loc-text');
            if(btnText) btnText.innerText = "íƒìƒ‰ì¤‘..";
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setCenter(new naver.maps.LatLng(lat, lng)); map.setZoom(16);
                setTimeout(() => { updateVisibleMarkers(); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; }, 300);
            }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; });
        }
        
        let isLikeFilterOn = false;
        window.toggleLikeFilter = function() {
            isLikeFilterOn = !isLikeFilterOn;
            const btn = document.getElementById('btnShowLikes');
            btn.style.background = isLikeFilterOn ? "#e74c3c" : "white";
            btn.style.color = isLikeFilterOn ? "white" : "#e74c3c";
            updateVisibleMarkers();
        }
        
        // ì§€ë„ ì›€ì§ì´ë©´ ë§ˆì»¤ ë‹¤ì‹œ ê³„ì‚° (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬)
        let idleTimer;
        naver.maps.Event.addListener(map, 'idle', function() { 
            clearTimeout(idleTimer); 
            idleTimer = setTimeout(updateVisibleMarkers, 150); 
        });

        window.applyAllFilters = function() { updateVisibleMarkers(); };
        window.googleLogin = function() { signInWithPopup(auth, googleProvider).then((r)=>{alert("ë¡œê·¸ì¸ ì„±ê³µ"); location.reload();}); }
        window.googleLogout = function() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { signOut(auth).then(() => { location.reload(); }); } };
        
        onAuthStateChanged(auth, (user) => {
            if(user) { document.getElementById('btnLogin').style.display='none'; document.getElementById('myProfile').style.display='flex'; document.getElementById('userName').innerText = user.displayName; }
        });

        initApp(); 
    </script>
</body>
</html>