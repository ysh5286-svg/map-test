<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c0392b">
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
    @media (max-width: 768px) {
        #userStatusCard { top: 240px !important; left: 50% !important; transform: translateX(-50%) !important; width: 90% !important; justify-content: center !important; }
    }
    /* í”„ë¡œí•„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .profile-header { text-align: center; margin-bottom: 20px; }
    .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #3498db; margin-bottom: 10px; }
    .profile-name { font-size: 18px; font-weight: bold; color: #333; }
    .profile-level { color: #3498db; font-weight: bold; font-size: 14px; }
    .exp-bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; }
    .exp-bar-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.5s; }
    .history-list { max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 13px; }
    .history-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="loadingOverlay"><div class="spinner"></div><p>ğŸ’ ë³´ë¬¼ì§€ë„ë¥¼ í¼ì¹˜ëŠ” ì¤‘...</p></div>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="theme-select-wrapper">
                <select id="mainThemeSelect" class="theme-select" onchange="applyAllFilters()">
                    </select>
            </div>
            <div class="search-filters">
                <select id="filterRegion" class="search-select" onchange="applyAllFilters()"><option value="">ğŸ“ ì§€ì—­ ì „ì²´</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="ì²­ë„">ì²­ë„</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option></select>
                <select id="filterCategory" class="search-select" onchange="applyAllFilters()"><option value="">ğŸœ ì—…ì¢… ì „ì²´</option><option value="í•œì‹">í•œì‹</option><option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ë¶„ì‹">ë¶„ì‹</option><option value="ê³ ê¸°/êµ¬ì´">ê³ ê¸°/êµ¬ì´</option><option value="íšŒ/í•´ì‚°ë¬¼">íšŒ/í•´ì‚°ë¬¼</option><option value="ì•„ì‹œì•ˆ">ì•„ì‹œì•ˆ</option><option value="ìˆ ì§‘">ìˆ ì§‘</option><option value="ì¹´í˜/ë””ì €íŠ¸">ì¹´í˜/ë””ì €íŠ¸</option><option value="ë¹µì§‘">ë¹µì§‘</option><option value="íŒ¨ìŠ¤íŠ¸í‘¸ë“œ">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option><option value="í¬ì¥/ë°°ë‹¬">í¬ì¥/ë°°ë‹¬</option></select>
                <select id="filterPurpose" class="search-select" onchange="applyAllFilters()"><option value="">âœ¨ ë¶„ìœ„ê¸° ì „ì²´</option><option value="ë…¸í¬">ë…¸í¬</option><option value="ë°ì´íŠ¸">ë°ì´íŠ¸</option><option value="ë‹¨ì²´íšŒì‹">ë‹¨ì²´íšŒì‹</option><option value="í˜¼ë°¥/í˜¼ìˆ ">í˜¼ë°¥/í˜¼ìˆ </option><option value="ë¬´í•œë¦¬í•„">ë¬´í•œë¦¬í•„</option><option value="ì´ìƒ‰ë§›ì§‘">ì´ìƒ‰ë§›ì§‘</option><option value="ë·°ë§›ì§‘">ë·°ë§›ì§‘</option><option value="ìƒê²¬ë¡€">ìƒê²¬ë¡€</option><option value="ì•¼ê°„ì˜ì—…">ì•¼ê°„ì˜ì—…</option></select>
            </div>
            <div class="search-input-row" style="display:flex; align-items:center;">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="keyword" class="search-input" placeholder="ì˜ˆ: ë™ì„±ë¡œ ë‘ë°”ì´" onchange="applyAllFilters()" style="flex:1;">
                <button id="btnShowLikes" onclick="toggleLikeFilter()" style="background:white; border:1px solid #e74c3c; color:#e74c3c; border-radius:20px; padding:6px 12px; font-size:12px; font-weight:bold; cursor:pointer; margin-left:8px; white-space:nowrap; flex-shrink:0; box-shadow:0 1px 3px rgba(0,0,0,0.1);">ğŸ¤ ì°œë§Œ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div id="userStatusCard" style="position: absolute; top: 150px; right: 10px; z-index: 90; display:flex; justify-content: flex-end; width: auto;">
        <button id="btnLogin" onclick="googleLogin()" style="background:white; border:1px solid #ddd; padding:8px 12px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; display:flex; align-items:center; gap:5px; color:#444;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> êµ¬ê¸€ ë¡œê·¸ì¸
        </button>
        <div id="myProfile" onclick="openProfileModal()" style="display:none; background:white; border:1px solid #3498db; padding:6px 12px; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); align-items:center; gap:8px; cursor: pointer;">
            <span id="userLevelBadge" style="background:#3498db; color:white; font-size:11px; padding:2px 6px; border-radius:10px; font-weight:bold;">LV.1</span>
            <span id="userName" style="font-size:13px; font-weight:bold; color:#333;">í™ê¸¸ë™</span>
        </div>
    </div>

    <div id="faqPanel" class="faq-panel">
        <div class="faq-header"><h3>ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3><button class="faq-close" onclick="toggleFaq()">âœ•</button></div>
        <div class="faq-body">
            <div class="faq-item"><div class="faq-q">Q. 'ëŒ€êµ¬ë³´ë¬¼ì§€ë„'ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</div><div class="faq-a">ëŒ€êµ¬ ì°ë§›ì§‘ ì •ë³´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div></div>
            <div class="faq-item"><div class="faq-q">ğŸ† ë ˆë²¨ì€ ì–´ë–»ê²Œ ì˜¬ë¦¬ë‚˜ìš”?</div><div class="faq-a">ê°€ê²Œì— ë„ì°©í•´ì„œ <b>[ğŸ“ ì—¬ê¸° ì™”ì–´ìš”! (GPS ì¸ì¦)]</b> ë²„íŠ¼ë§Œ ëˆ„ë¥´ë©´ ë!<br>(ë°©ë¬¸ 1íšŒ = ê²½í—˜ì¹˜ 10ì  íšë“ ğŸ)</div></div>
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="https://open.kakao.com/o/gaV5kk8h" target="_blank" class="panel-btn" style="background:#fee500; color:#3c1e1e;">ğŸ’¬ ëŒ€êµ¬ê²½ë¶ ì°ë§›ì§‘ ì†Œí†µë°©</a>
                <button onclick="alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤!')" class="panel-btn" style="background:#2c3e50;">ğŸ® ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</button>
                <a href="https://litt.ly/dazzlepeople" target="_blank" class="panel-btn" style="background:#e1306c;">ğŸ“± SNS êµ¬ê²½ê°€ê¸°</a>
            </div>
            
            <div style="padding: 20px 0;">
                <button id="installBtn" class="panel-btn" style="display:none; background:#3498db; color:white; font-size:15px; box-shadow:0 4px 6px rgba(52, 152, 219, 0.3);">â¬‡ï¸ ì•± ì„¤ì¹˜í•˜ê¸°</button>
            </div>
        </div>
        <div class="faq-footer"><div class="company-box"><strong>ë‹¤ì¦í”¼í”Œ (ëŒ€í‘œ: ìœ¤ì„±í˜¸)</strong><br>ì‚¬ì—…ìë²ˆí˜¸: 535-25-01793<br>ì£¼ì†Œ: ëŒ€êµ¬ê´‘ì—­ì‹œ ë™êµ¬ ì†¡ë¼ë¡œ16ê¸¸ 42</div></div>
    </div>

    <div id="infoPanel" class="info-panel">
        <div class="panel-header" id="panelHeader"><button class="panel-close" onclick="closePanel()">âœ•</button></div>
        <div class="panel-body">
            <div><h2 class="panel-title" id="panelTitle"></h2><div class="panel-meta" id="panelMeta"></div></div>
            <div class="rating-box"><div class="rating-top"><span class="total-star">â­</span><div class="total-score" id="panelTotal">0.0</div></div><div class="review-text" id="panelReview"></div></div>
            <div class="info-row"><span class="info-label">ë©”ë‰´</span> <span class="info-text" id="panelMenu"></span></div>
            <div class="info-row"><span class="info-label">ì£¼ì†Œ</span> <span class="info-text" id="panelAddr"></span></div>
            <div id="dynamicBtnArea"></div>
            <a href="#" id="panelLink" target="_blank" class="panel-btn">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°</a>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="document.getElementById('profileModal').classList.remove('show')">Ã—</button>
            <div class="profile-header">
                <img id="pImg" class="profile-img" src="">
                <div id="pName" class="profile-name"></div>
                <div id="pLevel" class="profile-level"></div>
            </div>
            <div style="font-size:12px; color:#555; display:flex; justify-content:space-between;"><span>EXP</span><span id="pExpText">0 / 100</span></div>
            <div class="exp-bar-bg"><div id="pExpBar" class="exp-bar-fill"></div></div>
            <h4 style="margin:15px 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸš© ë°©ë¬¸ ì¸ì¦ ê¸°ë¡</h4>
            <div id="pHistory" class="history-list"></div>
            <button onclick="googleLogout()" style="width:100%; padding:10px; background:#f1f3f5; border:none; border-radius:8px; margin-top:15px; font-weight:bold; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="selectModal" class="modal-overlay"><div class="modal-box"><button class="modal-close-x" onclick="closeSelectModal()">Ã—</button><h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3><div id="selectList" class="shop-select-list"></div></div></div>
    
    <div class="bottom-bar">
        <div class="bottom-left"><button class="bar-btn btn-usage" onclick="toggleFaq()">ğŸ“– ì‚¬ìš©ë²•</button><a href="https://www.dazzlepeople.com" target="_blank" class="footer-copyright" style="margin-left:10px;">Â© Dazzle People</a></div>
        <div class="bottom-center"><button class="btn-location-mode" onclick="moveToCurrentLocation()"><div class="loc-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span class="loc-text">ë‚´ ì£¼ë³€</span></button></div>
        <div class="bottom-right"></div>
    </div>

    <div id="map"></div>

    <script>
        function toggleFaq() { document.getElementById('faqPanel').classList.toggle('show'); }
        function closePanel() { document.getElementById('infoPanel').classList.remove('show'); }
        function closeSelectModal() { document.getElementById('selectModal').classList.remove('show'); }
    </script>

    <script type="module">
        import { db, initMap, createMarker, auth, googleProvider, signInWithPopup, signOut, onAuthStateChanged } from "./common.js";
        import { collection, getDocs, doc, getDoc, setDoc, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        var map = initMap();
        let allShops = [];
        let markerList = [];
        const CACHE_KEY = "dazzle_shops_data_v12_restore_full"; // ìºì‹œ ë²„ì „ ì—…ë°ì´íŠ¸

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js?v=3.0').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) { window.location.reload(); }
                    };
                };
            }).catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ì‹¤íŒ¨', err));
        }

        let deferredPrompt; 
        const installBtn = document.getElementById('installBtn'); 
        const ua = navigator.userAgent.toLowerCase(); 
        const isIos = /iphone|ipad|ipod/.test(ua); 
        const isInApp = ua.includes('kakao') || ua.includes('instagram') || ua.includes('naver');
        if (isIos) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸ“² ì•„ì´í° ì„¤ì¹˜ ë°©ë²•\n\n1. ì‚¬íŒŒë¦¬ í•˜ë‹¨ 'ê³µìœ ' í´ë¦­\n2. 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ")); } 
        else if (isInApp) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸš« 'ë”ë³´ê¸°' -> 'ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°'ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.")); } 
        else { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; }); installBtn.addEventListener('click', (e) => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((r) => { if (r.outcome === 'accepted') installBtn.style.display = 'none'; deferredPrompt = null; }); } }); }

        async function initApp() {
            await initTheme();
            await loadShopsData();
        }

        async function initTheme() {
            const select = document.getElementById('mainThemeSelect');
            select.innerHTML = ''; 
            let firstTheme = null;
            try {
                const docRef = doc(db, "meta", "themes");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    let list = docSnap.data().list || [];
                    list.sort(); 
                    list.forEach((t, index) => {
                        const opt = document.createElement('option'); opt.value = t; opt.innerText = `ğŸš© ${t}`; select.appendChild(opt);
                        if (index === 0) firstTheme = t;
                    });
                }
                const allOpt = document.createElement('option'); allOpt.value = "ALL"; allOpt.innerText = "ğŸ’ ì „ì²´ ë§›ì§‘ ë³´ê¸°"; select.appendChild(allOpt); 
                
                if (firstTheme) select.value = firstTheme;
                else select.value = "ALL";

            } catch(e) { console.error("í…Œë§ˆ ë¡œë”© ì‹¤íŒ¨", e); }
        }

        async function loadShopsData() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_KEY + "_time");
            const now = new Date().getTime();
            let isCacheUsed = false;

            if (cachedData && cachedTime && (now - cachedTime < 30 * 60 * 1000)) {
                try {
                    const parsed = JSON.parse(cachedData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        allShops = parsed;
                        checkAndRender();
                        document.getElementById('loadingOverlay').classList.add('fade-out');
                        isCacheUsed = true;
                    }
                } catch (err) { }
            }

            if (!isCacheUsed && db) {
                try {
                    const snapshot = await getDocs(collection(db, "shops"));
                    allShops = [];
                    snapshot.forEach((doc) => allShops.push({ id: doc.id, ...doc.data() }));
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allShops));
                    localStorage.setItem(CACHE_KEY + "_time", now);
                    document.getElementById('loadingOverlay').classList.add('fade-out');
                    checkAndRender();
                } catch (e) { console.error(e); }
            }
        }

        function checkAndRender() { 
            if (!map) return; 
            const bounds = map.getBounds();
            if (!bounds || !(bounds instanceof naver.maps.LatLngBounds)) {
                setTimeout(checkAndRender, 100); return;
            }
            updateVisibleMarkers(); 
        }

        function filterShops(shops) {
            var theme = $('#mainThemeSelect').val();
            if (!theme) return []; 

            var region = $('#filterRegion').val();
            var category = $('#filterCategory').val();
            var purpose = $('#filterPurpose').val();
            var keywordInput = $('#keyword').val() || "";
            var keywords = keywordInput.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
            const user = auth.currentUser;

            return shops.filter(shop => {
                if (isLikeFilterOn) { if (!user || !shop.likedBy || !shop.likedBy.includes(user.uid)) return false; }

                if (theme === 'ALL') {
                    let fullInfo = "";
                    if (shop.category) fullInfo += (Array.isArray(shop.category) ? shop.category.join(" ") : shop.category);
                    if (shop.purpose) fullInfo += (Array.isArray(shop.purpose) ? shop.purpose.join(" ") : shop.purpose);
                    if (shop.name) fullInfo += shop.name;
                    if (fullInfo.includes("ì£¼ì°¨ì¥")) return false;
                } else {
                    if (!shop.themes || !Array.isArray(shop.themes) || !shop.themes.includes(theme)) return false;
                }

                var matchRegion = (region === "") || (shop.region === region);
                var shopCategories = Array.isArray(shop.category) ? shop.category : [shop.category];
                var matchCategory = (category === "") || shopCategories.includes(category);
                var shopPurposes = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose];
                var matchPurpose = (purpose === "") || shopPurposes.includes(purpose);
                
                var catString = shopCategories.join(" ") || "";
                var searchableText = (shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + catString).toLowerCase();
                var matchKeyword = true;
                if (keywords.length > 0) { matchKeyword = keywords.every(term => searchableText.includes(term)); }
                
                return matchRegion && matchCategory && matchPurpose && matchKeyword;
            });
        }

        function updateVisibleMarkers() {
            if (!map) return;
            const bounds = map.getBounds();
            if (!bounds) { setTimeout(updateVisibleMarkers, 100); return; }

            const filtered = filterShops(allShops);
            // bounds.hasLatLng ì²´í¬ ë³µêµ¬ (ì§€ë„ ë‚´ ë§ˆì»¤ë§Œ í‘œì‹œ)
            const visibleShops = filtered.filter(shop => {
                if(!shop.lat || !shop.lng) return false;
                const pos = new naver.maps.LatLng(shop.lat, shop.lng);
                return bounds.hasLatLng(pos);
            });
            renderMarkers(visibleShops);
        }

        function renderMarkers(shops) {
            markerList.forEach(m => m.setMap(null)); markerList = [];
            const groups = {};
            shops.forEach(shop => {
                const key = parseFloat(shop.lat).toFixed(5) + "," + parseFloat(shop.lng).toFixed(5);
                if(!groups[key]) groups[key] = [];
                groups[key].push(shop);
            });
            for(const key in groups) {
                // ìˆœìœ„ ì •ë ¬
                groups[key].sort((a, b) => {
                    const pA = a.priority || 0; const pB = b.priority || 0;
                    if (pA !== pB) return pB - pA;
                    const hotA = a.isHot ? 1 : 0; const hotB = b.isHot ? 1 : 0;
                    if (hotA !== hotB) return hotB - hotA;
                    return 0;
                });

                const marker = createMarker(map, groups[key], function(clickedList) {
                    if (clickedList.length === 1) showPanel(clickedList[0]);
                    else showSelectModal(clickedList);
                });
                if(marker) markerList.push(marker);
            }
        }

        // ğŸ”¥ [ì™„ë²½ ë³µêµ¬] ìƒì„¸ íŒ¨ë„ UI (í•˜íŠ¸, íƒœê·¸, ì£¼ì°¨, GPS, ìˆ˜ì •ë²„íŠ¼)
        window.showPanel = function(shop) {
            document.getElementById('panelTitle').innerText = shop.name;
            const score = shop.totalScore || "0.0";
            document.getElementById('panelTotal').innerHTML = `${score}<span class="total-max"> / 5.0</span>`;
            document.getElementById('panelMenu').innerText = shop.menu || "-";
            document.getElementById('panelAddr').innerText = shop.address || "-";
            const reviewHtml = shop.desc ? `ğŸ—¨ï¸ "${shop.desc}"` : `ğŸ—¨ï¸ "ì•„ì§ ë“±ë¡ëœ í•œì¤„í‰ì´ ì—†ì–´ìš”."`;
            document.getElementById('panelReview').innerHTML = reviewHtml;
            
            // íƒœê·¸ í‘œì‹œ
            const metaBox = document.getElementById('panelMeta');
            let metaHtml = '';
            if(shop.category) (Array.isArray(shop.category) ? shop.category : [shop.category]).forEach(c => metaHtml += `<span class="panel-tag">#${c}</span>`);
            if(shop.purpose) (Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose]).forEach(p => metaHtml += `<span class="panel-tag">#${p}</span>`);
            metaBox.innerHTML = metaHtml;

            const header = document.getElementById('panelHeader');
            if (shop.imageUrl) { header.style.backgroundImage = `url('${shop.imageUrl}')`; } 
            else { header.style.backgroundImage = 'none'; header.style.backgroundColor = '#ddd'; }
            
            let parkingBadge = '';
            if (shop.parking) { parkingBadge = `<div class="parking-badge">${shop.parking}</div>`; }
            
            // í•˜íŠ¸ ë²„íŠ¼
            const user = auth.currentUser;
            const likedList = shop.likedBy || [];
            const isLiked = user && likedList.includes(user.uid);
            const heartIcon = isLiked ? "â¤ï¸" : "ğŸ¤";
            const likeCount = likedList.length;

            const heartHtml = `
                <div class="like-btn-wrapper">
                    <button id="heartBtn" class="heart-btn ${isLiked?'active':''}" onclick="toggleLike('${shop.id}')">${heartIcon}</button>
                    <span id="likeCountSpan" class="like-count">${likeCount}</span>
                </div>
            `;

            header.innerHTML = `<button class="panel-close" onclick="closePanel()">âœ•</button>${parkingBadge}${heartHtml}`;

            // GPS ë²„íŠ¼ + ì‚¬ì¥ë‹˜ ìˆ˜ì • ë²„íŠ¼
            const dynamicBtnArea = document.getElementById('dynamicBtnArea');
            dynamicBtnArea.innerHTML = `<button class="panel-btn" style="background:#e74c3c; margin-bottom:5px;" onclick="verifyVisitByGPS(${shop.lat}, ${shop.lng}, '${shop.name}')">ğŸ“ <b>ì—¬ê¸° ì™”ì–´ìš”! (GPS ì¸ì¦)</b></button>`;
            
            // ğŸ”¥ [ì‚¬ì¥ë‹˜ ì²´í¬] ë‚´ UIDì™€ ê°€ê²Œ OwnerIdê°€ ê°™ìœ¼ë©´ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
            if (user && shop.ownerId && shop.ownerId === user.uid) {
                dynamicBtnArea.innerHTML += `<button class="panel-btn" style="background:#2c3e50; margin-bottom:5px;" onclick="location.href='admin_dz_map11.html'">ğŸ”§ ë‚´ ê°€ê²Œ ì •ë³´ ìˆ˜ì •í•˜ê¸°</button>`;
            }

            const btnLink = document.getElementById('panelLink');
            if (shop.link) { btnLink.href = shop.link; btnLink.style.display = 'block'; btnLink.innerText = 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°'; } 
            else { btnLink.href = '#'; btnLink.style.display = 'none'; }

            document.getElementById('faqPanel').classList.remove('show');
            document.getElementById('selectModal').classList.remove('show');
            document.getElementById('infoPanel').classList.add('show');
        }

        window.toggleLike = async function(shopId) {
            const user = auth.currentUser;
            if(!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ğŸ˜…");
            const heartBtn = document.getElementById('heartBtn');
            const countSpan = document.getElementById('likeCountSpan');
            const shopRef = doc(db, "shops", shopId);
            const isLiked = heartBtn.innerText === "â¤ï¸";
            
            if(isLiked) { heartBtn.innerText = "ğŸ¤"; heartBtn.classList.remove('active'); countSpan.innerText = parseInt(countSpan.innerText) - 1; } 
            else { heartBtn.innerText = "â¤ï¸"; heartBtn.classList.add('active'); countSpan.innerText = parseInt(countSpan.innerText) + 1; }

            try {
                if(isLiked) await updateDoc(shopRef, { likedBy: arrayRemove(user.uid) });
                else await updateDoc(shopRef, { likedBy: arrayUnion(user.uid) });
                const target = allShops.find(s => s.id === shopId);
                if(target) {
                    if(!target.likedBy) target.likedBy = [];
                    if(isLiked) target.likedBy = target.likedBy.filter(uid => uid !== user.uid);
                    else target.likedBy.push(user.uid);
                }
            } catch(e) { console.error(e); heartBtn.innerText = isLiked ? "â¤ï¸" : "ğŸ¤"; }
        }

        // GPS ì¸ì¦ ë¡œì§
        window.verifyVisitByGPS = function(shopLat, shopLng, shopName) {
            const user = auth.currentUser;
            if(!user) return alert("ë¡œê·¸ì¸ í›„ ì¸ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            const btn = event.target; const originalText = btn.innerHTML;
            const userRef = doc(db, "users", user.uid);
            getDoc(userRef).then(snap => {
                if(snap.exists()) {
                    const data = snap.data();
                    const last = data.lastCheckIn ? data.lastCheckIn.toMillis() : 0;
                    if ((new Date().getTime() - last) / (1000 * 60) < 60) return alert("1ì‹œê°„ì— 1ë²ˆë§Œ ì¸ì¦ ê°€ëŠ¥í•´ìš”!");
                    if(!navigator.geolocation) return alert("GPS ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    btn.innerText = "ğŸ“¡ ìœ„ì¹˜ í™•ì¸ ì¤‘..."; btn.disabled = true;
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        const dist = getDistanceFromLatLonInKm(pos.coords.latitude, pos.coords.longitude, shopLat, shopLng);
                        if(dist < 100) {
                            await updateDoc(userRef, { exp: increment(10), lastCheckIn: new Date() });
                            alert(`ğŸ‰ ì¸ì¦ ì„±ê³µ! ê²½í—˜ì¹˜ +10`); location.reload();
                        } else {
                            alert(`ë§¤ì¥ ê·¼ì²˜ê°€ ì•„ë‹™ë‹ˆë‹¤. (ê±°ë¦¬: ${Math.round(dist)}m)`); btn.innerHTML = originalText; btn.disabled = false;
                        }
                    }, () => { alert("ìœ„ì¹˜ ì‹¤íŒ¨"); btn.innerHTML = originalText; btn.disabled = false; });
                }
            });
        }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R=6371; var dLat=deg2rad(lat2-lat1); var dLon=deg2rad(lon2-lon1);
            var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c*1000;
        }
        function deg2rad(deg) { return deg*(Math.PI/180); }

        // í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°
        window.openProfileModal = async function() {
            const user = auth.currentUser;
            if(!user) return;
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            if(snap.exists()) {
                const data = snap.data();
                const lv = 1 + Math.floor((data.exp||0)/10);
                document.getElementById('pImg').src = user.photoURL;
                document.getElementById('pName').innerText = user.displayName;
                document.getElementById('pLevel').innerText = `LV.${lv} (ë¯¸ì‹ê°€)`;
                document.getElementById('pExpText').innerText = `${data.exp||0} EXP`;
                document.getElementById('pExpBar').style.width = Math.min((data.exp%10)*10, 100) + '%';
                document.getElementById('profileModal').classList.add('show');
            }
        }

        window.closePanel = function() { document.getElementById('infoPanel').classList.remove('show'); }
        window.closeSelectModal = function() { document.getElementById('selectModal').classList.remove('show'); }
        window.showSelectModal = function(list) {
            const container = document.getElementById('selectList'); container.innerHTML = '';
            list.forEach(shop => {
                const div = document.createElement('div'); div.className = 'shop-select-item';
                div.innerText = shop.name;
                div.onclick = () => { closeSelectModal(); showPanel(shop); };
                container.appendChild(div);
            });
            document.getElementById('selectModal').classList.add('show');
        }
        window.moveToCurrentLocation = function() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            const btnText = document.querySelector('.loc-text');
            if(btnText) btnText.innerText = "íƒìƒ‰ì¤‘..";
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                map.setCenter(new naver.maps.LatLng(lat, lng)); map.setZoom(16);
                setTimeout(() => { updateVisibleMarkers(); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; }, 300);
            }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; });
        }
        
        let isLikeFilterOn = false;
        window.toggleLikeFilter = function() {
            isLikeFilterOn = !isLikeFilterOn;
            const btn = document.getElementById('btnShowLikes');
            btn.style.background = isLikeFilterOn ? "#e74c3c" : "white";
            btn.style.color = isLikeFilterOn ? "white" : "#e74c3c";
            updateVisibleMarkers();
        }
        
        let idleTimer;
        naver.maps.Event.addListener(map, 'idle', function() { 
            clearTimeout(idleTimer); 
            idleTimer = setTimeout(updateVisibleMarkers, 150); 
        });

        window.applyAllFilters = function() { updateVisibleMarkers(); };
        window.googleLogin = function() { signInWithPopup(auth, googleProvider).then((r)=>{alert("ë¡œê·¸ì¸ ì„±ê³µ"); location.reload();}); }
        window.googleLogout = function() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { signOut(auth).then(() => { location.reload(); }); } };
        
        onAuthStateChanged(auth, (user) => {
            if(user) { document.getElementById('btnLogin').style.display='none'; document.getElementById('myProfile').style.display='flex'; document.getElementById('userName').innerText = user.displayName; }
        });

        initApp(); 
    </script>
</body>
</html>