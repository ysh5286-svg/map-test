<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c0392b">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/maps/local_dining/materialicons/48dp/2x/baseline_local_dining_black_48dp.png">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">
    <meta property="og:title" content="ğŸ—ºï¸ ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„">
    <meta property="og:description" content="ëŒ€êµ¬ ì°ë§›ì§‘ê³¼ í•«í”Œì„ í•œëˆˆì—!&#10;ì‹¤íŒ¨ ì—†ëŠ” ë§›ì§‘ ì§€ë„">
    <meta property="og:image" content="https://search.pstatic.net/common/?src=https%3A%2F%2Fldb-phinf.pstatic.net%2F20260106_269%2F1767704133801UGRCw_JPEG%2FGemini_Generated_Image_b2zgovb2zgovb2zg.jpg">
    <meta property="og:url" content="https://www.heredaegu.com">

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>ğŸ’ ë³´ë¬¼ì§€ë„ë¥¼ í¼ì¹˜ëŠ” ì¤‘...</p>
    </div>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="search-filters">
                <select id="filterRegion" class="search-select" onchange="applyAllFilters()">
                    <option value="">ğŸ“ ì§€ì—­ ì „ì²´</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="ì²­ë„">ì²­ë„</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option>
                </select>
                <select id="filterCategory" class="search-select" onchange="applyAllFilters()">
                    <option value="">ğŸœ ì—…ì¢… ì „ì²´</option><option value="í•œì‹">í•œì‹</option><option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ë¶„ì‹">ë¶„ì‹</option><option value="ê³ ê¸°/êµ¬ì´">ê³ ê¸°/êµ¬ì´</option><option value="íšŒ/í•´ì‚°ë¬¼">íšŒ/í•´ì‚°ë¬¼</option><option value="ì•„ì‹œì•ˆ">ì•„ì‹œì•ˆ</option><option value="ìˆ ì§‘">ìˆ ì§‘</option><option value="ì¹´í˜/ë””ì €íŠ¸">ì¹´í˜/ë””ì €íŠ¸</option><option value="ë¹µì§‘">ë¹µì§‘</option><option value="íŒ¨ìŠ¤íŠ¸í‘¸ë“œ">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option><option value="í¬ì¥/ë°°ë‹¬">í¬ì¥/ë°°ë‹¬</option>
                </select>
                <select id="filterPurpose" class="search-select" onchange="applyAllFilters()">
                    <option value="">âœ¨ ë¶„ìœ„ê¸° ì „ì²´</option><option value="ë…¸í¬">ë…¸í¬</option><option value="ë°ì´íŠ¸">ë°ì´íŠ¸</option><option value="ë‹¨ì²´íšŒì‹">ë‹¨ì²´íšŒì‹</option><option value="í˜¼ë°¥/í˜¼ìˆ ">í˜¼ë°¥/í˜¼ìˆ </option><option value="ë¬´í•œë¦¬í•„">ë¬´í•œë¦¬í•„</option><option value="ì´ìƒ‰ë§›ì§‘">ì´ìƒ‰ë§›ì§‘</option><option value="ë·°ë§›ì§‘">ë·°ë§›ì§‘</option><option value="ìƒê²¬ë¡€">ìƒê²¬ë¡€</option><option value="ì•¼ê°„ì˜ì—…">ì•¼ê°„ì˜ì—…</option>
                </select>
            </div>
            <div class="search-input-row">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="keyword" class="search-input" placeholder="ì˜ˆ: ë™ì„±ë¡œ ë‘ë°”ì´ (ë„ì–´ì“°ê¸°ë¡œ êµì°¨ê²€ìƒ‰)" onkeyup="applyAllFilters()">
            </div>
        </div>
    </div>

    <div id="faqPanel" class="faq-panel">
        <div class="faq-header"><h3>ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3><button class="faq-close" onclick="toggleFaq()">âœ•</button></div>
        <div class="faq-body">
            <div class="faq-item"><div class="faq-q">Q. ë‹¤ì¦í”¼í”Œ ë³´ë¬¼ì§€ë„ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</div><div class="faq-a">ëŒ€êµ¬ ì°ë§›ì§‘ ì •ë³´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div></div>
            <div class="faq-item"><div class="faq-q">Q. ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì„ ì •ë˜ë‚˜ìš”?</div><div class="faq-a">'ëŒ€êµ¬ ì°ë§›ì§‘ í‰ê°€ë‹¨'ì´ ì§ì ‘ ê²€ì¦í•˜ê³  ì—„ì„ í•œ ë¡œì»¬ ì°ë§›ì§‘ & í•«í”Œë§Œ ëª¨ì•˜ìŠµë‹ˆë‹¤.</div></div>
            <div class="faq-item"><div class="faq-q">Q. ìš°ë¦¬ ê°€ê²Œë„ ë“±ë¡í•˜ê³  ì‹¶ì–´ìš”!</div><div class="faq-a">ìš°ì¸¡ í•˜ë‹¨ [ë³´ë¬¼ì§€ë„ ë“±ë¡ìš”ì²­] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹ ì²­í•´ì£¼ì„¸ìš”.</div></div>
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="https://open.kakao.com/o/gaV5kk8h" target="_blank" class="panel-btn" style="background:#fee500; color:#3c1e1e;">ğŸ’¬ ëŒ€êµ¬í•«í”Œì—¬ê¸° ì°ë§›ì§‘ ì •ë³´ë°©</a>
                <button onclick="openGameModal()" class="panel-btn" style="background:#2c3e50;">ğŸ® ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</button>
                <a href="https://litt.ly/dazzlepeople" target="_blank" class="panel-btn" style="background:#e1306c;">ğŸ“± SNS êµ¬ê²½ê°€ê¸°</a>
            </div>
        </div>

        <div style="padding: 0 20px 10px 20px;">
            <button id="installBtn" class="panel-btn" style="display:none; background:#3498db; color:white; font-size:15px; box-shadow:0 4px 6px rgba(52, 152, 219, 0.3);">
                â¬‡ï¸ ëŒ€êµ¬ë³´ë¬¼ì§€ë„ ì•± ì„¤ì¹˜í•˜ê¸°
            </button>
        </div>

        <div class="faq-footer">
            <div class="company-box">
                <strong>ë‹¤ì¦í”¼í”Œ (ëŒ€í‘œ: ìœ¤ì„±í˜¸)</strong><br>
                ì‚¬ì—…ìë²ˆí˜¸: 535-25-01793<br>
                ì£¼ì†Œ: ëŒ€êµ¬ê´‘ì—­ì‹œ ë™êµ¬ ì†¡ë¼ë¡œ16ê¸¸ 42
            </div>
        </div>
    </div>

    <div id="selectModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeSelectModal()">Ã—</button>
            <h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
            <div id="selectList" class="shop-select-list"></div>
        </div>
    </div>

    <div id="gameModal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; padding:0;">
            <button class="modal-close-x" style="z-index:10; top:10px; right:10px;" onclick="closeGameModal()">Ã—</button>
            
            <div class="game-container" style="padding:25px;">
                <div id="gameMain">
                    <div class="game-title">ğŸ½ï¸ ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</div>
                    <div class="game-selection">
                        <div class="game-card" onclick="startWorldCupGame()">
                            <span class="game-icon">ğŸ†</span>
                            <span class="game-name">ìŒì‹ ì›”ë“œì»µ</span>
                            <span class="game-desc">í† ë„ˆë¨¼íŠ¸ë¡œ<br>ì‹ ì¤‘í•˜ê²Œ!</span>
                        </div>
                        <div class="game-card" onclick="startRouletteGame()">
                            <span class="game-icon">ğŸ¡</span>
                            <span class="game-name">ëœë¤ ëŒë¦¼íŒ</span>
                            <span class="game-desc">ìš´ëª…ì—<br>ë§¡ê²¨ìš”!</span>
                        </div>
                    </div>
                </div>

                <div id="wcGame" class="wc-container">
                    <div class="wc-round-badge" id="wcRoundBadge">16ê°•</div>
                    <div class="wc-vs-box">
                        <div class="wc-card" onclick="wcChoose(0)"><div id="wcImgLeft" class="wc-img"></div><div id="wcNameLeft" class="wc-name"></div></div>
                        <div style="font-weight:bold; color:#e74c3c; font-style:italic;">VS</div>
                        <div class="wc-card" onclick="wcChoose(1)"><div id="wcImgRight" class="wc-img"></div><div id="wcNameRight" class="wc-name"></div></div>
                    </div>
                    <button onclick="resetGame()" style="font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">ì²˜ìŒìœ¼ë¡œ</button>
                </div>

                <div id="wcResult" class="hidden" style="text-align:center;">
                    <div style="font-size:12px; font-weight:bold; color:#888; margin-bottom:10px;">ğŸ‘‘ ìµœí›„ì˜ ìŠ¹ì ğŸ‘‘</div>
                    <div id="wcWinnerImg" style="font-size:80px; margin-bottom:10px;"></div>
                    <div id="wcWinnerName" style="font-size:24px; font-weight:bold; color:#3498db; margin-bottom:20px;"></div>
                    <button onclick="resetGame()" class="spin-btn" style="background:#333;">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>

                <div id="rouletteGame" class="roulette-container">
                    <div class="roulette-mode-btns">
                        <button onclick="setRouletteMode('lunch')" id="btn-lunch" class="roulette-btn active">ì ì‹¬</button>
                        <button onclick="setRouletteMode('dinner')" id="btn-dinner" class="roulette-btn">ì €ë…</button>
                        <button onclick="setRouletteMode('weekend')" id="btn-weekend" class="roulette-btn">ì£¼ë§</button>
                        <button onclick="setRouletteMode('custom')" id="btn-custom" class="roulette-btn" style="color:#3498db; border-color:#3498db;">ë‚´ë§˜ëŒ€ë¡œ</button>
                    </div>
                    <div id="customInputArea" class="custom-input-box">
                        <div class="custom-input-row">
                            <input type="text" id="customItemInput" class="custom-input" placeholder="ë©”ë‰´ ì…ë ¥" onkeypress="if(event.key==='Enter') addCustomItem()">
                            <button onclick="addCustomItem()" class="custom-add-btn">ì¶”ê°€</button>
                        </div>
                        <div id="customItemList" class="custom-list"></div>
                    </div>
                    <div class="roulette-canvas-box"><canvas id="rouletteCanvas" width="560" height="560" class="roulette-canvas"></canvas><div class="roulette-arrow">â–¼</div></div>
                    <button id="spinBtn" class="spin-btn" onclick="spinRoulette()">ëŒë ¤ ëŒë ¤! START</button>
                    <button onclick="resetGame()" style="margin-top:10px; font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">ì²˜ìŒìœ¼ë¡œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="infoPanel" class="info-panel">
        <div class="panel-header" id="panelHeader"><button class="panel-close" onclick="closePanel()">âœ•</button></div>
        <div class="panel-body">
            <div><h2 class="panel-title" id="panelTitle">ê°€ê²Œ ì´ë¦„</h2><div class="panel-meta" id="panelMeta"></div></div>
            <div class="rating-box">
                <div class="rating-left"><div class="total-score" id="panelTotal">0.0</div><div class="total-label">ì´ì </div></div>
                <div class="rating-grid">
                    <div class="detail-score"><span>ë§›</span> <div class="progress-bg"><div id="barTaste" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>ê°€ì„±ë¹„</span> <div class="progress-bg"><div id="barValue" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>ë¶„ìœ„ê¸°</span> <div class="progress-bg"><div id="barMood" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>ì¹œì ˆë„</span> <div class="progress-bg"><div id="barKind" class="progress-bar"></div></div></div>
                </div>
            </div>
            <div class="info-row"><span class="info-label">ë©”ë‰´</span> <span class="info-text" id="panelMenu"></span></div>
            <div class="info-row"><span class="info-label">ì£¼ì†Œ</span> <span class="info-text" id="panelAddr"></span></div>
            <div class="info-row"><span class="info-label">ì„¤ëª…</span> <span class="info-text" id="panelDesc"></span></div>
            <a href="#" id="panelLink" target="_blank" class="panel-btn">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°</a>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="bottom-left">
            <button class="bar-btn btn-usage" onclick="toggleFaq()">ğŸ“– ì‚¬ìš©ë²•</button>
            <a href="https://www.dazzlepeople.com" target="_blank" class="footer-copyright" style="margin-left:10px;">Â© Dazzle People</a>
        </div>
        <div class="bottom-center">
            <button class="btn-location-mode" onclick="moveToCurrentLocation()">
                <div class="loc-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <span class="loc-text">ë‚´ ì£¼ë³€</span>
            </button>
        </div>
        <div class="bottom-right">
            <button class="bar-btn" style="background:#e67e22; color:white; border:none;" onclick="window.open('http://pf.kakao.com/_dmaAG')">ğŸŒŸ ë³´ë¬¼ì§€ë„ ë“±ë¡ìš”ì²­</button>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // ... (ê¸°ì¡´ ê²Œì„ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸) ...
        function toggleFaq() { document.getElementById('faqPanel').classList.toggle('show'); }
        function closePanel() { document.getElementById('infoPanel').classList.remove('show'); }
        function closeSelectModal() { document.getElementById('selectModal').classList.remove('show'); }
        function openGameModal() { resetGame(); document.getElementById('gameModal').classList.add('show'); document.getElementById('faqPanel').classList.remove('show'); }
        function closeGameModal() { document.getElementById('gameModal').classList.remove('show'); }
        
        const foodData = {
            lunch: [{name:"ê¹€ì¹˜ì°Œê°œ",img:"ğŸ¥˜"},{name:"ëˆê¹ŒìŠ¤",img:"ğŸ›"},{name:"ì œìœ¡ë³¶ìŒ",img:"ğŸ¥©"},{name:"ìˆœëŒ€êµ­ë°¥",img:"ğŸš"},{name:"í–„ë²„ê±°",img:"ğŸ”"},{name:"ì§œì¥ë©´",img:"ğŸ¥¢"},{name:"ì§¬ë½•",img:"ğŸœ"},{name:"ì¹¼êµ­ìˆ˜",img:"ğŸ²"},{name:"ê¹€ë°¥/ë¼ë©´",img:"ğŸ™"},{name:"ë¹„ë¹”ë°¥",img:"ğŸ¥—"},{name:"ë¶€ëŒ€ì°Œê°œ",img:"ğŸ¥˜"},{name:"ê°€ì •ì‹ë°±ë°˜",img:"ğŸ±"},{name:"ìŒ€êµ­ìˆ˜",img:"ğŸœ"},{name:"ìƒŒë“œìœ„ì¹˜",img:"ğŸ¥ª"},{name:"í¸ì˜ì ",img:"ğŸª"},{name:"ìƒëŸ¬ë“œ",img:"ğŸ¥—"}],
            dinner: [{name:"ì‚¼ê²¹ì‚´",img:"ğŸ¥“"},{name:"ì¹˜í‚¨",img:"ğŸ—"},{name:"ê³±ì°½/ëŒ€ì°½",img:"ğŸ”¥"},{name:"íšŒ/ì‚¬ì‹œë¯¸",img:"ğŸŸ"},{name:"ì¡±ë°œ/ë³´ìŒˆ",img:"ğŸ–"},{name:"ë§ˆë¼íƒ•",img:"ğŸŒ¶ï¸"},{name:"ì–‘ê¼¬ì¹˜",img:"ğŸ¡"},{name:"í”¼ì",img:"ğŸ•"},{name:"ë‹­ë°œ",img:"ğŸ”¥"},{name:"ì°œë‹­",img:"ğŸ¥˜"},{name:"ê°ˆë¹„",img:"ğŸ¥©"},{name:"ê°ìíƒ•",img:"ğŸ¥˜"},{name:"ì´ìì¹´ì•¼",img:"ğŸ¶"},{name:"íŒŒìŠ¤íƒ€",img:"ğŸ"},{name:"ìŠ¤í…Œì´í¬",img:"ğŸ¥©"},{name:"ì˜¤ëŒë¼ˆ",img:"ğŸ–"}],
            weekend: [{name:"ë¸ŒëŸ°ì¹˜",img:"ğŸ¥"},{name:"ìƒ¤ë¸Œìƒ¤ë¸Œ",img:"ğŸ²"},{name:"ë°°ë‹¬ì¹˜í‚¨",img:"ğŸ—"},{name:"í”¼ìíŒŒí‹°",img:"ğŸ•"},{name:"ì§œíŒŒê²Œí‹°",img:"ğŸœ"},{name:"ë·”í˜",img:"ğŸ½ï¸"},{name:"ì†Œê³ ê¸°",img:"ğŸ¥©"},{name:"í•´ë¬¼ì°œ",img:"ğŸ™"},{name:"ì§‘ë°¥",img:"ğŸš"},{name:"í¸ì˜ì í„¸ê¸°",img:"ğŸ«"},{name:"íƒ€ì½”/ì´ìƒ‰",img:"ğŸŒ®"},{name:"ëƒ‰ì¥ê³ íŒŒë¨¹ê¸°",img:"ğŸ§Š"},{name:"ë§ˆë¼íƒ•",img:"ğŸŒ¶ï¸"},{name:"ì¡±ë°œ/ë³´ìŒˆ",img:"ğŸ–"},{name:"ì¤‘êµ­ì§‘",img:"ğŸ¥¢"},{name:"ì¹´í˜/ë””ì €íŠ¸",img:"ğŸ°"}]
        };
        let currentFoods=[],wcCurrentRound=[],wcNextRound=[],wcIndex=0,customFoods=["ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡"],rCanvas,rCtx,rCurrentRotation=0,isSpinning=false;
        const colors=["#FF9AA2","#FFB7B2","#FFDAC1","#E2F0CB","#B5EAD7","#C7CEEA","#93C5FD","#A78BFA","#FCA5A5","#FDBA74","#FDE047","#86EFAC"];
        function resetGame(){ document.getElementById('gameMain').classList.remove('hidden'); document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.add('hidden'); document.getElementById('rouletteGame').style.display='none'; }
        function startWorldCupGame(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('wcGame').style.display='flex'; const all=[...foodData.lunch,...foodData.dinner,...foodData.weekend]; const uniq=all.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i); uniq.sort(()=>Math.random()-0.5); wcCurrentRound=uniq.slice(0,16); wcNextRound=[]; wcIndex=0; updateWcMatch(); }
        function updateWcMatch(){ if(wcIndex>=wcCurrentRound.length/2){ wcCurrentRound=[...wcNextRound]; wcNextRound=[]; wcIndex=0; wcCurrentRound.sort(()=>Math.random()-0.5); } if(wcCurrentRound.length===1){ showWcWinner(wcCurrentRound[0]); return; } document.getElementById('wcRoundBadge').innerText=wcCurrentRound.length===2?"ê²°ìŠ¹":wcCurrentRound.length+"ê°•"; const l=wcCurrentRound[wcIndex*2],r=wcCurrentRound[wcIndex*2+1]; document.getElementById('wcImgLeft').innerText=l.img; document.getElementById('wcNameLeft').innerText=l.name; document.getElementById('wcImgRight').innerText=r.img; document.getElementById('wcNameRight').innerText=r.name; }
        window.wcChoose=function(s){ wcNextRound.push(wcCurrentRound[wcIndex*2+s]); wcIndex++; updateWcMatch(); }
        function showWcWinner(w){ document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.remove('hidden'); document.getElementById('wcWinnerImg').innerText=w.img; document.getElementById('wcWinnerName').innerText=w.name; fireConfetti(); }
        window.startRouletteGame=function(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('rouletteGame').style.display='flex'; initRoulette(); setRouletteMode('lunch'); }
        function initRoulette(){ rCanvas=document.getElementById('rouletteCanvas'); rCtx=rCanvas.getContext('2d'); }
        window.setRouletteMode=function(m){ if(isSpinning)return; document.querySelectorAll('.roulette-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); if(m==='custom'){ currentFoods=[...customFoods]; document.getElementById('customInputArea').style.display='block'; renderCustomItems(); }else{ currentFoods=foodData[m].map(i=>i.name); document.getElementById('customInputArea').style.display='none'; } drawRoulette(); }
        window.addCustomItem=function(){ const v=document.getElementById('customItemInput').value.trim(); if(v){ customFoods.push(v); currentFoods=[...customFoods]; document.getElementById('customItemInput').value=''; renderCustomItems(); drawRoulette(); } }
        window.removeCustomItem=function(i){ customFoods.splice(i,1); currentFoods=[...customFoods]; renderCustomItems(); drawRoulette(); }
        function renderCustomItems(){ document.getElementById('customItemList').innerHTML=customFoods.map((t,i)=>`<span class="custom-tag">${t} <span class="custom-tag-del" onclick="removeCustomItem(${i})">Ã—</span></span>`).join(''); }
        function drawRoulette(){ if(!rCanvas)return; const n=currentFoods.length; if(n===0){ rCtx.clearRect(0,0,rCanvas.width,rCanvas.height); return; } const arc=(2*Math.PI)/n,dpr=window.devicePixelRatio||1,rect=rCanvas.getBoundingClientRect(); rCanvas.width=rect.width*dpr; rCanvas.height=rect.height*dpr; rCtx.scale(dpr,dpr); const r=rect.width/2; rCtx.clearRect(0,0,rect.width,rect.height); for(let i=0;i<n;i++){ const a=i*arc-Math.PI/2; rCtx.beginPath(); rCtx.moveTo(r,r); rCtx.arc(r,r,r,a,a+arc); rCtx.fillStyle=colors[i%colors.length]; rCtx.fill(); rCtx.stroke(); rCtx.save(); rCtx.translate(r,r); rCtx.rotate(a+arc/2); rCtx.textAlign="right"; rCtx.fillStyle="#333"; const fs=Math.max(12,Math.min(24,200/n)); rCtx.font=`bold ${fs}px 'Noto Sans KR'`; rCtx.fillText(currentFoods[i],r-20,5); rCtx.restore(); } }
        window.spinRoulette=function(){ if(isSpinning)return; if(currentFoods.length<2){ alert("ë©”ë‰´ 2ê°œ ì´ìƒ í•„ìš”!"); return; } isSpinning=true; document.getElementById('spinBtn').innerText="...DoRoRo..."; const r=Math.floor(Math.random()*360); rCurrentRotation+=(360*5+r); rCanvas.style.transition="transform 4s cubic-bezier(0.25,0.1,0.25,1)"; rCanvas.style.transform=`rotate(${rCurrentRotation}deg)`; setTimeout(()=>{ isSpinning=false; document.getElementById('spinBtn').innerText="ëŒë ¤ ëŒë ¤! START"; fireConfetti(); },4000); }
        function fireConfetti(){ const c=['#f00','#0f0','#00f','#ff0','#0ff']; for(let i=0;i<50;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw'; d.style.top='-10px'; d.style.backgroundColor=c[Math.floor(Math.random()*c.length)]; d.style.animationDuration=(Math.random()*2+2)+'s'; document.body.appendChild(d); setTimeout(()=>d.remove(),4000); } }
    </script>

    <script type="module">
        import { db, initMap, createMarker } from "./common.js";
        // ğŸ”¥ getDocsë¥¼ ìƒë‹¨ì—ì„œ ì •í™•í•˜ê²Œ ì„í¬íŠ¸
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        var map = initMap();
        let allShops = [];
        let markerList = [];

        const LANDMARKS = {
            "íŒ”ê³µì‚°": { lat: 35.9899, lng: 128.6961 }, "ê°“ë°”ìœ„": { lat: 35.9758, lng: 128.7694 },
            "ë°˜ì›”ë‹¹": { lat: 35.8644, lng: 128.5933 }, "ë™ì„±ë¡œ": { lat: 35.8710, lng: 128.5960 },
            "ìˆ˜ì„±ëª»": { lat: 35.8280, lng: 128.6170 }, "ì´ì›”ë“œ": { lat: 35.8530, lng: 128.5630 },
            "83íƒ€ì›Œ": { lat: 35.8530, lng: 128.5630 }, "ë‘ë¥˜ê³µì›": { lat: 35.8475, lng: 128.5583 },
            "ë™ëŒ€êµ¬ì—­": { lat: 35.8770, lng: 128.6285 }, "ëŒ€êµ¬ì—­": { lat: 35.8764, lng: 128.5960 },
            "ì„œë¬¸ì‹œì¥": { lat: 35.8690, lng: 128.5815 }, "ê¹€ê´‘ì„ê±°ë¦¬": { lat: 35.8603, lng: 128.6080 },
            "ì•ì‚°": { lat: 35.8335, lng: 128.5810 }, "ê°•ì •ë³´": { lat: 35.8430, lng: 128.4690 },
            "ë””ì•„í¬": { lat: 35.8430, lng: 128.4690 }, "ì‚¼ì„±ë¼ì´ì˜¨ì¦ˆíŒŒí¬": { lat: 35.8411, lng: 128.6817 },
            "ë¼íŒ": { lat: 35.8411, lng: 128.6817 }, "ëŒ€êµ¬ê³µí•­": { lat: 35.8970, lng: 128.6440 },
            "ê²½ë¶ëŒ€": { lat: 35.8906, lng: 128.6121 }, "ê³„ëª…ëŒ€": { lat: 35.8535, lng: 128.4860 },
            "ì˜ë‚¨ëŒ€": { lat: 35.8306, lng: 128.7562 }
        };

        naver.maps.Event.addListener(map, "click", function() {
            closePanel(); document.getElementById('faqPanel').classList.remove('show');
        });

        // ğŸ”¥ [í•µì‹¬ 1] ì²˜ìŒì— ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        if(db) {
            getDocs(collection(db, "shops")).then((snapshot) => {
                allShops = [];
                snapshot.forEach((doc) => allShops.push({ id: doc.id, ...doc.data() }));
                
                // ë°ì´í„°ëŠ” ì™”ì§€ë§Œ ì§€ë„ê°€ ì¤€ë¹„ ì•ˆ ëì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹œë„
                updateVisibleMarkers();
                
                // ë¡œë”© ì¢…ë£Œ
                document.getElementById('loadingOverlay').classList.add('fade-out');
            }).catch(e => {
                console.error("Error:", e);
                document.getElementById('loadingOverlay').classList.add('fade-out');
            });
        }

        // ğŸ”¥ [í•µì‹¬ 2] ì§€ë„ê°€ ë©ˆì¶œ ë•Œ(idle)ë§ˆë‹¤ ë§ˆì»¤ ê°±ì‹ 
        // ëª¨ë°”ì¼ì—ì„œ ì´ˆê¸° ë¡œë”©ì´ ëŠ¦ì–´ í•€ì´ ì•ˆ ëœ° ë•Œ, ì´ ì´ë²¤íŠ¸ê°€ ê²°êµ­ ì‹¤í–‰ë˜ì–´ í•€ì„ ê·¸ë ¤ì¤Œ
        naver.maps.Event.addListener(map, 'idle', updateVisibleMarkers);

        // ğŸ”¥ [í•µì‹¬ 3] í™”ë©´ì— ë³´ì´ëŠ” ê°€ê²Œë§Œ ê³¨ë¼ë‚´ëŠ” í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€ë¨)
        function updateVisibleMarkers() {
            // ğŸš¨ ì•ˆì „ì¥ì¹˜: ì§€ë„ê°€ ì•„ì§ ì´ˆê¸°í™” ì¤‘ì´ë¼ ì˜ì—­(bounds)ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨í•˜ê³  ëŒ€ê¸°
            const bounds = map.getBounds();
            if (!bounds) {
                return; // ì§€ë„ê°€ ì™„ì „íˆ ëœ° ë•Œê¹Œì§€(idle ì´ë²¤íŠ¸ ë°œìƒ ì „ê¹Œì§€) ë§ˆì»¤ ìƒì„± ë³´ë¥˜
            }
            
            // í•„í„°ë§ ì ìš©ëœ ê°€ê²Œë“¤ ì¤‘ì—ì„œ + í™”ë©´ ì•ˆì— ìˆëŠ” ê²ƒë§Œ
            const filtered = filterShops(allShops);
            const visibleShops = filtered.filter(shop => {
                if(!shop.lat || !shop.lng) return false;
                const pos = new naver.maps.LatLng(shop.lat, shop.lng);
                return bounds.hasLatLng(pos);
            });

            renderMarkers(visibleShops);
        }

        window.moveToCurrentLocation = function() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const loc = new naver.maps.LatLng(lat, lng);
                map.setCenter(loc);
                map.setZoom(16);
                if (window.myLocationMarker) window.myLocationMarker.setMap(null);
                window.myLocationMarker = new naver.maps.Marker({
                    position: loc, map: map,
                    icon: { content: '<div style="width:16px;height:16px;background:#3498db;border:2px solid white;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', anchor: new naver.maps.Point(8, 8) }
                });
            }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (GPSë¥¼ ì¼œì£¼ì„¸ìš”)"); });
        }

        $('#keyword').on('keydown', function(e) {
            if (e.key === 'Enter') {
                const query = $(this).val().replace(/\s+/g, '');
                if(!query) return;
                for (const key in LANDMARKS) {
                    if (query.includes(key)) {
                        const coords = LANDMARKS[key];
                        map.setCenter(new naver.maps.LatLng(coords.lat, coords.lng));
                        map.setZoom(15);
                        return;
                    }
                }
                searchAddressToCoordinate($(this).val().trim());
            }
        });

        function searchAddressToCoordinate(query, isRetry = false) {
            naver.maps.Service.geocode({ query: query }, function(status, response) {
                if (status === naver.maps.Service.Status.OK) {
                    if (response.v2 && response.v2.addresses.length > 0) {
                        const item = response.v2.addresses[0];
                        map.setCenter(new naver.maps.Point(item.x, item.y));
                        map.setZoom(16);
                    } else if (response.result && response.result.items.length > 0) {
                        const item = response.result.items[0];
                        map.setCenter(new naver.maps.Point(item.point.x, item.point.y));
                        map.setZoom(16);
                    } else {
                        if(!isRetry && query.indexOf('ëŒ€êµ¬') === -1) searchAddressToCoordinate("ëŒ€êµ¬ " + query, true);
                        else alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                } else {
                    if(!isRetry && query.indexOf('ëŒ€êµ¬') === -1) searchAddressToCoordinate("ëŒ€êµ¬ " + query, true);
                    else alert("ê²€ìƒ‰ ì‹¤íŒ¨");
                }
            });
        }

        function renderMarkers(shops) {
            markerList.forEach(m => m.setMap(null));
            markerList = [];
            
            const groups = {};
            shops.forEach(shop => {
                if(!shop.lat || !shop.lng) return;
                const key = shop.lat.toFixed(5) + "," + shop.lng.toFixed(5);
                if(!groups[key]) groups[key] = [];
                groups[key].push(shop);
            });

            for(const key in groups) {
                // ëŒ€í‘œ ì„¤ì •: updatedAtì´ ê°€ì¥ ìµœì‹ ì¸ ê²ƒì´ 0ë²ˆ
                groups[key].sort((a, b) => {
                    const dateA = a.updatedAt ? (a.updatedAt.seconds || 0) : 0;
                    const dateB = b.updatedAt ? (b.updatedAt.seconds || 0) : 0;
                    return dateB - dateA;
                });

                const marker = createMarker(map, groups[key], function(clickedList) {
                    if (clickedList.length === 1) showPanel(clickedList[0]);
                    else showSelectModal(clickedList);
                });
                if(marker) markerList.push(marker);
            }
        }

        function showSelectModal(shopList) {
            const listEl = document.getElementById('selectList');
            listEl.innerHTML = '';
            shopList.forEach(shop => {
                const div = document.createElement('div');
                div.className = 'shop-select-item';
                var cat = Array.isArray(shop.category) ? shop.category[0] : shop.category;
                div.innerHTML = `<span class="shop-select-name">${shop.name}</span><span class="shop-select-cat">${cat || 'ë§›ì§‘'}</span>`;
                div.onclick = () => { closeSelectModal(); showPanel(shop); };
                listEl.appendChild(div);
            });
            document.getElementById('selectModal').classList.add('show');
        }

        function filterShops(shops) {
            var region = $('#filterRegion').val();
            var category = $('#filterCategory').val();
            var purpose = $('#filterPurpose').val();
            var keywordInput = $('#keyword').val().toLowerCase().trim();
            var keywords = keywordInput.split(/\s+/).filter(t => t.length > 0);

            return shops.filter(shop => {
                var matchRegion = (region === "") || (shop.region === region);
                var shopCategories = Array.isArray(shop.category) ? shop.category : [shop.category];
                var matchCategory = (category === "") || shopCategories.includes(category);
                var shopPurposes = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose];
                var matchPurpose = (purpose === "") || shopPurposes.includes(purpose);
                
                var searchableText = (
                    shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + shopCategories.join(" ")
                ).toLowerCase();

                var matchKeyword = true;
                if (keywords.length > 0) {
                    matchKeyword = keywords.every(term => searchableText.includes(term));
                }

                return matchRegion && matchCategory && matchPurpose && matchKeyword;
            });
        }

        // í•„í„° ë³€ê²½ ì‹œì—ë„ í™”ë©´ì— ë³´ì´ëŠ” ê²ƒë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•´ updateVisibleMarkers í˜¸ì¶œ
        window.applyAllFilters = function() { updateVisibleMarkers(); };

        function showPanel(data) {
            var img = data.imageUrl || 'https://via.placeholder.com/400x200?text=No+Image';
            $('#panelHeader').css('background-image', `url(${img})`);
            $('#panelTitle').text(data.name);
            var categories = Array.isArray(data.category) ? data.category : [data.category];
            var purposes = Array.isArray(data.purpose) ? data.purpose : [data.purpose];
            var tags = [...categories, data.region, ...purposes, data.area].filter(Boolean);
            $('#panelMeta').html(tags.map(t => `<span class="panel-tag">#${t}</span>`).join(''));
            $('#panelTotal').text(data.totalScore || '0.0');
            setTimeout(() => {
                $('#barTaste').css('width', (data.scoreTaste || 0) * 20 + '%');
                $('#barValue').css('width', (data.scoreValue || 0) * 20 + '%');
                $('#barMood').css('width', (data.scoreMood || 0) * 20 + '%');
                $('#barKind').css('width', (data.scoreKind || 0) * 20 + '%');
            }, 100);
            $('#panelMenu').text(data.menu || '-');
            $('#panelAddr').text(data.address || '-');
            $('#panelDesc').text(data.desc || 'ì„¤ëª… ì—†ìŒ');
            $('#panelLink').attr('href', data.link || '#');
            document.getElementById('faqPanel').classList.remove('show');
            $('#infoPanel').addClass('show');
        }

        // ğŸ”¥ [PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡]
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì™„ë£Œ'))
                .catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ì‹¤íŒ¨', err));
        }

        // ğŸ”¥ [ì•± ì„¤ì¹˜ ë²„íŠ¼ ë¡œì§ - ì•„ì´í°/ì•ˆë“œë¡œì´ë“œ í†µí•©]
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // 1. ì•„ì´í°(iOS)ì¸ì§€ í™•ì¸
        const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);

        if (isIos) {
            // ğŸ ì•„ì´í°ì´ë©´: ë²„íŠ¼ ë¬´ì¡°ê±´ ë³´ì—¬ì£¼ê³  -> ëˆ„ë¥´ë©´ ì•ˆë‚´ ë©”ì‹œì§€
            installBtn.style.display = 'block';
            installBtn.addEventListener('click', () => {
                alert("ğŸ“² ì•„ì´í° ì„¤ì¹˜ ë°©ë²•\n\n1. ì‚¬íŒŒë¦¬ í•˜ë‹¨ 'ê³µìœ ' ë²„íŠ¼ í´ë¦­\n2. ë©”ë‰´ë¥¼ ë‚´ë ¤ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ\n3. ë°”íƒ•í™”ë©´ì— 'ëŒ€êµ¬í•«í”Œì—¬ê¸°' ì•± ìƒì„±!");
            });
        } else {
            // ğŸ¤– ì•ˆë“œë¡œì´ë“œ/PCë©´: ì„¤ì¹˜ ê°€ëŠ¥í•œ ìƒí™©ì¼ ë•Œë§Œ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'block';
            });

            installBtn.addEventListener('click', (e) => {
                // ì•„ì´í°ì´ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
                if(!isIos && deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            installBtn.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
    </script>
</body>
</html>