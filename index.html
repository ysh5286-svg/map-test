<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>대구핫플여기 보물지도</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c0392b">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/maps/local_dining/materialicons/48dp/2x/baseline_local_dining_black_48dp.png">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🗺️</text></svg>">
    <meta property="og:title" content="🗺️ 대구핫플여기 보물지도">
    <meta property="og:description" content="대구 찐맛집과 핫플을 한눈에!&#10;실패 없는 맛집 지도">
    <meta property="og:image" content="https://dazzlepeople.cafe24.com/bizdemo158475/component/board/board_1/u_image/4/546462826_Gemini_Generated_Image_ummtjlummtjlummt.jpg">
    <meta property="og:url" content="https://www.heredaegu.com">

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>💎 보물지도를 펼치는 중...</p>
    </div>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="theme-select-wrapper">
                <select id="mainThemeSelect" class="theme-select" onchange="applyAllFilters()">
                    <option value="ALL">💎 전체 맛집 보기</option>
                    </select>
            </div>
            <div class="search-filters">
                <select id="filterRegion" class="search-select" onchange="applyAllFilters()">
                    <option value="">📍 지역 전체</option><option value="수성구">수성구</option><option value="중구">중구</option><option value="동구">동구</option><option value="서구">서구</option><option value="남구">남구</option><option value="북구">북구</option><option value="달서구">달서구</option><option value="달성군">달성군</option><option value="군위군">군위군</option><option value="칠곡군">칠곡군</option><option value="경산">경산</option><option value="청도">청도</option><option value="대구 밖">대구 밖</option>
                </select>
                <select id="filterCategory" class="search-select" onchange="applyAllFilters()">
                    <option value="">🍜 업종 전체</option><option value="한식">한식</option><option value="중식">중식</option><option value="일식">일식</option><option value="양식">양식</option><option value="분식">분식</option><option value="고기/구이">고기/구이</option><option value="회/해산물">회/해산물</option><option value="아시안">아시안</option><option value="술집">술집</option><option value="카페/디저트">카페/디저트</option><option value="빵집">빵집</option><option value="패스트푸드">패스트푸드</option><option value="포장/배달">포장/배달</option>
                </select>
                <select id="filterPurpose" class="search-select" onchange="applyAllFilters()">
                    <option value="">✨ 분위기 전체</option><option value="노포">노포</option><option value="데이트">데이트</option><option value="단체회식">단체회식</option><option value="혼밥/혼술">혼밥/혼술</option><option value="무한리필">무한리필</option><option value="이색맛집">이색맛집</option><option value="뷰맛집">뷰맛집</option><option value="상견례">상견례</option><option value="야간영업">야간영업</option>
                </select>
            </div>
            <div class="search-input-row">
                <span class="search-icon">🔍</span>
                <input type="text" id="keyword" class="search-input" placeholder="예: 동성로 두바이" onchange="applyAllFilters()">
            </div>
        </div>
    </div>

    <div id="faqPanel" class="faq-panel">
        <div class="faq-header"><h3>자주 묻는 질문</h3><button class="faq-close" onclick="toggleFaq()">✕</button></div>
        <div class="faq-body">
            <div class="faq-item"><div class="faq-q">Q. '대구보물지도'는 무엇인가요?</div><div class="faq-a">대구 찐맛집 정보를 한눈에 볼 수 있는 서비스입니다.</div></div>
            <div class="faq-item"><div class="faq-q">Q. 어떤 기준으로 선정되나요?</div><div class="faq-a">'대구 찐맛집 평가단'이 직접 검증하고 엄선한 로컬 찐맛집 & 핫플만 모았습니다.</div></div>
            <div class="faq-item"><div class="faq-q">Q. 우리 가게도 등록하고 싶어요!</div><div class="faq-a">우측 하단 [보물지도 등록요청] 버튼을 눌러 신청해주세요.</div></div>
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="https://open.kakao.com/o/gaV5kk8h" target="_blank" class="panel-btn" style="background:#fee500; color:#3c1e1e;">💬 대구경북 찐맛집 소통방</a>
                <button onclick="openGameModal()" class="panel-btn" style="background:#2c3e50;">🎮 오늘 뭐 먹지?</button>
                <a href="https://litt.ly/dazzlepeople" target="_blank" class="panel-btn" style="background:#e1306c;">📱 SNS 구경가기</a>
            </div>
        </div>

        <div style="padding: 0 20px 10px 20px;">
            <button id="installBtn" class="panel-btn" style="display:none; background:#3498db; color:white; font-size:15px; box-shadow:0 4px 6px rgba(52, 152, 219, 0.3);">
                ⬇️ 대구보물지도 앱 설치하기
            </button>
        </div>

        <div class="faq-footer">
            <div class="company-box">
                <strong>다즐피플 (대표: 윤성호)</strong><br>
                사업자번호: 535-25-01793<br>
                주소: 대구광역시 동구 송라로16길 42
            </div>
        </div>
    </div>

    <div id="selectModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeSelectModal()">×</button>
            <h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">👇 매장을 선택해주세요</h3>
            <div id="selectList" class="shop-select-list"></div>
        </div>
    </div>

    <div id="gameModal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; padding:0;">
            <button class="modal-close-x" style="z-index:10; top:10px; right:10px;" onclick="closeGameModal()">×</button>
            
            <div class="game-container" style="padding:25px;">
                <div id="gameMain">
                    <div class="game-title">🍽️ 오늘 뭐 먹지?</div>
                    <div class="game-selection">
                        <div class="game-card" onclick="startWorldCupGame()">
                            <span class="game-icon">🏆</span>
                            <span class="game-name">음식 월드컵</span>
                            <span class="game-desc">토너먼트로<br>신중하게!</span>
                        </div>
                        <div class="game-card" onclick="startRouletteGame()">
                            <span class="game-icon">🎡</span>
                            <span class="game-name">랜덤 돌림판</span>
                            <span class="game-desc">운명에<br>맡겨요!</span>
                        </div>
                    </div>
                </div>

                <div id="wcGame" class="wc-container">
                    <div class="wc-round-badge" id="wcRoundBadge">16강</div>
                    <div class="wc-vs-box">
                        <div class="wc-card" onclick="wcChoose(0)"><div id="wcImgLeft" class="wc-img"></div><div id="wcNameLeft" class="wc-name"></div></div>
                        <div style="font-weight:bold; color:#e74c3c; font-style:italic;">VS</div>
                        <div class="wc-card" onclick="wcChoose(1)"><div id="wcImgRight" class="wc-img"></div><div id="wcNameRight" class="wc-name"></div></div>
                    </div>
                    <button onclick="resetGame()" style="font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">처음으로</button>
                </div>

                <div id="wcResult" class="hidden" style="text-align:center;">
                    <div style="font-size:12px; font-weight:bold; color:#888; margin-bottom:10px;">👑 최후의 승자 👑</div>
                    <div id="wcWinnerImg" style="font-size:80px; margin-bottom:10px;"></div>
                    <div id="wcWinnerName" style="font-size:24px; font-weight:bold; color:#3498db; margin-bottom:20px;"></div>
                    <button onclick="resetGame()" class="spin-btn" style="background:#333;">처음으로 돌아가기</button>
                </div>

                <div id="rouletteGame" class="roulette-container">
                    <div class="roulette-mode-btns">
                        <button onclick="setRouletteMode('lunch')" id="btn-lunch" class="roulette-btn active">점심</button>
                        <button onclick="setRouletteMode('dinner')" id="btn-dinner" class="roulette-btn">저녁</button>
                        <button onclick="setRouletteMode('weekend')" id="btn-weekend" class="roulette-btn">주말</button>
                        <button onclick="setRouletteMode('custom')" id="btn-custom" class="roulette-btn" style="color:#3498db; border-color:#3498db;">내맘대로</button>
                    </div>
                    <div id="customInputArea" class="custom-input-box">
                        <div class="custom-input-row">
                            <input type="text" id="customItemInput" class="custom-input" placeholder="메뉴 입력" onkeypress="if(event.key==='Enter') addCustomItem()">
                            <button onclick="addCustomItem()" class="custom-add-btn">추가</button>
                        </div>
                        <div id="customItemList" class="custom-list"></div>
                    </div>
                    <div class="roulette-canvas-box"><canvas id="rouletteCanvas" width="560" height="560" class="roulette-canvas"></canvas><div class="roulette-arrow">▼</div></div>
                    <button id="spinBtn" class="spin-btn" onclick="spinRoulette()">돌려 돌려! START</button>
                    <button onclick="resetGame()" style="margin-top:10px; font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">처음으로</button>
                </div>
            </div>
        </div>
    </div>

    <div id="infoPanel" class="info-panel">
        <div class="panel-header" id="panelHeader"><button class="panel-close" onclick="closePanel()">✕</button></div>
        <div class="panel-body">
            <div><h2 class="panel-title" id="panelTitle">가게 이름</h2><div class="panel-meta" id="panelMeta"></div></div>
            <div class="rating-box">
                <div class="rating-left"><div class="total-score" id="panelTotal">0.0</div><div class="total-label">총점</div></div>
                <div class="rating-grid">
                    <div class="detail-score"><span>맛</span> <div class="progress-bg"><div id="barTaste" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>가성비</span> <div class="progress-bg"><div id="barValue" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>분위기</span> <div class="progress-bg"><div id="barMood" class="progress-bar"></div></div></div>
                    <div class="detail-score"><span>친절도</span> <div class="progress-bg"><div id="barKind" class="progress-bar"></div></div></div>
                </div>
            </div>
            <div class="info-row"><span class="info-label">메뉴</span> <span class="info-text" id="panelMenu"></span></div>
            <div class="info-row"><span class="info-label">주소</span> <span class="info-text" id="panelAddr"></span></div>
            <div class="info-row"><span class="info-label">설명</span> <span class="info-text" id="panelDesc"></span></div>
            <a href="#" id="panelLink" target="_blank" class="panel-btn">네이버 플레이스 보기</a>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="bottom-left">
            <button class="bar-btn btn-usage" onclick="toggleFaq()">📖 사용법</button>
            <a href="https://www.dazzlepeople.com" target="_blank" class="footer-copyright" style="margin-left:10px;">© Dazzle People</a>
        </div>
        <div class="bottom-center">
            <button class="btn-location-mode" onclick="moveToCurrentLocation()">
                <div class="loc-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <span class="loc-text">내 주변</span>
            </button>
        </div>
        <div class="bottom-right">
            <button class="bar-btn" style="background:#e67e22; color:white; border:none;" onclick="window.open('http://pf.kakao.com/_dmaAG')">🌟 보물지도 등록요청</button>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // ... (기존 게임 관련 스크립트) ...
        function toggleFaq() { document.getElementById('faqPanel').classList.toggle('show'); }
        function closePanel() { document.getElementById('infoPanel').classList.remove('show'); }
        function closeSelectModal() { document.getElementById('selectModal').classList.remove('show'); }
        function openGameModal() { resetGame(); document.getElementById('gameModal').classList.add('show'); document.getElementById('faqPanel').classList.remove('show'); }
        function closeGameModal() { document.getElementById('gameModal').classList.remove('show'); }
        
        const foodData = {
            lunch: [{name:"김치찌개",img:"🥘"},{name:"돈까스",img:"🍛"},{name:"제육볶음",img:"🥩"},{name:"순대국밥",img:"🍚"},{name:"햄버거",img:"🍔"},{name:"짜장면",img:"🥢"},{name:"짬뽕",img:"🍜"},{name:"칼국수",img:"🍲"},{name:"김밥/라면",img:"🍙"},{name:"비빔밥",img:"🥗"},{name:"부대찌개",img:"🥘"},{name:"가정식백반",img:"🍱"},{name:"쌀국수",img:"🍜"},{name:"샌드위치",img:"🥪"},{name:"편의점",img:"🏪"},{name:"샐러드",img:"🥗"}],
            dinner: [{name:"삼겹살",img:"🥓"},{name:"치킨",img:"🍗"},{name:"곱창/대창",img:"🔥"},{name:"회/사시미",img:"🐟"},{name:"족발/보쌈",img:"🍖"},{name:"마라탕",img:"🌶️"},{name:"양꼬치",img:"🍡"},{name:"피자",img:"🍕"},{name:"닭발",img:"🔥"},{name:"찜닭",img:"🥘"},{name:"갈비",img:"🥩"},{name:"감자탕",img:"🥘"},{name:"이자카야",img:"🍶"},{name:"파스타",img:"🍝"},{name:"스테이크",img:"🥩"},{name:"오돌뼈",img:"🍖"}],
            weekend: [{name:"브런치",img:"🥞"},{name:"샤브샤브",img:"🍲"},{name:"배달치킨",img:"🍗"},{name:"피자파티",img:"🍕"},{name:"짜파게티",img:"🍜"},{name:"뷔페",img:"🍽️"},{name:"소고기",img:"🥩"},{name:"해물찜",img:"🐙"},{name:"집밥",img:"🍚"},{name:"편의점털기",img:"🍫"},{name:"타코/이색",img:"🌮"},{name:"냉장고파먹기",img:"🧊"},{name:"마라탕",img:"🌶️"},{name:"족발/보쌈",img:"🍖"},{name:"중국집",img:"🥢"},{name:"카페/디저트",img:"🍰"}]
        };
        let currentFoods=[],wcCurrentRound=[],wcNextRound=[],wcIndex=0,customFoods=["짜장면","짬뽕","탕수육"],rCanvas,rCtx,rCurrentRotation=0,isSpinning=false;
        const colors=["#FF9AA2","#FFB7B2","#FFDAC1","#E2F0CB","#B5EAD7","#C7CEEA","#93C5FD","#A78BFA","#FCA5A5","#FDBA74","#FDE047","#86EFAC"];
        function resetGame(){ document.getElementById('gameMain').classList.remove('hidden'); document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.add('hidden'); document.getElementById('rouletteGame').style.display='none'; }
        function startWorldCupGame(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('wcGame').style.display='flex'; const all=[...foodData.lunch,...foodData.dinner,...foodData.weekend]; const uniq=all.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i); uniq.sort(()=>Math.random()-0.5); wcCurrentRound=uniq.slice(0,16); wcNextRound=[]; wcIndex=0; updateWcMatch(); }
        function updateWcMatch(){ if(wcIndex>=wcCurrentRound.length/2){ wcCurrentRound=[...wcNextRound]; wcNextRound=[]; wcIndex=0; wcCurrentRound.sort(()=>Math.random()-0.5); } if(wcCurrentRound.length===1){ showWcWinner(wcCurrentRound[0]); return; } document.getElementById('wcRoundBadge').innerText=wcCurrentRound.length===2?"결승":wcCurrentRound.length+"강"; const l=wcCurrentRound[wcIndex*2],r=wcCurrentRound[wcIndex*2+1]; document.getElementById('wcImgLeft').innerText=l.img; document.getElementById('wcNameLeft').innerText=l.name; document.getElementById('wcImgRight').innerText=r.img; document.getElementById('wcNameRight').innerText=r.name; }
        window.wcChoose=function(s){ wcNextRound.push(wcCurrentRound[wcIndex*2+s]); wcIndex++; updateWcMatch(); }
        function showWcWinner(w){ document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.remove('hidden'); document.getElementById('wcWinnerImg').innerText=w.img; document.getElementById('wcWinnerName').innerText=w.name; fireConfetti(); }
        window.startRouletteGame=function(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('rouletteGame').style.display='flex'; initRoulette(); setRouletteMode('lunch'); }
        function initRoulette(){ rCanvas=document.getElementById('rouletteCanvas'); rCtx=rCanvas.getContext('2d'); }
        window.setRouletteMode=function(m){ if(isSpinning)return; document.querySelectorAll('.roulette-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); if(m==='custom'){ currentFoods=[...customFoods]; document.getElementById('customInputArea').style.display='block'; renderCustomItems(); }else{ currentFoods=foodData[m].map(i=>i.name); document.getElementById('customInputArea').style.display='none'; } drawRoulette(); }
        window.addCustomItem=function(){ const v=document.getElementById('customItemInput').value.trim(); if(v){ customFoods.push(v); currentFoods=[...customFoods]; document.getElementById('customItemInput').value=''; renderCustomItems(); drawRoulette(); } }
        window.removeCustomItem=function(i){ customFoods.splice(i,1); currentFoods=[...customFoods]; renderCustomItems(); drawRoulette(); }
        function renderCustomItems(){ document.getElementById('customItemList').innerHTML=customFoods.map((t,i)=>`<span class="custom-tag">${t} <span class="custom-tag-del" onclick="removeCustomItem(${i})">×</span></span>`).join(''); }
        function drawRoulette(){ if(!rCanvas)return; const n=currentFoods.length; if(n===0){ rCtx.clearRect(0,0,rCanvas.width,rCanvas.height); return; } const arc=(2*Math.PI)/n,dpr=window.devicePixelRatio||1,rect=rCanvas.getBoundingClientRect(); rCanvas.width=rect.width*dpr; rCanvas.height=rect.height*dpr; rCtx.scale(dpr,dpr); const r=rect.width/2; rCtx.clearRect(0,0,rect.width,rect.height); for(let i=0;i<n;i++){ const a=i*arc-Math.PI/2; rCtx.beginPath(); rCtx.moveTo(r,r); rCtx.arc(r,r,r,a,a+arc); rCtx.fillStyle=colors[i%colors.length]; rCtx.fill(); rCtx.stroke(); rCtx.save(); rCtx.translate(r,r); rCtx.rotate(a+arc/2); rCtx.textAlign="right"; rCtx.fillStyle="#333"; const fs=Math.max(12,Math.min(24,200/n)); rCtx.font=`bold ${fs}px 'Noto Sans KR'`; rCtx.fillText(currentFoods[i],r-20,5); rCtx.restore(); } }
        window.spinRoulette=function(){ if(isSpinning)return; if(currentFoods.length<2){ alert("메뉴 2개 이상 필요!"); return; } isSpinning=true; document.getElementById('spinBtn').innerText="...DoRoRo..."; const r=Math.floor(Math.random()*360); rCurrentRotation+=(360*5+r); rCanvas.style.transition="transform 4s cubic-bezier(0.25,0.1,0.25,1)"; rCanvas.style.transform=`rotate(${rCurrentRotation}deg)`; setTimeout(()=>{ isSpinning=false; document.getElementById('spinBtn').innerText="돌려 돌려! START"; fireConfetti(); },4000); }
        function fireConfetti(){ const c=['#f00','#0f0','#00f','#ff0','#0ff']; for(let i=0;i<50;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw'; d.style.top='-10px'; d.style.backgroundColor=c[Math.floor(Math.random()*c.length)]; d.style.animationDuration=(Math.random()*2+2)+'s'; document.body.appendChild(d); setTimeout(()=>d.remove(),4000); } }
    </script>

    <script type="module">
    import { db, initMap, createMarker } from "./common.js";
    import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. 지도 및 기본 변수 초기화
    var map = initMap();
    let allShops = [];
    let markerList = [];

    // 캐시 설정
    const CACHE_KEY = "dazzle_shops_data_v1"; 

    // 2. 윈도우 리사이즈 이벤트 (디바운싱)
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { map.refresh(); updateVisibleMarkers(); }, 100);
    });

    // 3. 랜드마크 정의
    const LANDMARKS = {
        "팔공산": { lat: 35.9899, lng: 128.6961 }, "갓바위": { lat: 35.9758, lng: 128.7694 },
        "반월당": { lat: 35.8644, lng: 128.5933 }, "동성로": { lat: 35.8710, lng: 128.5960 },
        "수성못": { lat: 35.8280, lng: 128.6170 }, "이월드": { lat: 35.8530, lng: 128.5630 },
        "83타워": { lat: 35.8530, lng: 128.5630 }, "두류공원": { lat: 35.8475, lng: 128.5583 },
        "동대구역": { lat: 35.8770, lng: 128.6285 }, "대구역": { lat: 35.8764, lng: 128.5960 },
        "서문시장": { lat: 35.8690, lng: 128.5815 }, "김광석거리": { lat: 35.8603, lng: 128.6080 },
        "앞산": { lat: 35.8335, lng: 128.5810 }, "강정보": { lat: 35.8430, lng: 128.4690 },
        "디아크": { lat: 35.8430, lng: 128.4690 }, "삼성라이온즈파크": { lat: 35.8411, lng: 128.6817 },
        "라팍": { lat: 35.8411, lng: 128.6817 }, "대구공항": { lat: 35.8970, lng: 128.6440 },
        "경북대": { lat: 35.8906, lng: 128.6121 }, "계명대": { lat: 35.8535, lng: 128.4860 },
        "영남대": { lat: 35.8306, lng: 128.7562 }
    };

    // 4. 지도 클릭 시 패널 닫기
    naver.maps.Event.addListener(map, "click", function() {
        closePanel(); document.getElementById('faqPanel').classList.remove('show');
    });

    // ==========================================
    // 🚀 1. 데이터 가져오기 (캐시 + DB)
    // ==========================================
    async function loadShopsData() {
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_KEY + "_time");
        const now = new Date().getTime();
        let isCacheUsed = false;

        // 캐시 확인
        if (cachedData && cachedTime) {
            try {
                const parsed = JSON.parse(cachedData);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    allShops = parsed;
                    checkAndRender("캐시로드"); // 그리기 시도
                    document.getElementById('loadingOverlay').classList.add('fade-out');
                    isCacheUsed = true;
                }
            } catch (err) { console.warn("캐시 파싱 오류"); }
        }

        // DB 최신 데이터 확인
        if(db) {
            try {
                const snapshot = await getDocs(collection(db, "shops"));
                const newShops = [];
                snapshot.forEach((doc) => newShops.push({ id: doc.id, ...doc.data() }));
                
                if (newShops.length > 0 && JSON.stringify(newShops) !== cachedData) {
                    allShops = newShops;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allShops));
                    localStorage.setItem(CACHE_KEY + "_time", now);
                    
                    checkAndRender("DB업데이트"); // 데이터 왔으니 다시 그리기 시도
                    if(!isCacheUsed) document.getElementById('loadingOverlay').classList.add('fade-out');
                }
            } catch (e) {
                console.error("DB 로딩 실패:", e);
                if(!isCacheUsed) document.getElementById('loadingOverlay').classList.add('fade-out');
            }
        }
    }

    // ==========================================
    // 🚀 2. 테마 로딩 (원하시는 대로 첫번째 테마 선택)
    // ==========================================
    async function initTheme() {
        const select = document.getElementById('mainThemeSelect');
        try {
            const docRef = doc(db, "meta", "themes");
            const docSnap = await getDoc(docRef);
            
            select.innerHTML = ''; // 초기화

            if (docSnap.exists()) {
                let list = docSnap.data().list || [];
                list.sort();
                list.forEach((t) => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.innerText = `🚩 ${t}`;
                    select.appendChild(opt);
                });
                
                // 🔥 [요청사항 반영] 리스트가 있으면 첫 번째 테마 자동 선택
                if (list.length > 0) select.value = list[0];
            }
            
            // '전체 맛집 보기'는 항상 맨 뒤에 추가
            const allOpt = document.createElement('option');
            allOpt.value = "ALL";
            allOpt.innerText = "📂 전체 맛집 보기";
            select.appendChild(allOpt); 
            
            // 만약 테마가 하나도 없으면 전체보기가 기본값
            if (select.options.length === 1) select.value = "ALL";

        } catch(e) {
            console.log("테마 로딩 실패:", e);
            if(select.options.length === 0) {
                const allOpt = document.createElement('option');
                allOpt.value = "ALL"; allOpt.innerText = "📂 전체 맛집 보기";
                select.appendChild(allOpt);
                select.value = "ALL";
            }
        } finally {
            checkAndRender("테마로딩완료"); // 테마 세팅 끝났으니 그리기 시도
        }
    }

    // ==========================================
    // 🚀 3. [핵심] 안전하게 핀 그리기 (무한 재시도)
    // ==========================================
    
    // 이 함수는 "지도", "데이터", "테마" 3박자가 맞을 때까지 끈질기게 기다립니다.
    function checkAndRender(source) {
        // 1. 데이터가 없으면 아직 그릴 수 없음
        if (!allShops || allShops.length === 0) return;

        // 2. 지도가 화면 영역(Bounds)을 잡았는지 확인
        const bounds = map.getBounds();
        
        // 🚨 지도가 아직 로딩 중이라면? (Bounds가 없거나 0일 때)
        if (!bounds || !(bounds instanceof naver.maps.LatLngBounds)) {
            console.log(`⏳ [${source}] 지도 준비 대기중... (재시도 예약)`);
            // 0.2초 뒤에 나 자신을 다시 호출 (재귀)
            setTimeout(() => checkAndRender(source), 200); 
            return;
        }

        // 3. 모든 준비 완료! 그리기 실행
        console.log(`✅ [${source}] 지도 준비됨! 핀 그리기 시작`);
        updateVisibleMarkers();
    }

    function updateVisibleMarkers() {
        if (!map) return;
        const bounds = map.getBounds();
        if (!bounds) return; // 위에서 체크했지만 한번 더 안전장치

        const filtered = filterShops(allShops);
        const visibleShops = filtered.filter(shop => {
            if(!shop.lat || !shop.lng) return false;
            const pos = new naver.maps.LatLng(shop.lat, shop.lng);
            return bounds.hasLatLng(pos);
        });
        renderMarkers(visibleShops);
    }

    // 마커 렌더링
    function renderMarkers(shops) {
        markerList.forEach(m => m.setMap(null));
        markerList = [];
        
        const groups = {};
        shops.forEach(shop => {
            const key = parseFloat(shop.lat).toFixed(5) + "," + parseFloat(shop.lng).toFixed(5);
            if(!groups[key]) groups[key] = [];
            groups[key].push(shop);
        });

        for(const key in groups) {
            groups[key].sort((a, b) => {
                const dateA = a.updatedAt ? (a.updatedAt.seconds || 0) : 0;
                const dateB = b.updatedAt ? (b.updatedAt.seconds || 0) : 0;
                return dateB - dateA;
            });
            const marker = createMarker(map, groups[key], function(clickedList) {
                if (clickedList.length === 1) showPanel(clickedList[0]);
                else showSelectModal(clickedList);
            });
            if(marker) markerList.push(marker);
        }
    }

    // 필터 로직
    function filterShops(shops) {
        var theme = $('#mainThemeSelect').val();
        var region = $('#filterRegion').val();
        var category = $('#filterCategory').val();
        var purpose = $('#filterPurpose').val();
        var keywordInput = $('#keyword').val() || "";
        var keywords = keywordInput.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);

        return shops.filter(shop => {
            // 테마 필터 (선택된 값이 있고 ALL이 아니면 필터링)
            var matchTheme = true;
            if (theme && theme !== 'ALL') {
                if (!shop.themes || !shop.themes.includes(theme)) matchTheme = false;
            }

            var matchRegion = (region === "") || (shop.region === region);
            var shopCategories = Array.isArray(shop.category) ? shop.category : [shop.category];
            var matchCategory = (category === "") || shopCategories.includes(category);
            var shopPurposes = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose];
            var matchPurpose = (purpose === "") || shopPurposes.includes(purpose);
            
            var searchableText = (shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + shopCategories.join(" ")).toLowerCase();
            var matchKeyword = true;
            if (keywords.length > 0) {
                matchKeyword = keywords.every(term => searchableText.includes(term));
            }
            return matchTheme && matchRegion && matchCategory && matchPurpose && matchKeyword;
        });
    }

    // ==========================================
    // 4. 실행 및 이벤트 등록
    // ==========================================
    
    // 키워드 검색
    $('#keyword').on('keydown', function(e) {
        if (e.key === 'Enter') {
            const rawVal = $(this).val().trim();
            const query = rawVal.replace(/\s+/g, '').toLowerCase();
            if(!query) return;

            // 1. 랜드마크
            for (const key in LANDMARKS) {
                if (query.includes(key)) {
                    const coords = LANDMARKS[key];
                    map.setCenter(new naver.maps.LatLng(coords.lat, coords.lng));
                    map.setZoom(15);
                    $(this).blur(); return;
                }
            }

            // 2. 가게 이름
            const targetShop = allShops.find(shop => {
                if(!shop.name) return false;
                return shop.name.replace(/\s+/g, '').toLowerCase().includes(query);
            });
            if (targetShop && targetShop.lat && targetShop.lng) {
                map.morph(new naver.maps.LatLng(targetShop.lat, targetShop.lng), 17);
                $(this).blur(); return;
            }

            // 3. 주소
            searchAddressToCoordinate(rawVal);
            $(this).blur();
        }
    });

    function searchAddressToCoordinate(query, isRetry = false) {
        naver.maps.Service.geocode({ query: query }, function(status, response) {
            if (status === naver.maps.Service.Status.OK) {
                if (response.v2 && response.v2.addresses.length > 0) {
                    const item = response.v2.addresses[0];
                    map.setCenter(new naver.maps.Point(item.x, item.y));
                    map.setZoom(16);
                } else if (response.result && response.result.items.length > 0) {
                    const item = response.result.items[0];
                    map.setCenter(new naver.maps.Point(item.point.x, item.point.y));
                    map.setZoom(16);
                } else {
                    if(!isRetry && query.indexOf('대구') === -1) searchAddressToCoordinate("대구 " + query, true);
                    else alert("주소를 찾을 수 없습니다.");
                }
            } else {
                if(!isRetry && query.indexOf('대구') === -1) searchAddressToCoordinate("대구 " + query, true);
                else alert("검색 실패");
            }
        });
    }

    // 지도 멈춤 시 마커 갱신 (디바운싱)
    let idleTimer;
    naver.maps.Event.addListener(map, 'idle', function() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(updateVisibleMarkers, 150);
    });

    // 필터 변경 시 호출 (전역)
    window.applyAllFilters = function() { updateVisibleMarkers(); };

    // 🔥 최종 실행
    initTheme();      
    loadShopsData();  

    // 내 위치 이동
    window.moveToCurrentLocation = function() {
        map.refresh(); 
        if (!navigator.geolocation) { alert("위치 정보를 사용할 수 없습니다."); return; }
        const btnText = document.querySelector('.loc-text');
        if(btnText) btnText.innerText = "탐색중..";
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const loc = new naver.maps.LatLng(lat, lng);
            map.setCenter(loc); map.setZoom(16);
            setTimeout(() => { updateVisibleMarkers(); if(btnText) btnText.innerText = "내 주변"; }, 300);
            if (window.myLocationMarker) window.myLocationMarker.setMap(null);
            window.myLocationMarker = new naver.maps.Marker({
                position: loc, map: map,
                icon: { content: '<div style="width:16px;height:16px;background:#3498db;border:2px solid white;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', anchor: new naver.maps.Point(8, 8) }
            });
        }, () => { alert("위치 정보를 가져올 수 없습니다."); if(btnText) btnText.innerText = "내 주변"; });
    }

    // PWA 로직 (기존 유지)
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(err => console.log('서비스 워커 실패', err));
    let deferredPrompt; const installBtn = document.getElementById('installBtn'); const ua = navigator.userAgent.toLowerCase(); const isIos = /iphone|ipad|ipod/.test(ua); const isInApp = ua.includes('kakao') || ua.includes('instagram') || ua.includes('naver');
    if (isIos) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("📲 아이폰 설치 방법\n\n1. 사파리(Safari) 브라우저 하단 '공유' 버튼 클릭\n2. 메뉴를 내려서 '홈 화면에 추가' 선택\n3. 바탕화면에 '대구핫플여기' 앱 생성!")); } 
    else if (isInApp) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("🚫 현재 브라우저에서는 다운로드가 제한됩니다.\n\n우측 하단(또는 상단)의 [더보기 ···] 버튼을 누르고\n[다른 브라우저로 열기]를 선택해주세요!")); }
    else { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; }); installBtn.addEventListener('click', (e) => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') installBtn.style.display = 'none'; deferredPrompt = null; }); } else alert("이미 설치됨"); }); }
</script>
</body>
</html>