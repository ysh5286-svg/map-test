<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c0392b">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/maps/local_dining/materialicons/48dp/2x/baseline_local_dining_black_48dp.png">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">
    <meta property="og:title" content="ğŸ—ºï¸ ëŒ€êµ¬í•«í”Œì—¬ê¸° ë³´ë¬¼ì§€ë„">
    <meta property="og:description" content="ëŒ€êµ¬ ì°ë§›ì§‘ê³¼ í•«í”Œì„ í•œëˆˆì—!&#10;ì‹¤íŒ¨ ì—†ëŠ” ë§›ì§‘ ì§€ë„">
    <meta property="og:image" content="https://dazzlepeople.cafe24.com/bizdemo158475/component/board/board_1/u_image/4/546462826_Gemini_Generated_Image_ummtjlummtjlummt.jpg">
    <meta property="og:url" content="https://www.heredaegu.com">

    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=krsv42ftzf&submodules=geocoder"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
    /* ëª¨ë°”ì¼(í™”ë©´ ì¢ì„ ë•Œ)ì—ì„œë§Œ ì ìš©ë˜ëŠ” ê°•ì œ ìŠ¤íƒ€ì¼ */
    @media (max-width: 768px) {
        #userStatusCard {
            top: 240px !important; /* ê²€ìƒ‰ì°½ë³´ë‹¤ í›¨ì”¬ ì•„ë˜ë¡œ ë‚´ë¦¼ */
            left: 50% !important;
            right: auto !important;
            transform: translateX(-50%) !important; /* í™”ë©´ ì •ì¤‘ì•™ ë°°ì¹˜ */
            width: 90% !important; /* ë„“ê²Œ ì¡ê¸° */
            justify-content: center !important; /* ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
        }
    }
</style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>ğŸ’ ë³´ë¬¼ì§€ë„ë¥¼ í¼ì¹˜ëŠ” ì¤‘...</p>
    </div>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="theme-select-wrapper">
                <select id="mainThemeSelect" class="theme-select" onchange="applyAllFilters()">
                    <option value="ALL">ğŸ’ ì „ì²´ ë§›ì§‘ ë³´ê¸°</option>
                </select>
            </div>
            <div class="search-filters">
                <select id="filterRegion" class="search-select" onchange="applyAllFilters()">
                    <option value="">ğŸ“ ì§€ì—­ ì „ì²´</option><option value="ìˆ˜ì„±êµ¬">ìˆ˜ì„±êµ¬</option><option value="ì¤‘êµ¬">ì¤‘êµ¬</option><option value="ë™êµ¬">ë™êµ¬</option><option value="ì„œêµ¬">ì„œêµ¬</option><option value="ë‚¨êµ¬">ë‚¨êµ¬</option><option value="ë¶êµ¬">ë¶êµ¬</option><option value="ë‹¬ì„œêµ¬">ë‹¬ì„œêµ¬</option><option value="ë‹¬ì„±êµ°">ë‹¬ì„±êµ°</option><option value="êµ°ìœ„êµ°">êµ°ìœ„êµ°</option><option value="ì¹ ê³¡êµ°">ì¹ ê³¡êµ°</option><option value="ê²½ì‚°">ê²½ì‚°</option><option value="ì²­ë„">ì²­ë„</option><option value="ëŒ€êµ¬ ë°–">ëŒ€êµ¬ ë°–</option>
                </select>
                <select id="filterCategory" class="search-select" onchange="applyAllFilters()">
                    <option value="">ğŸœ ì—…ì¢… ì „ì²´</option><option value="í•œì‹">í•œì‹</option><option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ë¶„ì‹">ë¶„ì‹</option><option value="ê³ ê¸°/êµ¬ì´">ê³ ê¸°/êµ¬ì´</option><option value="íšŒ/í•´ì‚°ë¬¼">íšŒ/í•´ì‚°ë¬¼</option><option value="ì•„ì‹œì•ˆ">ì•„ì‹œì•ˆ</option><option value="ìˆ ì§‘">ìˆ ì§‘</option><option value="ì¹´í˜/ë””ì €íŠ¸">ì¹´í˜/ë””ì €íŠ¸</option><option value="ë¹µì§‘">ë¹µì§‘</option><option value="íŒ¨ìŠ¤íŠ¸í‘¸ë“œ">íŒ¨ìŠ¤íŠ¸í‘¸ë“œ</option><option value="í¬ì¥/ë°°ë‹¬">í¬ì¥/ë°°ë‹¬</option>
                </select>
                <select id="filterPurpose" class="search-select" onchange="applyAllFilters()">
                    <option value="">âœ¨ ë¶„ìœ„ê¸° ì „ì²´</option><option value="ë…¸í¬">ë…¸í¬</option><option value="ë°ì´íŠ¸">ë°ì´íŠ¸</option><option value="ë‹¨ì²´íšŒì‹">ë‹¨ì²´íšŒì‹</option><option value="í˜¼ë°¥/í˜¼ìˆ ">í˜¼ë°¥/í˜¼ìˆ </option><option value="ë¬´í•œë¦¬í•„">ë¬´í•œë¦¬í•„</option><option value="ì´ìƒ‰ë§›ì§‘">ì´ìƒ‰ë§›ì§‘</option><option value="ë·°ë§›ì§‘">ë·°ë§›ì§‘</option><option value="ìƒê²¬ë¡€">ìƒê²¬ë¡€</option><option value="ì•¼ê°„ì˜ì—…">ì•¼ê°„ì˜ì—…</option>
                </select>
            </div>
            <div class="search-input-row">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="keyword" class="search-input" placeholder="ì˜ˆ: ë™ì„±ë¡œ ë‘ë°”ì´" onchange="applyAllFilters()">
                <div class="search-filters">
    <button id="btnShowLikes" onclick="toggleLikeFilter()" style="background:white; border:1px solid #e74c3c; color:#e74c3c; border-radius:6px; padding:8px; font-size:13px; font-weight:bold; cursor:pointer; min-width:80px; display:flex; align-items:center; gap:4px;">
        ğŸ¤ ì°œë§Œ ë³´ê¸°
    </button>
</div>
            </div>
        </div>
    </div>

    <div id="userStatusCard" style="position: absolute; top: 150px; right: 10px; z-index: 90; display:flex; justify-content: flex-end; width: auto;">
        <button id="btnLogin" onclick="googleLogin()" style="background:white; border:1px solid #ddd; padding:8px 12px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; display:flex; align-items:center; gap:5px; color:#444;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> 
            êµ¬ê¸€ ë¡œê·¸ì¸
        </button>

        <div id="myProfile" style="display:none; background:white; border:1px solid #3498db; padding:6px 12px; border-radius:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); align-items:center; gap:8px;">
            <span id="userLevelBadge" style="background:#3498db; color:white; font-size:11px; padding:2px 6px; border-radius:10px; font-weight:bold;">LV.1</span>
            <span id="userName" style="font-size:13px; font-weight:bold; color:#333;">í™ê¸¸ë™</span>
            <button onclick="googleLogout()" style="border:none; background:#f1f3f5; color:#555; font-size:11px; padding:4px 8px; border-radius:4px; cursor:pointer; margin-left:5px; font-weight:bold;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="faqPanel" class="faq-panel">
        <div class="faq-header"><h3>ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h3><button class="faq-close" onclick="toggleFaq()">âœ•</button></div>
        <div class="faq-body">
            <div class="faq-item"><div class="faq-q">Q. 'ëŒ€êµ¬ë³´ë¬¼ì§€ë„'ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</div><div class="faq-a">ëŒ€êµ¬ ì°ë§›ì§‘ ì •ë³´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div></div>
            <div class="faq-item"><div class="faq-q">Q. ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì„ ì •ë˜ë‚˜ìš”?</div><div class="faq-a">'ëŒ€êµ¬ ì°ë§›ì§‘ í‰ê°€ë‹¨'ì´ ì§ì ‘ ê²€ì¦í•˜ê³  ì—„ì„ í•œ ë¡œì»¬ ì°ë§›ì§‘ & í•«í”Œë§Œ ëª¨ì•˜ìŠµë‹ˆë‹¤.</div></div>
            <div class="faq-item"><div class="faq-q">Q. ìš°ë¦¬ ê°€ê²Œë„ ë“±ë¡í•˜ê³  ì‹¶ì–´ìš”!</div><div class="faq-a">ì˜¤í”ˆì±„íŒ… [ëŒ€êµ¬ ì°ë§›ì§‘ ì†Œí†µë°©]ì—ì„œ ìš”ì²­í•´ì£¼ì„¸ìš”.</div></div>
            <div class="faq-item">
                <div class="faq-q">ğŸ† ë ˆë²¨ì€ ì–´ë–»ê²Œ ì˜¬ë¦¬ë‚˜ìš”?</div>
                <div class="faq-a">
                    ê°€ê²Œì— ë„ì°©í•´ì„œ <b>[ğŸ“ ì—¬ê¸° ì™”ì–´ìš”! (GPS ì¸ì¦)]</b> ë²„íŠ¼ë§Œ ëˆ„ë¥´ë©´ ë!<br>
                    (ë°©ë¬¸ 1íšŒ = ê²½í—˜ì¹˜ 10ì  íšë“ ğŸ)
                    
                    <div class="level-box" style="margin-top:10px; background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #eee;">
                        <div class="lv-row"><span class="lv-badge lv1">LV.1</span> ê°€ì… ì¦‰ì‹œ (ë°°ê³ í”ˆ ì˜í˜¼)</div>
                        <div class="lv-row"><span class="lv-badge lv2">LV.2</span> ë°©ë¬¸ 5íšŒ (ì„œíˆ° ë¯¸ì‹ê°€)</div> <div class="lv-row"><span class="lv-badge lv3">LV.3</span> ë°©ë¬¸ 10íšŒ (ëŒ€êµ¬ì˜ ì•„ë“¤)</div>
                        <div class="lv-row"><span class="lv-badge lv4">LV.4</span> ë°©ë¬¸ 30íšŒ (ë§›ì˜ ì§€ë°°ì)</div>
                    </div>
                    <p style="font-size:11px; color:#888; margin-top:5px;">â€» ë§Œë ™ ë‹¬ì„± ì‹œ 'ë‹¤ì¦í”¼í”Œ' ì‹œí¬ë¦¿ íŒŒí‹° ì´ˆëŒ€ê¶Œ ì¦ì •!</p>
                </div>
            </div>
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="https://open.kakao.com/o/gaV5kk8h" target="_blank" class="panel-btn" style="background:#fee500; color:#3c1e1e;">ğŸ’¬ ëŒ€êµ¬ê²½ë¶ ì°ë§›ì§‘ ì†Œí†µë°©</a>
                <button onclick="openGameModal()" class="panel-btn" style="background:#2c3e50;">ğŸ® ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</button>
                <a href="https://litt.ly/dazzlepeople" target="_blank" class="panel-btn" style="background:#e1306c;">ğŸ“± SNS êµ¬ê²½ê°€ê¸°</a>
            </div>
        </div>

        <div style="padding: 0 20px 10px 20px;">
            <button id="installBtn" class="panel-btn" style="display:none; background:#3498db; color:white; font-size:15px; box-shadow:0 4px 6px rgba(52, 152, 219, 0.3);">
                â¬‡ï¸ ëŒ€êµ¬ë³´ë¬¼ì§€ë„ ì•± ì„¤ì¹˜í•˜ê¸°
            </button>
        </div>

        <div class="faq-footer">
            <div class="company-box">
                <strong>ë‹¤ì¦í”¼í”Œ (ëŒ€í‘œ: ìœ¤ì„±í˜¸)</strong><br>
                ì‚¬ì—…ìë²ˆí˜¸: 535-25-01793<br>
                ì£¼ì†Œ: ëŒ€êµ¬ê´‘ì—­ì‹œ ë™êµ¬ ì†¡ë¼ë¡œ16ê¸¸ 42
            </div>
        </div>
    </div>

    <div id="selectModal" class="modal-overlay">
        <div class="modal-box">
            <button class="modal-close-x" onclick="closeSelectModal()">Ã—</button>
            <h3 class="modal-title" style="font-size:16px; margin-bottom:15px;">ğŸ‘‡ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
            <div id="selectList" class="shop-select-list"></div>
        </div>
    </div>

<div id="profileModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center; max-width:350px;">
            <button class="modal-close-x" onclick="closeProfileModal()">Ã—</button>
            
            <div style="margin-top:10px; margin-bottom:20px;">
                <div style="font-size:50px;">ğŸ˜</div> <h3 id="pName" style="margin:10px 0 5px 0; font-size:20px;">í™ê¸¸ë™</h3>
                <span id="pLevelBadge" style="background:#3498db; color:white; padding:3px 8px; border-radius:12px; font-size:12px; font-weight:bold;">LV.1 ë°°ê³ í”ˆ ì˜í˜¼</span>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:20px; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:13px; font-weight:bold; color:#555;">
                    <span>ğŸ† í˜„ì¬ ê²½í—˜ì¹˜</span>
                    <span id="pExpText" style="color:#e74c3c;">0 / 10</span>
                </div>
                <div style="width:100%; background:#ddd; height:10px; border-radius:5px; overflow:hidden;">
                    <div id="pExpBar" style="width:0%; background:linear-gradient(90deg, #f1c40f, #e67e22); height:100%; transition:width 0.5s;"></div>
                </div>
                <p style="font-size:11px; color:#888; margin-top:8px;">â€» ë§›ì§‘ 1ê³³ ë°©ë¬¸ ì‹œ ê²½í—˜ì¹˜ +10 íšë“!</p>
            </div>

            <div style="border:1px dashed #aaa; padding:12px; border-radius:8px; background:#fff; margin-bottom:20px;">
                <p style="font-size:12px; color:#666; margin:0 0 5px 0;">ğŸ‘‘ ì‚¬ì¥ë‹˜ ì—°ê²°ìš© ê³ ìœ  ID (UID)</p>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="text" id="pUid" readonly style="flex:1; background:#eee; border:none; padding:8px; border-radius:4px; font-size:11px; font-family:monospace; text-align:center; color:#333;">
                    <button onclick="copyUidInModal()" style="background:#2c3e50; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer; font-weight:bold;">ë³µì‚¬</button>
                </div>
            </div>

            <button onclick="googleLogout()" style="width:100%; padding:12px; background:#e74c3c; color:white; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer;">
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <div id="gameModal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; padding:0;">
            <button class="modal-close-x" style="z-index:10; top:10px; right:10px;" onclick="closeGameModal()">Ã—</button>
            
            <div class="game-container" style="padding:25px;">
                <div id="gameMain">
                    <div class="game-title">ğŸ½ï¸ ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</div>
                    <div class="game-selection">
                        <div class="game-card" onclick="startWorldCupGame()">
                            <span class="game-icon">ğŸ†</span>
                            <span class="game-name">ìŒì‹ ì›”ë“œì»µ</span>
                            <span class="game-desc">í† ë„ˆë¨¼íŠ¸ë¡œ<br>ì‹ ì¤‘í•˜ê²Œ!</span>
                        </div>
                        <div class="game-card" onclick="startRouletteGame()">
                            <span class="game-icon">ğŸ¡</span>
                            <span class="game-name">ëœë¤ ëŒë¦¼íŒ</span>
                            <span class="game-desc">ìš´ëª…ì—<br>ë§¡ê²¨ìš”!</span>
                        </div>
                    </div>
                </div>

                <div id="wcGame" class="wc-container">
                    <div class="wc-round-badge" id="wcRoundBadge">16ê°•</div>
                    <div class="wc-vs-box">
                        <div class="wc-card" onclick="wcChoose(0)"><div id="wcImgLeft" class="wc-img"></div><div id="wcNameLeft" class="wc-name"></div></div>
                        <div style="font-weight:bold; color:#e74c3c; font-style:italic;">VS</div>
                        <div class="wc-card" onclick="wcChoose(1)"><div id="wcImgRight" class="wc-img"></div><div id="wcNameRight" class="wc-name"></div></div>
                    </div>
                    <button onclick="resetGame()" style="font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">ì²˜ìŒìœ¼ë¡œ</button>
                </div>

                <div id="wcResult" class="hidden" style="text-align:center;">
                    <div style="font-size:12px; font-weight:bold; color:#888; margin-bottom:10px;">ğŸ‘‘ ìµœí›„ì˜ ìŠ¹ì ğŸ‘‘</div>
                    <div id="wcWinnerImg" style="font-size:80px; margin-bottom:10px;"></div>
                    <div id="wcWinnerName" style="font-size:24px; font-weight:bold; color:#3498db; margin-bottom:20px;"></div>
                    <button onclick="resetGame()" class="spin-btn" style="background:#333;">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>

                <div id="rouletteGame" class="roulette-container">
                    <div class="roulette-mode-btns">
                        <button onclick="setRouletteMode('lunch')" id="btn-lunch" class="roulette-btn active">ì ì‹¬</button>
                        <button onclick="setRouletteMode('dinner')" id="btn-dinner" class="roulette-btn">ì €ë…</button>
                        <button onclick="setRouletteMode('weekend')" id="btn-weekend" class="roulette-btn">ì£¼ë§</button>
                        <button onclick="setRouletteMode('custom')" id="btn-custom" class="roulette-btn" style="color:#3498db; border-color:#3498db;">ë‚´ë§˜ëŒ€ë¡œ</button>
                    </div>
                    <div id="customInputArea" class="custom-input-box">
                        <div class="custom-input-row">
                            <input type="text" id="customItemInput" class="custom-input" placeholder="ë©”ë‰´ ì…ë ¥" onkeypress="if(event.key==='Enter') addCustomItem()">
                            <button onclick="addCustomItem()" class="custom-add-btn">ì¶”ê°€</button>
                        </div>
                        <div id="customItemList" class="custom-list"></div>
                    </div>
                    <div class="roulette-canvas-box"><canvas id="rouletteCanvas" width="560" height="560" class="roulette-canvas"></canvas><div class="roulette-arrow">â–¼</div></div>
                    <button id="spinBtn" class="spin-btn" onclick="spinRoulette()">ëŒë ¤ ëŒë ¤! START</button>
                    <button onclick="resetGame()" style="margin-top:10px; font-size:12px; color:#999; border:none; background:none; text-decoration:underline; cursor:pointer;">ì²˜ìŒìœ¼ë¡œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="infoPanel" class="info-panel">
        <div class="panel-header" id="panelHeader">
            <button class="panel-close" onclick="closePanel()">âœ•</button>
        </div>
        <div class="panel-body">
            <div>
                <h2 class="panel-title" id="panelTitle">ê°€ê²Œ ì´ë¦„</h2>
                <div class="panel-meta" id="panelMeta"></div>
            </div>

            <div class="rating-box">
                <div class="rating-top">
                    <span class="total-star">â­</span>
                    <div class="total-score" id="panelTotal">0.0</div>
                </div>
                <div class="review-text" id="panelReview">
                    ğŸ—¨ï¸ "ì‚¬ì¥ë‹˜ì˜ ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
                </div>
            </div>

            <div class="info-row"><span class="info-label">ë©”ë‰´</span> <span class="info-text" id="panelMenu"></span></div>
            <div class="info-row"><span class="info-label">ì£¼ì†Œ</span> <span class="info-text" id="panelAddr"></span></div>
            
            <a href="#" id="panelLink" target="_blank" class="panel-btn">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°</a>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="bottom-left">
            <button class="bar-btn btn-usage" onclick="toggleFaq()">ğŸ“– ì‚¬ìš©ë²•</button>
            <a href="https://www.dazzlepeople.com" target="_blank" class="footer-copyright" style="margin-left:10px;">Â© Dazzle People</a>
        </div>
        <div class="bottom-center">
            <button class="btn-location-mode" onclick="moveToCurrentLocation()">
                <div class="loc-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <span class="loc-text">ë‚´ ì£¼ë³€</span>
            </button>
        </div>
        <div class="bottom-right">
        </div>
    </div>

    <div id="map"></div>

    <script>
        function toggleFaq() { document.getElementById('faqPanel').classList.toggle('show'); }
        function closePanel() { document.getElementById('infoPanel').classList.remove('show'); }
        function closeSelectModal() { document.getElementById('selectModal').classList.remove('show'); }
        function openGameModal() { resetGame(); document.getElementById('gameModal').classList.add('show'); document.getElementById('faqPanel').classList.remove('show'); }
        function closeGameModal() { document.getElementById('gameModal').classList.remove('show'); }
        
        // ê²Œì„ ë°ì´í„° ë° ë¡œì§
        const foodData = {
            lunch: [{name:"ê¹€ì¹˜ì°Œê°œ",img:"ğŸ¥˜"},{name:"ëˆê¹ŒìŠ¤",img:"ğŸ›"},{name:"ì œìœ¡ë³¶ìŒ",img:"ğŸ¥©"},{name:"ìˆœëŒ€êµ­ë°¥",img:"ğŸš"},{name:"í–„ë²„ê±°",img:"ğŸ”"},{name:"ì§œì¥ë©´",img:"ğŸ¥¢"},{name:"ì§¬ë½•",img:"ğŸœ"},{name:"ì¹¼êµ­ìˆ˜",img:"ğŸ²"},{name:"ê¹€ë°¥/ë¼ë©´",img:"ğŸ™"},{name:"ë¹„ë¹”ë°¥",img:"ğŸ¥—"},{name:"ë¶€ëŒ€ì°Œê°œ",img:"ğŸ¥˜"},{name:"ê°€ì •ì‹ë°±ë°˜",img:"ğŸ±"},{name:"ìŒ€êµ­ìˆ˜",img:"ğŸœ"},{name:"ìƒŒë“œìœ„ì¹˜",img:"ğŸ¥ª"},{name:"í¸ì˜ì ",img:"ğŸª"},{name:"ìƒëŸ¬ë“œ",img:"ğŸ¥—"}],
            dinner: [{name:"ì‚¼ê²¹ì‚´",img:"ğŸ¥“"},{name:"ì¹˜í‚¨",img:"ğŸ—"},{name:"ê³±ì°½/ëŒ€ì°½",img:"ğŸ”¥"},{name:"íšŒ/ì‚¬ì‹œë¯¸",img:"ğŸŸ"},{name:"ì¡±ë°œ/ë³´ìŒˆ",img:"ğŸ–"},{name:"ë§ˆë¼íƒ•",img:"ğŸŒ¶ï¸"},{name:"ì–‘ê¼¬ì¹˜",img:"ğŸ¡"},{name:"í”¼ì",img:"ğŸ•"},{name:"ë‹­ë°œ",img:"ğŸ”¥"},{name:"ì°œë‹­",img:"ğŸ¥˜"},{name:"ê°ˆë¹„",img:"ğŸ¥©"},{name:"ê°ìíƒ•",img:"ğŸ¥˜"},{name:"ì´ìì¹´ì•¼",img:"ğŸ¶"},{name:"íŒŒìŠ¤íƒ€",img:"ğŸ"},{name:"ìŠ¤í…Œì´í¬",img:"ğŸ¥©"},{name:"ì˜¤ëŒë¼ˆ",img:"ğŸ–"}],
            weekend: [{name:"ë¸ŒëŸ°ì¹˜",img:"ğŸ¥"},{name:"ìƒ¤ë¸Œìƒ¤ë¸Œ",img:"ğŸ²"},{name:"ë°°ë‹¬ì¹˜í‚¨",img:"ğŸ—"},{name:"í”¼ìíŒŒí‹°",img:"ğŸ•"},{name:"ì§œíŒŒê²Œí‹°",img:"ğŸœ"},{name:"ë·”í˜",img:"ğŸ½ï¸"},{name:"ì†Œê³ ê¸°",img:"ğŸ¥©"},{name:"í•´ë¬¼ì°œ",img:"ğŸ™"},{name:"ì§‘ë°¥",img:"ğŸš"},{name:"í¸ì˜ì í„¸ê¸°",img:"ğŸ«"},{name:"íƒ€ì½”/ì´ìƒ‰",img:"ğŸŒ®"},{name:"ëƒ‰ì¥ê³ íŒŒë¨¹ê¸°",img:"ğŸ§Š"},{name:"ë§ˆë¼íƒ•",img:"ğŸŒ¶ï¸"},{name:"ì¡±ë°œ/ë³´ìŒˆ",img:"ğŸ–"},{name:"ì¤‘êµ­ì§‘",img:"ğŸ¥¢"},{name:"ì¹´í˜/ë””ì €íŠ¸",img:"ğŸ°"}]
        };
        let currentFoods=[],wcCurrentRound=[],wcNextRound=[],wcIndex=0,customFoods=["ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡"],rCanvas,rCtx,rCurrentRotation=0,isSpinning=false;
        const colors=["#FF9AA2","#FFB7B2","#FFDAC1","#E2F0CB","#B5EAD7","#C7CEEA","#93C5FD","#A78BFA","#FCA5A5","#FDBA74","#FDE047","#86EFAC"];
        function resetGame(){ document.getElementById('gameMain').classList.remove('hidden'); document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.add('hidden'); document.getElementById('rouletteGame').style.display='none'; }
        function startWorldCupGame(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('wcGame').style.display='flex'; const all=[...foodData.lunch,...foodData.dinner,...foodData.weekend]; const uniq=all.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i); uniq.sort(()=>Math.random()-0.5); wcCurrentRound=uniq.slice(0,16); wcNextRound=[]; wcIndex=0; updateWcMatch(); }
        function updateWcMatch(){ if(wcIndex>=wcCurrentRound.length/2){ wcCurrentRound=[...wcNextRound]; wcNextRound=[]; wcIndex=0; wcCurrentRound.sort(()=>Math.random()-0.5); } if(wcCurrentRound.length===1){ showWcWinner(wcCurrentRound[0]); return; } document.getElementById('wcRoundBadge').innerText=wcCurrentRound.length===2?"ê²°ìŠ¹":wcCurrentRound.length+"ê°•"; const l=wcCurrentRound[wcIndex*2],r=wcCurrentRound[wcIndex*2+1]; document.getElementById('wcImgLeft').innerText=l.img; document.getElementById('wcNameLeft').innerText=l.name; document.getElementById('wcImgRight').innerText=r.img; document.getElementById('wcNameRight').innerText=r.name; }
        window.wcChoose=function(s){ wcNextRound.push(wcCurrentRound[wcIndex*2+s]); wcIndex++; updateWcMatch(); }
        function showWcWinner(w){ document.getElementById('wcGame').style.display='none'; document.getElementById('wcResult').classList.remove('hidden'); document.getElementById('wcWinnerImg').innerText=w.img; document.getElementById('wcWinnerName').innerText=w.name; fireConfetti(); }
        window.startRouletteGame=function(){ document.getElementById('gameMain').classList.add('hidden'); document.getElementById('rouletteGame').style.display='flex'; initRoulette(); setRouletteMode('lunch'); }
        function initRoulette(){ rCanvas=document.getElementById('rouletteCanvas'); rCtx=rCanvas.getContext('2d'); }
        window.setRouletteMode=function(m){ if(isSpinning)return; document.querySelectorAll('.roulette-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); if(m==='custom'){ currentFoods=[...customFoods]; document.getElementById('customInputArea').style.display='block'; renderCustomItems(); }else{ currentFoods=foodData[m].map(i=>i.name); document.getElementById('customInputArea').style.display='none'; } drawRoulette(); }
        window.addCustomItem=function(){ const v=document.getElementById('customItemInput').value.trim(); if(v){ customFoods.push(v); currentFoods=[...customFoods]; document.getElementById('customItemInput').value=''; renderCustomItems(); drawRoulette(); } }
        window.removeCustomItem=function(i){ customFoods.splice(i,1); currentFoods=[...customFoods]; renderCustomItems(); drawRoulette(); }
        function renderCustomItems(){ document.getElementById('customItemList').innerHTML=customFoods.map((t,i)=>`<span class="custom-tag">${t} <span class="custom-tag-del" onclick="removeCustomItem(${i})">Ã—</span></span>`).join(''); }
        function drawRoulette(){ if(!rCanvas)return; const n=currentFoods.length; if(n===0){ rCtx.clearRect(0,0,rCanvas.width,rCanvas.height); return; } const arc=(2*Math.PI)/n,dpr=window.devicePixelRatio||1,rect=rCanvas.getBoundingClientRect(); rCanvas.width=rect.width*dpr; rCanvas.height=rect.height*dpr; rCtx.scale(dpr,dpr); const r=rect.width/2; rCtx.clearRect(0,0,rect.width,rect.height); for(let i=0;i<n;i++){ const a=i*arc-Math.PI/2; rCtx.beginPath(); rCtx.moveTo(r,r); rCtx.arc(r,r,r,a,a+arc); rCtx.fillStyle=colors[i%colors.length]; rCtx.fill(); rCtx.stroke(); rCtx.save(); rCtx.translate(r,r); rCtx.rotate(a+arc/2); rCtx.textAlign="right"; rCtx.fillStyle="#333"; const fs=Math.max(12,Math.min(24,200/n)); rCtx.font=`bold ${fs}px 'Noto Sans KR'`; rCtx.fillText(currentFoods[i],r-20,5); rCtx.restore(); } }
        window.spinRoulette=function(){ if(isSpinning)return; if(currentFoods.length<2){ alert("ë©”ë‰´ 2ê°œ ì´ìƒ í•„ìš”!"); return; } isSpinning=true; document.getElementById('spinBtn').innerText="...DoRoRo..."; const r=Math.floor(Math.random()*360); rCurrentRotation+=(360*5+r); rCanvas.style.transition="transform 4s cubic-bezier(0.25,0.1,0.25,1)"; rCanvas.style.transform=`rotate(${rCurrentRotation}deg)`; setTimeout(()=>{ isSpinning=false; document.getElementById('spinBtn').innerText="ëŒë ¤ ëŒë ¤! START"; fireConfetti(); },4000); }
        function fireConfetti(){ const c=['#f00','#0f0','#00f','#ff0','#0ff']; for(let i=0;i<50;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw'; d.style.top='-10px'; d.style.backgroundColor=c[Math.floor(Math.random()*c.length)]; d.style.animationDuration=(Math.random()*2+2)+'s'; document.body.appendChild(d); setTimeout(()=>d.remove(),4000); } }

        // ìƒì„¸ ì •ë³´ íŒ¨ë„ í‘œì‹œ
        window.showPanel = function(shop) {
            document.getElementById('panelTitle').innerText = shop.name;
            const score = shop.totalScore || "0.0";
            document.getElementById('panelTotal').innerHTML = `${score}<span class="total-max"> / 5.0</span>`;
            document.getElementById('panelMenu').innerText = shop.menu || "-";
            document.getElementById('panelAddr').innerText = shop.address || "-";
            const reviewHtml = shop.desc ? `ğŸ—¨ï¸ "${shop.desc}"` : `ğŸ—¨ï¸ "ì•„ì§ ë“±ë¡ëœ í•œì¤„í‰ì´ ì—†ì–´ìš”."`;
            document.getElementById('panelReview').innerHTML = reviewHtml;
            const metaBox = document.getElementById('panelMeta');
            let metaHtml = '';
            if(shop.category) (Array.isArray(shop.category) ? shop.category : [shop.category]).forEach(c => metaHtml += `<span class="panel-tag">#${c}</span>`);
            if(shop.purpose) (Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose]).forEach(p => metaHtml += `<span class="panel-tag">#${p}</span>`);
            metaBox.innerHTML = metaHtml;
            const header = document.getElementById('panelHeader');
            if (shop.imageUrl) { header.style.backgroundImage = `url('${shop.imageUrl}')`; } 
            else { header.style.backgroundImage = 'none'; header.style.backgroundColor = '#ddd'; }
            let parkingBadge = '';
            if (shop.parking) { parkingBadge = `<div class="parking-badge">${shop.parking}</div>`; }
            header.innerHTML = `<button class="panel-close" onclick="closePanel()">âœ•</button>${parkingBadge}`;
            const btnLink = document.getElementById('panelLink');
            if (shop.link) { btnLink.href = shop.link; btnLink.style.display = 'block'; btnLink.innerText = 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°'; } 
            else { btnLink.href = '#'; btnLink.style.display = 'none'; }
            document.getElementById('faqPanel').classList.remove('show');
            document.getElementById('selectModal').classList.remove('show');
            document.getElementById('infoPanel').classList.add('show');
        }
    </script>

    <script type="module">
        import { db, initMap, createMarker, auth, googleProvider, signInWithPopup, signOut, onAuthStateChanged } from "./common.js";
    // ğŸ”¥ [ìˆ˜ì •ë¨] arrayUnion, arrayRemove ì¶”ê°€ë¨ (ì¢‹ì•„ìš” ê¸°ëŠ¥ìš©)
    import { collection, getDocs, doc, getDoc, setDoc, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    var map = initMap();
    let allShops = [];
    let markerList = [];
    const CACHE_KEY = "dazzle_shops_data_v1"; 

    // ë¦¬ì‚¬ì´ì¦ˆ ë””ë°”ìš´ì‹±
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { map.refresh(); updateVisibleMarkers(); }, 100);
    });

    // ëœë“œë§ˆí¬
    const LANDMARKS = {
        "íŒ”ê³µì‚°": { lat: 35.9899, lng: 128.6961 }, "ê°“ë°”ìœ„": { lat: 35.9758, lng: 128.7694 },
        "ë°˜ì›”ë‹¹": { lat: 35.8644, lng: 128.5933 }, "ë™ì„±ë¡œ": { lat: 35.8710, lng: 128.5960 },
        "ìˆ˜ì„±ëª»": { lat: 35.8280, lng: 128.6170 }, "ì´ì›”ë“œ": { lat: 35.8530, lng: 128.5630 },
        "83íƒ€ì›Œ": { lat: 35.8530, lng: 128.5630 }, "ë‘ë¥˜ê³µì›": { lat: 35.8475, lng: 128.5583 },
        "ë™ëŒ€êµ¬ì—­": { lat: 35.8770, lng: 128.6285 }, "ëŒ€êµ¬ì—­": { lat: 35.8764, lng: 128.5960 },
        "ì„œë¬¸ì‹œì¥": { lat: 35.8690, lng: 128.5815 }, "ê¹€ê´‘ì„ê±°ë¦¬": { lat: 35.8603, lng: 128.6080 },
        "ì•ì‚°": { lat: 35.8335, lng: 128.5810 }, "ê°•ì •ë³´": { lat: 35.8430, lng: 128.4690 },
        "ë””ì•„í¬": { lat: 35.8430, lng: 128.4690 }, "ì‚¼ì„±ë¼ì´ì˜¨ì¦ˆíŒŒí¬": { lat: 35.8411, lng: 128.6817 },
        "ë¼íŒ": { lat: 35.8411, lng: 128.6817 }, "ëŒ€êµ¬ê³µí•­": { lat: 35.8970, lng: 128.6440 },
        "ê²½ë¶ëŒ€": { lat: 35.8906, lng: 128.6121 }, "ê³„ëª…ëŒ€": { lat: 35.8535, lng: 128.4860 },
        "ì˜ë‚¨ëŒ€": { lat: 35.8306, lng: 128.7562 }
    };

    naver.maps.Event.addListener(map, "click", function() {
        closePanel(); document.getElementById('faqPanel').classList.remove('show');
    });

    async function loadShopsData() {
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_KEY + "_time");
        const now = new Date().getTime();
        let isCacheUsed = false;
        if (cachedData && cachedTime) {
            try {
                const parsed = JSON.parse(cachedData);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    allShops = parsed;
                    checkAndRender("ìºì‹œë¡œë“œ");
                    document.getElementById('loadingOverlay').classList.add('fade-out');
                    isCacheUsed = true;
                }
            } catch (err) { console.warn("ìºì‹œ íŒŒì‹± ì˜¤ë¥˜"); }
        }
        if(db) {
            try {
                const snapshot = await getDocs(collection(db, "shops"));
                const newShops = [];
                snapshot.forEach((doc) => newShops.push({ id: doc.id, ...doc.data() }));
                if (newShops.length > 0 && JSON.stringify(newShops) !== cachedData) {
                    allShops = newShops;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allShops));
                    localStorage.setItem(CACHE_KEY + "_time", now);
                    checkAndRender("DBì—…ë°ì´íŠ¸");
                    if(!isCacheUsed) document.getElementById('loadingOverlay').classList.add('fade-out');
                }
            } catch (e) {
                console.error("DB ë¡œë”© ì‹¤íŒ¨:", e);
                if(!isCacheUsed) document.getElementById('loadingOverlay').classList.add('fade-out');
            }
        }
    }

    async function initTheme() {
        const select = document.getElementById('mainThemeSelect');
        try {
            const docRef = doc(db, "meta", "themes");
            const docSnap = await getDoc(docRef);
            select.innerHTML = ''; 
            if (docSnap.exists()) {
                let list = docSnap.data().list || [];
                list.sort();
                list.forEach((t) => {
                    const opt = document.createElement('option'); opt.value = t; opt.innerText = `ğŸš© ${t}`; select.appendChild(opt);
                });
                if (list.length > 0) select.value = list[0];
            }
            const allOpt = document.createElement('option'); allOpt.value = "ALL"; allOpt.innerText = "ğŸ“‚ ì „ì²´ ë§›ì§‘ ë³´ê¸°"; select.appendChild(allOpt); 
            if (select.options.length === 1) select.value = "ALL";
        } catch(e) {
            if(select.options.length === 0) {
                const allOpt = document.createElement('option'); allOpt.value = "ALL"; allOpt.innerText = "ğŸ“‚ ì „ì²´ ë§›ì§‘ ë³´ê¸°"; select.appendChild(allOpt); select.value = "ALL";
            }
        } finally {
            checkAndRender("í…Œë§ˆë¡œë”©ì™„ë£Œ");
        }
    }

    function checkAndRender(source) {
        if (!allShops || allShops.length === 0) return;
        const bounds = map.getBounds();
        if (!bounds || !(bounds instanceof naver.maps.LatLngBounds)) {
            setTimeout(() => checkAndRender(source), 200); return;
        }
        updateVisibleMarkers();
    }

    function updateVisibleMarkers() {
        if (!map) return;
        const bounds = map.getBounds();
        if (!bounds) return; 
        const filtered = filterShops(allShops);
        const visibleShops = filtered.filter(shop => {
            if(!shop.lat || !shop.lng) return false;
            const pos = new naver.maps.LatLng(shop.lat, shop.lng);
            return bounds.hasLatLng(pos);
        });
        renderMarkers(visibleShops);
    }

    function renderMarkers(shops) {
        markerList.forEach(m => m.setMap(null));
        markerList = [];
        const groups = {};
        shops.forEach(shop => {
            const key = parseFloat(shop.lat).toFixed(5) + "," + parseFloat(shop.lng).toFixed(5);
            if(!groups[key]) groups[key] = [];
            groups[key].push(shop);
        });
        for(const key in groups) {
            groups[key].sort((a, b) => {
                // 1ìˆœìœ„: ì¢‹ì•„ìš” ë§ì€ ìˆœ, 2ìˆœìœ„: ìµœì‹ ìˆœ
                const likeA = (a.likedBy || []).length;
                const likeB = (b.likedBy || []).length;
                if(likeB !== likeA) return likeB - likeA;
                return (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0);
            });
            const marker = createMarker(map, groups[key], function(clickedList) {
                if (clickedList.length === 1) showPanel(clickedList[0]);
                else showSelectModal(clickedList);
            });
            if(marker) markerList.push(marker);
        }
    }

// ì „ì—­ ë³€ìˆ˜ë¡œ ì°œ í•„í„° ìƒíƒœ ê´€ë¦¬
    let isLikeFilterOn = false;

    // 1. ì°œ í•„í„° ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    window.toggleLikeFilter = function() {
        const user = auth.currentUser;
        if(!user) return alert("ë¡œê·¸ì¸í•œ ìœ ì €ë§Œ ì“¸ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤! ğŸ˜…");

        isLikeFilterOn = !isLikeFilterOn; // ì¼œê¸°/ë„ê¸° í† ê¸€
        
        const btn = document.getElementById('btnShowLikes');
        if(isLikeFilterOn) {
            btn.style.background = "#e74c3c";
            btn.style.color = "white";
            btn.innerHTML = "â¤ï¸ ì „ì²´ ë³´ê¸°";
            alert("ë‚´ê°€ ì°œí•œ ë§›ì§‘ë§Œ ì§€ë„ì— ë‚¨ê¹ë‹ˆë‹¤!");
        } else {
            btn.style.background = "white";
            btn.style.color = "#e74c3c";
            btn.innerHTML = "ğŸ¤ ì°œë§Œ ë³´ê¸°";
        }
        updateVisibleMarkers(); // ì§€ë„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // 2. í•„í„° ë¡œì§ (ìˆ˜ì •ë¨)
    function filterShops(shops) {
        var theme = $('#mainThemeSelect').val();
        var region = $('#filterRegion').val();
        var category = $('#filterCategory').val();
        var purpose = $('#filterPurpose').val();
        var keywordInput = $('#keyword').val() || "";
        var keywords = keywordInput.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
        
        // ğŸ”¥ [ì¶”ê°€ë¨] ë¡œê·¸ì¸ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const user = auth.currentUser;

        return shops.filter(shop => {
            // 1. ì°œ í•„í„°ê°€ ì¼œì ¸ìˆìœ¼ë©´, ë‚´ ì•„ì´ë””ê°€ likedByì— ìˆëŠ”ì§€ í™•ì¸
            if (isLikeFilterOn) {
                if (!user || !shop.likedBy || !shop.likedBy.includes(user.uid)) {
                    return false; // íƒˆë½ (ìˆ¨ê¹€)
                }
            }

            // (ê¸°ì¡´ í•„í„° ë¡œì§ë“¤...)
            var matchTheme = true;
            if (theme && theme !== 'ALL') { if (!shop.themes || !shop.themes.includes(theme)) matchTheme = false; }
            var matchRegion = (region === "") || (shop.region === region);
            var shopCategories = Array.isArray(shop.category) ? shop.category : [shop.category];
            var matchCategory = (category === "") || shopCategories.includes(category);
            var shopPurposes = Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose];
            var matchPurpose = (purpose === "") || shopPurposes.includes(purpose);
            var searchableText = (shop.name + " " + (shop.menu || "") + " " + (shop.area || "") + " " + (shop.address || "") + " " + shopCategories.join(" ")).toLowerCase();
            var matchKeyword = true;
            if (keywords.length > 0) { matchKeyword = keywords.every(term => searchableText.includes(term)); }
            
            return matchTheme && matchRegion && matchCategory && matchPurpose && matchKeyword;
        });
    }

    $('#keyword').on('keydown', function(e) {
        if (e.key === 'Enter') {
            const rawVal = $(this).val().trim();
            const query = rawVal.replace(/\s+/g, '').toLowerCase();
            if(!query) return;
            for (const key in LANDMARKS) {
                if (query.includes(key)) {
                    const coords = LANDMARKS[key];
                    map.setCenter(new naver.maps.LatLng(coords.lat, coords.lng));
                    map.setZoom(15);
                    $(this).blur(); return;
                }
            }
            const targetShop = allShops.find(shop => {
                if(!shop.name) return false;
                return shop.name.replace(/\s+/g, '').toLowerCase().includes(query);
            });
            if (targetShop && targetShop.lat && targetShop.lng) {
                map.morph(new naver.maps.LatLng(targetShop.lat, targetShop.lng), 17);
                $(this).blur(); return;
            }
            searchAddressToCoordinate(rawVal);
            $(this).blur();
        }
    });

    function searchAddressToCoordinate(query, isRetry = false) {
        naver.maps.Service.geocode({ query: query }, function(status, response) {
            if (status === naver.maps.Service.Status.OK) {
                if (response.v2 && response.v2.addresses.length > 0) {
                    const item = response.v2.addresses[0]; map.setCenter(new naver.maps.Point(item.x, item.y)); map.setZoom(16);
                } else if (response.result && response.result.items.length > 0) {
                    const item = response.result.items[0]; map.setCenter(new naver.maps.Point(item.point.x, item.point.y)); map.setZoom(16);
                } else {
                    if(!isRetry && query.indexOf('ëŒ€êµ¬') === -1) searchAddressToCoordinate("ëŒ€êµ¬ " + query, true);
                    else alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } else {
                if(!isRetry && query.indexOf('ëŒ€êµ¬') === -1) searchAddressToCoordinate("ëŒ€êµ¬ " + query, true);
                else alert("ê²€ìƒ‰ ì‹¤íŒ¨");
            }
        });
    }

    let idleTimer;
    naver.maps.Event.addListener(map, 'idle', function() { clearTimeout(idleTimer); idleTimer = setTimeout(updateVisibleMarkers, 150); });
    window.applyAllFilters = function() { updateVisibleMarkers(); };

    initTheme(); loadShopsData();

    window.moveToCurrentLocation = function() {
        map.refresh(); 
        if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        const btnText = document.querySelector('.loc-text');
        if(btnText) btnText.innerText = "íƒìƒ‰ì¤‘..";
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const loc = new naver.maps.LatLng(lat, lng);
            map.setCenter(loc); map.setZoom(16);
            setTimeout(() => { updateVisibleMarkers(); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; }, 300);
            if (window.myLocationMarker) window.myLocationMarker.setMap(null);
            window.myLocationMarker = new naver.maps.Marker({
                position: loc, map: map,
                icon: { content: '<div style="width:16px;height:16px;background:#3498db;border:2px solid white;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>', anchor: new naver.maps.Point(8, 8) }
            });
        }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); if(btnText) btnText.innerText = "ë‚´ ì£¼ë³€"; });
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js?v=2.7') 
            .then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) { window.location.reload(); }
                    };
                };
            }).catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ì‹¤íŒ¨', err));
    }

    let deferredPrompt; const installBtn = document.getElementById('installBtn'); const ua = navigator.userAgent.toLowerCase(); const isIos = /iphone|ipad|ipod/.test(ua); const isInApp = ua.includes('kakao') || ua.includes('instagram') || ua.includes('naver');
    if (isIos) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸ“² ì•„ì´í° ì„¤ì¹˜ ë°©ë²•\n\n1. ì‚¬íŒŒë¦¬(Safari) ë¸Œë¼ìš°ì € í•˜ë‹¨ 'ê³µìœ ' ë²„íŠ¼ í´ë¦­\n2. ë©”ë‰´ë¥¼ ë‚´ë ¤ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ\n3. ë°”íƒ•í™”ë©´ì— 'ëŒ€êµ¬í•«í”Œì—¬ê¸°' ì•± ìƒì„±!")); } 
    else if (isInApp) { installBtn.style.display = 'block'; installBtn.addEventListener('click', () => alert("ğŸš« í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë‹¤ìš´ë¡œë“œê°€ ì œí•œë©ë‹ˆë‹¤.\n\nìš°ì¸¡ í•˜ë‹¨(ë˜ëŠ” ìƒë‹¨)ì˜ [ë”ë³´ê¸° Â·Â·Â·] ë²„íŠ¼ì„ ëˆ„ë¥´ê³ \n[ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°]ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!")); }
    else { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; }); installBtn.addEventListener('click', (e) => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') installBtn.style.display = 'none'; deferredPrompt = null; }); } else alert("ì´ë¯¸ ì„¤ì¹˜ë¨"); }); }

    // ==========================================
    // ì¸ì¦ ì‹œìŠ¤í…œ
    // ==========================================
    window.googleLogin = function() {
        const ua = navigator.userAgent.toLowerCase();
        const isInApp = ua.includes('kakao') || ua.includes('instagram') || ua.includes('naver');
        if (isInApp) {
            alert("ğŸ”’ ë³´ì•ˆ ì •ì±…ìƒ ì¹´ì¹´ì˜¤í†¡/ì¸ìŠ¤íƒ€ê·¸ë¨ ë¸Œë¼ìš°ì €ì—ì„œëŠ” \nêµ¬ê¸€ ë¡œê·¸ì¸ì´ ì œí•œë©ë‹ˆë‹¤.\n\n[í•´ê²° ë°©ë²•]\nìš°ì¸¡ í•˜ë‹¨(ë˜ëŠ” ìƒë‹¨)ì˜ [ë”ë³´ê¸° Â·Â·Â·] ë²„íŠ¼ì„ ëˆ„ë¥´ê³ \n[ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°]ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸŒ");
            return;
        }
        signInWithPopup(auth, googleProvider).then((result) => { checkUserDB(result.user); }).catch((error) => { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message); });
    };

    window.googleLogout = function() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { signOut(auth).then(() => { alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }); }
    };

// 3. [ìˆ˜ì •ë¨] ë¡œê·¸ì¸ ê°ì§€ & í”„ë¡œí•„ íŒì—… ì—°ê²°
    onAuthStateChanged(auth, async (user) => {
        const btnLogin = document.getElementById('btnLogin');
        const myProfile = document.getElementById('myProfile');
        
        if (user) {
            btnLogin.style.display = 'none';
            myProfile.style.display = 'flex';
            
            // ğŸ”¥ [í•µì‹¬] ì´ë¦„í‘œë¥¼ í´ë¦­í•˜ë©´ 'í”„ë¡œí•„ íŒì—…'ì´ ì—´ë¦¬ë„ë¡ ì„¤ì •
            // (cursor:pointerë¡œ ëˆŒëŸ¬ë³´ê³  ì‹¶ê²Œ ë§Œë“¦)
            myProfile.style.cursor = "pointer";
            myProfile.onclick = function() { openProfileModal(); };

            document.getElementById('userName').innerText = user.displayName;
            
            // ë¯¸ë‹ˆ ë°°ì§€ ì—…ë°ì´íŠ¸
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if(userSnap.exists()) {
                const data = userSnap.data();
                const lv = calculateLevel(data.exp || 0);
                document.getElementById('userLevelBadge').innerText = `LV.${lv}`;
            }
        } else {
            btnLogin.style.display = 'flex';
            myProfile.style.display = 'none';
        }
    });

    // ==========================================
    // ğŸš€ [ì¶”ê°€ë¨] í”„ë¡œí•„ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
    // ==========================================
    // ğŸš€ [ìˆ˜ì •ë¨] í”„ë¡œí•„ íŒì—… ê´€ë ¨ í•¨ìˆ˜ (ê²½í—˜ì¹˜ ë°” ë¡œì§ ìˆ˜ì •)
    window.openProfileModal = async function() {
        const user = auth.currentUser;
        if(!user) return;

        // DBì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        
        if(userSnap.exists()) {
            const data = userSnap.data();
            const exp = data.exp || 0;
            const lv = calculateLevel(exp);
            
            // 1. ì´ë¦„ & ë ˆë²¨ í‘œì‹œ
            document.getElementById('pName').innerText = user.displayName;
            
            let title = "ë°°ê³ í”ˆ ì˜í˜¼";
            if(lv >= 4) title = "ë§›ì˜ ì§€ë°°ì";
            else if(lv >= 3) title = "ëŒ€êµ¬ì˜ ì•„ë“¤";
            else if(lv >= 2) title = "ì„œíˆ° ë¯¸ì‹ê°€";
            
            document.getElementById('pLevelBadge').innerText = `LV.${lv} ${title}`;
            
            // 2. [í•µì‹¬ ìˆ˜ì •] ë ˆë²¨ë³„ ê²½í—˜ì¹˜ ë°” ê³„ì‚°
            let nextGoal = 0;
            let prevGoal = 0; // ì´ì „ ë ˆë²¨ ê²½í—˜ì¹˜ (ë°”ë‹¥ì )

            if (lv === 1) { nextGoal = 50; prevGoal = 0; }        // 1->2 ê°€ë ¤ë©´ 50 í•„ìš”
            else if (lv === 2) { nextGoal = 100; prevGoal = 50; } // 2->3 ê°€ë ¤ë©´ 100 í•„ìš”
            else if (lv === 3) { nextGoal = 300; prevGoal = 100; } // 3->4 ê°€ë ¤ë©´ 300 í•„ìš”
            else { nextGoal = 300; prevGoal = 300; }             // ë§Œë ™

            let percent = 0;
            let text = "";

            if (lv < 4) {
                // í˜„ì¬ ë ˆë²¨ì—ì„œì˜ ì§„í–‰ë¥  ê³„ì‚°
                const currentLevelExp = exp - prevGoal; // ì´ ë ˆë²¨ì—ì„œ ìŒ“ì€ ê²½í—˜ì¹˜
                const levelRange = nextGoal - prevGoal; // ì´ ë ˆë²¨ì˜ ì´ êµ¬ê°„
                percent = (currentLevelExp / levelRange) * 100;
                text = `${exp} / ${nextGoal}`; // (í˜„ì¬ ì´ ê²½í—˜ì¹˜ / ë‹¤ìŒ ëª©í‘œ)
            } else {
                percent = 100;
                text = "MAX LEVEL";
            }
            
            document.getElementById('pExpText').innerText = text;
            document.getElementById('pExpBar').style.width = `${percent}%`;
            
            // 3. UID ì„¸íŒ…
            document.getElementById('pUid').value = user.uid;

            // íŒì—… ì—´ê¸°
            document.getElementById('profileModal').classList.add('show');
        }
    }

    window.closeProfileModal = function() {
        document.getElementById('profileModal').classList.remove('show');
    }

    window.copyUidInModal = function() {
        const uidInput = document.getElementById('pUid');
        uidInput.select();
        uidInput.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ëŒ€ì‘

        navigator.clipboard.writeText(uidInput.value).then(() => {
            alert("âœ… ì•„ì´ë””(UID)ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në³´ë¬¼ì§€ë„ ê´€ë¦¬ìì—ê²Œ ë³´ë‚´ì£¼ì„¸ìš”.");
        }).catch(() => {
            alert("ë³µì‚¬ ì‹¤íŒ¨ ã… ã…  ì§ì ‘ ê¸ì–´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
        });
    }

    async function checkUserDB(user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
            await setDoc(userRef, { name: user.displayName, email: user.email, photo: user.photoURL, exp: 0, level: 1, createdAt: new Date() });
            alert(`ë°˜ê°‘ìŠµë‹ˆë‹¤, ${user.displayName}ë‹˜! \nëŒ€êµ¬ ë³´ë¬¼ì§€ë„ ë ˆë²¨ 1ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤! ğŸš©`);
        } else { alert(`ì–´ì„œì˜¤ì„¸ìš”, ${user.displayName}ë‹˜!`); }
    }

    // 5. [ìˆ˜ì •ë¨] ë ˆë²¨ ê³„ì‚°ê¸° (ê¸°íšì— ë§ê²Œ ë‹¨ê³„ë³„ ì„¤ì •)
    function calculateLevel(exp) {
        if (exp < 50) return 1;       // 0 ~ 40ì  (0~4íšŒ ë°©ë¬¸)
        if (exp < 100) return 2;      // 50 ~ 90ì  (5~9íšŒ ë°©ë¬¸)
        if (exp < 300) return 3;      // 100 ~ 290ì  (10~29íšŒ ë°©ë¬¸)
        return 4;                     // 300ì  ì´ìƒ (30íšŒ ì´ìƒ - ë§Œë ™)
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat1)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c * 1000;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // ==========================================
    // ğŸš€ [ìµœì¢… ìˆ˜ì •] GPS + ì¿¨íƒ€ì„(1ì‹œê°„) ì¸ì¦ ì‹œìŠ¤í…œ
    // ==========================================
    window.verifyVisitByGPS = function(shopLat, shopLng, shopName) {
        const user = auth.currentUser;
        if(!user) return alert("ë¡œê·¸ì¸ í›„ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ˜…");

        const btn = event.target; 
        const originalText = btn.innerHTML;
        
        // 1. ì¿¨íƒ€ì„ ì²´í¬ (DB í™•ì¸)
        const userRef = doc(db, "users", user.uid);
        
        // DBì—ì„œ ìœ ì € ì •ë³´ë¥¼ ë¨¼ì € ê°€ì ¸ì˜´
        getDoc(userRef).then((docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const lastTime = data.lastCheckIn ? data.lastCheckIn.toMillis() : 0;
                const now = new Date().getTime();
                const diffMinutes = (now - lastTime) / (1000 * 60); // ë¶„ ë‹¨ìœ„ ì°¨ì´

                // ğŸ”¥ [í•µì‹¬] 60ë¶„ ì´ë‚´ë©´ ì¸ì¦ ë§‰ê¸°
                if (diffMinutes < 60) {
                    const waitTime = 60 - Math.floor(diffMinutes);
                    alert(`â›” ì•„ì§ ë°°ë¶€ë¥´ì§€ ì•Šìœ¼ì„¸ìš”?\n\në§›ì§‘ ì¸ì¦ì€ 1ì‹œê°„ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!\n(ë‚¨ì€ ì‹œê°„: ì•½ ${waitTime}ë¶„)`);
                    return; // í•¨ìˆ˜ ì¢…ë£Œ
                }
                
                // ì¿¨íƒ€ì„ ì§€ë‚¬ìœ¼ë©´ GPS í™•ì¸ ì‹œì‘
                startGPSCheck(userRef, shopLat, shopLng, shopName, btn, originalText);
            }
        });
    }

    function startGPSCheck(userRef, shopLat, shopLng, shopName, btn, originalText) {
        if (!navigator.geolocation) return alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ ì¼œì£¼ì„¸ìš”!");
        
        btn.innerHTML = "ğŸ“¡ ìœ„ì¹˜ í™•ì¸ ì¤‘..."; 
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const myLat = pos.coords.latitude; 
            const myLng = pos.coords.longitude;
            
            // ê±°ë¦¬ ê³„ì‚°
            const distance = getDistanceFromLatLonInKm(myLat, myLng, shopLat, shopLng);
            
            // ğŸ’¡ [ë²”ìœ„] 100m ì´ë‚´ (ì¡°ê¸ˆ ë” íƒ€ì´íŠ¸í•˜ê²Œ)
            if(distance < 100) {
                // ì„±ê³µ! (ê²½í—˜ì¹˜ +10 & ë§ˆì§€ë§‰ ì¸ì¦ ì‹œê°„ ê°±ì‹ )
                await updateDoc(userRef, { 
                    exp: increment(10),
                    lastCheckIn: new Date() // ğŸ”¥ í˜„ì¬ ì‹œê°„ì„ ê¸°ë¡ (ë‹¤ìŒ ì¿¨íƒ€ì„ ê¸°ì¤€)
                });
                
                alert(`ğŸ‰ ì¸ì¦ ì„±ê³µ!\n[${shopName}] ë°©ë¬¸ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nê²½í—˜ì¹˜ +10 íšë“! (ë§›ìˆê²Œ ë“œì„¸ìš”!)`);
                location.reload(); 
            } else {
                alert(`ğŸ˜¢ ë§¤ì¥ ê·¼ì²˜ê°€ ì•„ë‹™ë‹ˆë‹¤.\n(í˜„ì¬ ê±°ë¦¬: ì•½ ${Math.round(distance)}m)\n\në§¤ì¥ ì•ˆì— ë“¤ì–´ì˜¤ì…”ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!`);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }, (err) => {
            alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    }

    // ==========================================
    // ğŸ”¥ [ì¶”ê°€ë¨] ì¢‹ì•„ìš”(í•˜íŠ¸) ê¸°ëŠ¥ ë¡œì§
    // ==========================================
    window.toggleLike = async function(shopId) {
        const user = auth.currentUser;
        if(!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ğŸ˜…");

        const heartBtn = document.getElementById('heartBtn');
        const countSpan = document.getElementById('likeCountSpan');
        const shopRef = doc(db, "shops", shopId);
        
        // í˜„ì¬ ìƒíƒœ í™•ì¸ (í´ë˜ìŠ¤ë¡œ íŒë‹¨)
        const isLiked = heartBtn.innerText === "â¤ï¸";
        
        // 1. UI ì¦‰ì‹œ ë°˜ì˜ (Optimistic Update)
        if(isLiked) {
            heartBtn.innerText = "ğŸ¤";
            heartBtn.classList.remove('active');
            countSpan.innerText = parseInt(countSpan.innerText) - 1;
        } else {
            heartBtn.innerText = "â¤ï¸";
            heartBtn.classList.add('active');
            countSpan.innerText = parseInt(countSpan.innerText) + 1;
        }

        // 2. DB ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œ)
        try {
            if(isLiked) {
                // ì¢‹ì•„ìš” ì·¨ì†Œ: ë‚´ ID ì œê±°, ì¹´ìš´íŠ¸ -1
                await updateDoc(shopRef, {
                    likedBy: arrayRemove(user.uid)
                });
            } else {
                // ì¢‹ì•„ìš” ì¶”ê°€: ë‚´ ID ì¶”ê°€, ì¹´ìš´íŠ¸ +1
                await updateDoc(shopRef, {
                    likedBy: arrayUnion(user.uid)
                });
            }
            // ì „ì²´ ë°ì´í„° ìµœì‹ í™” (ë©”ëª¨ë¦¬ë§Œ)
            const target = allShops.find(s => s.id === shopId);
            if(target) {
                if(!target.likedBy) target.likedBy = [];
                if(isLiked) target.likedBy = target.likedBy.filter(uid => uid !== user.uid);
                else target.likedBy.push(user.uid);
            }

        } catch(e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            // ì‹¤íŒ¨ ì‹œ UI ì›ìƒë³µêµ¬
            heartBtn.innerText = isLiked ? "â¤ï¸" : "ğŸ¤";
        }
    }

    // ==========================================
    // ğŸ“Œ [ìˆ˜ì •ë¨] ìƒì„¸ íŒ¨ë„ ì—´ê¸° (í•˜íŠ¸ + GPS)
    // ==========================================
    window.showPanel = function(shop) {
        document.getElementById('panelTitle').innerText = shop.name;
        const score = shop.totalScore || "0.0";
        document.getElementById('panelTotal').innerHTML = `${score}<span class="total-max"> / 5.0</span>`;
        document.getElementById('panelMenu').innerText = shop.menu || "-";
        document.getElementById('panelAddr').innerText = shop.address || "-";
        const reviewHtml = shop.desc ? `ğŸ—¨ï¸ "${shop.desc}"` : `ğŸ—¨ï¸ "ì•„ì§ ë“±ë¡ëœ í•œì¤„í‰ì´ ì—†ì–´ìš”."`;
        document.getElementById('panelReview').innerHTML = reviewHtml;
        
        const metaBox = document.getElementById('panelMeta');
        let metaHtml = '';
        if(shop.category) (Array.isArray(shop.category) ? shop.category : [shop.category]).forEach(c => metaHtml += `<span class="panel-tag">#${c}</span>`);
        if(shop.purpose) (Array.isArray(shop.purpose) ? shop.purpose : [shop.purpose]).forEach(p => metaHtml += `<span class="panel-tag">#${p}</span>`);
        metaBox.innerHTML = metaHtml;

        const header = document.getElementById('panelHeader');
        if (shop.imageUrl) { header.style.backgroundImage = `url('${shop.imageUrl}')`; } 
        else { header.style.backgroundImage = 'none'; header.style.backgroundColor = '#ddd'; }
        
        let parkingBadge = '';
        if (shop.parking) { parkingBadge = `<div class="parking-badge">${shop.parking}</div>`; }
        
        // ğŸ”¥ [ì¶”ê°€ë¨] í•˜íŠ¸ ë²„íŠ¼ ìƒì„±
        const user = auth.currentUser;
        const likedList = shop.likedBy || [];
        const isLiked = user && likedList.includes(user.uid);
        const heartIcon = isLiked ? "â¤ï¸" : "ğŸ¤";
        const likeCount = likedList.length;

        const heartHtml = `
            <div class="like-btn-wrapper">
                <button id="heartBtn" class="heart-btn ${isLiked?'active':''}" onclick="toggleLike('${shop.id}')">${heartIcon}</button>
                <span id="likeCountSpan" class="like-count">${likeCount}</span>
            </div>
        `;

        // í—¤ë”ì— ë‹«ê¸° ë²„íŠ¼ + ì£¼ì°¨ ë±ƒì§€ + í•˜íŠ¸ ë²„íŠ¼ ë‹¤ ë„£ê¸°
        header.innerHTML = `<button class="panel-close" onclick="closePanel()">âœ•</button>${parkingBadge}${heartHtml}`;

        // GPS ë²„íŠ¼ & ë„¤ì´ë²„ ë§í¬
        const btnLink = document.getElementById('panelLink');
        if (shop.link) { btnLink.href = shop.link; btnLink.style.display = 'block'; btnLink.innerText = 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë³´ê¸°'; } 
        else { btnLink.href = '#'; btnLink.style.display = 'none'; }

        const existingGpsBtn = document.getElementById('gpsAuthBtn');
        if(existingGpsBtn) existingGpsBtn.remove();

        const gpsBtn = document.createElement('button');
        gpsBtn.id = 'gpsAuthBtn';
        gpsBtn.className = 'panel-btn';
        gpsBtn.style.background = '#e74c3c';
        gpsBtn.style.marginTop = '10px';
        gpsBtn.innerHTML = 'ğŸ“ <b>ì—¬ê¸° ì™”ì–´ìš”! (GPS ì¸ì¦)</b>';
        // ... (ìœ„ì—ëŠ” GPS ë²„íŠ¼ ë§Œë“œëŠ” ì½”ë“œ) ...
        
        gpsBtn.onclick = function() { verifyVisitByGPS(shop.lat, shop.lng, shop.name); };
        
        // panelBody.insertBefore(gpsBtn, btnLink);  <-- ì›ë˜ ìˆë˜ ì´ ì¤„ì€ ì§€ìš°ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì•„ë˜ ì½”ë“œë¡œ ëŒ€ì²´í•˜ì„¸ìš”.

        // ğŸ”¥ [ìˆ˜ì •] ìˆœì„œ ì •ë ¬: (ìœ„) ì‚¬ì¥ë‹˜ë²„íŠ¼ -> GPSë²„íŠ¼ -> ë„¤ì´ë²„ë²„íŠ¼ (ì•„ë˜)
        // 1. ë„¤ì´ë²„ ë²„íŠ¼ì€ ì´ë¯¸ appendChildë¡œ ë§¨ ë’¤ì— ë¶™ì–´ìˆìŒ.
        // 2. GPS ë²„íŠ¼ì„ ë„¤ì´ë²„ ë²„íŠ¼ ì•ì— ë¼ì›Œë„£ê¸°
        panelBody.insertBefore(gpsBtn, btnLink);

        // ğŸ”¥ [ì¶”ê°€ë¨] C. ì‚¬ì¥ë‹˜ ìˆ˜ì • ë²„íŠ¼ (ì£¼ì¸ì¼ ë•Œë§Œ ë³´ì„)
        if (user && shop.ownerId === user.uid) {
            const ownerBtn = document.createElement('button');
            ownerBtn.className = 'panel-btn dynamic-btn';
            ownerBtn.style.background = '#2c3e50'; // ì§„í•œ ë‚¨ìƒ‰
            ownerBtn.style.border = '2px solid #f1c40f'; // ë…¸ë€ í…Œë‘ë¦¬
            ownerBtn.innerHTML = 'âœï¸ <b>ì‚¬ì¥ë‹˜ ì •ë³´ ìˆ˜ì •</b>';
            ownerBtn.onclick = function() { editMyShop(shop); };
            
            // GPS ë²„íŠ¼ ë°”ë¡œ ìœ„ì— ë¼ì›Œë„£ê¸° (ì œì¼ ìƒë‹¨)
            panelBody.insertBefore(ownerBtn, gpsBtn);
        }

        document.getElementById('faqPanel').classList.remove('show');
        document.getElementById('selectModal').classList.remove('show');
        document.getElementById('infoPanel').classList.add('show');
    }
    </script>
</body>
</html>